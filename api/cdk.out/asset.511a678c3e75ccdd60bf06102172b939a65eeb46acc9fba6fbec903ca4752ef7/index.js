"use strict";var D=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var W=Object.prototype.hasOwnProperty;var F=(s,n)=>{for(var e in n)D(s,e,{get:n[e],enumerable:!0})},q=(s,n,e,m)=>{if(n&&typeof n=="object"||typeof n=="function")for(let o of M(n))!W.call(s,o)&&o!==e&&D(s,o,{get:()=>n[o],enumerable:!(m=B(n,o))||m.enumerable});return s};var K=s=>q(D({},"__esModule",{value:!0}),s);var j={};F(j,{handler:()=>$});module.exports=K(j);var O=require("@aws-sdk/client-dynamodb"),y=require("@aws-sdk/lib-dynamodb"),_=new O.DynamoDBClient({}),S=y.DynamoDBDocumentClient.from(_),T=process.env.TABLE_NAME,Y=process.env.STATUS_TIME_INDEX,u={"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type,Authorization"},$=async s=>{if(s.httpMethod==="OPTIONS")return{statusCode:200,headers:u,body:JSON.stringify({message:"CORS enabled"})};try{let n=s.path.toLowerCase();if(n.includes("/leaderboard")){if(n.includes("/context/")){let e=s.pathParameters?.userId;return e?await z(e):{statusCode:400,headers:u,body:JSON.stringify({message:"User ID is required"})}}return await L(s)}if(n.includes("/stats/")){let e=s.pathParameters?.userId;return e?await X(e):{statusCode:400,headers:u,body:JSON.stringify({message:"User ID is required"})}}if(n.includes("/bestgames/")){let e=s.pathParameters?.userId;if(!e)return{statusCode:400,headers:u,body:JSON.stringify({message:"User ID is required"})};let m=s.queryStringParameters?.limit?parseInt(s.queryStringParameters.limit):5;return await v(e,m)}if(n.includes("/games")){if(s.httpMethod==="GET")return await V(s);if(s.httpMethod==="POST")return await k(s)}return{statusCode:404,headers:u,body:JSON.stringify({message:"Endpoint not found"})}}catch(n){return console.error("Error:",n),{statusCode:500,headers:u,body:JSON.stringify({message:"Internal server error",error:n instanceof Error?n.message:String(n)})}}};async function k(s){if(!s.body)return{statusCode:400,headers:u,body:JSON.stringify({message:"Request body is required"})};let n=JSON.parse(s.body),{userId:e,status:m,time:o,successTime:I,winTime:b,userName:r,userImage:d,usedFlags:l,bombsExploded:E,noFlagWin:a,timePlayed:c,cellsRevealed:f,gameRestarts:g}=n;if(!e||!m)return{statusCode:400,headers:u,body:JSON.stringify({message:"userId and status are required"})};let t=new Date().toISOString(),p=Number(o||I||b||0),C=Math.floor(Date.now()/1e3)+90*24*60*60,N=`USER#${e}`,A=`DATE#${t}`,h={userId:N,timestamp:A,rawUserId:e,status:m,time:p,date:t,ttl:C,userName:r||e,userImage:d||null,usedFlags:l!==void 0?l:null,bombsExploded:E!==void 0?E:null,noFlagWin:a!==void 0?a:null,timePlayed:c!==void 0?c:null,cellsRevealed:f!==void 0?f:null,gameRestarts:g!==void 0?g:null};if(await S.send(new y.PutCommand({TableName:T,Item:h})),m==="success"&&p>0)try{let w="BEST",R=`BEST#${e}`,P=await S.send(new y.QueryCommand({TableName:T,KeyConditionExpression:"userId = :pk AND #ts = :sk",ExpressionAttributeValues:{":pk":w,":sk":R},ExpressionAttributeNames:{"#ts":"timestamp"}})),x=P.Items&&P.Items.length>0?P.Items[0]:null;if(!x||p<x.time){let G={userId:w,timestamp:R,rawUserId:e,time:p,date:t,ttl:Math.floor(Date.now()/1e3)+31536e3,userName:r||e,userImage:d||null,usedFlags:l!==void 0?l:null,noFlagWin:a!==void 0?a:null,timePlayed:c!==void 0?c:null,cellsRevealed:f!==void 0?f:null,gameRestarts:g!==void 0?g:null};await S.send(new y.PutCommand({TableName:T,Item:G}))}}catch(w){console.error("Error checking/updating best time:",w)}return{statusCode:200,headers:u,body:JSON.stringify({message:"Game result stored successfully",item:h})}}async function V(s){let n=s.queryStringParameters?.userId,e=s.queryStringParameters?.status,m=s.queryStringParameters?.limit?parseInt(s.queryStringParameters.limit):100;try{if(n){let r=`USER#${n}`,d={TableName:T,KeyConditionExpression:"userId = :userId AND begins_with(#ts, :datePrefix)",ExpressionAttributeValues:{":userId":r,":datePrefix":"DATE#"},ExpressionAttributeNames:{"#ts":"timestamp"},ScanIndexForward:!1,Limit:e==="success"?void 0:m};e&&(d.FilterExpression="#st = :status",d.ExpressionAttributeValues[":status"]=e,d.ExpressionAttributeNames["#st"]="status");let E=((await S.send(new y.QueryCommand(d))).Items||[]).map(a=>({...a,userId:a.rawUserId||(a.userId.startsWith("USER#")?a.userId.substring(5):a.userId),displayTimestamp:a.timestamp.startsWith("DATE#")?a.timestamp.substring(5):a.timestamp}));return e==="success"&&(E=E.sort((a,c)=>a.time-c.time).slice(0,m)),{statusCode:200,headers:u,body:JSON.stringify(E)}}let o={TableName:T,FilterExpression:"begins_with(#ts, :datePrefix)",ExpressionAttributeValues:{":datePrefix":"DATE#"},ExpressionAttributeNames:{"#ts":"timestamp"},Limit:m};e&&(o.FilterExpression+=" AND #st = :status",o.ExpressionAttributeValues[":status"]=e,o.ExpressionAttributeNames["#st"]="status");let b=((await S.send(new y.ScanCommand(o))).Items||[]).map(r=>({...r,userId:r.rawUserId||(r.userId.startsWith("USER#")?r.userId.substring(5):r.userId),displayTimestamp:r.timestamp.startsWith("DATE#")?r.timestamp.substring(5):r.timestamp}));return{statusCode:200,headers:u,body:JSON.stringify(b)}}catch(o){return console.error("Error fetching games:",o),{statusCode:500,headers:u,body:JSON.stringify({message:"Error fetching games",error:o instanceof Error?o.message:String(o)})}}}async function L(s){let n=s.queryStringParameters?.limit?parseInt(s.queryStringParameters.limit):10;try{let e={TableName:T,KeyConditionExpression:"userId = :best",ExpressionAttributeValues:{":best":"BEST"}},b=((await S.send(new y.QueryCommand(e))).Items||[]).sort((r,d)=>r.time-d.time).slice(0,n).map((r,d)=>{let l=r.rawUserId||(r.timestamp.startsWith("BEST#")?r.timestamp.substring(5):"");return{rank:d+1,userId:l,userName:r.userName||l,userImage:r.userImage||null,time:r.time,date:r.date}});return{statusCode:200,headers:u,body:JSON.stringify(b)}}catch(e){return console.error("Error fetching leaderboard:",e),{statusCode:500,headers:u,body:JSON.stringify({message:"Error fetching leaderboard",error:e instanceof Error?e.message:String(e)})}}}async function z(s){try{let e={TableName:T,KeyConditionExpression:"userId = :best",ExpressionAttributeValues:{":best":"BEST"}},b=((await S.send(new y.QueryCommand(e))).Items||[]).sort((a,c)=>a.time-c.time).map((a,c)=>{let f=a.rawUserId||(a.timestamp.startsWith("BEST#")?a.timestamp.substring(5):"");return{rank:c+1,userId:f,userName:a.userName||f,userImage:a.userImage||null,time:a.time,date:a.date}}),r=b.findIndex(a=>a.userId===s);if(r===-1)return{statusCode:200,headers:u,body:JSON.stringify([])};let d=Math.max(0,r-2),l=Math.min(b.length-1,r+2),E=b.slice(d,l+1);return{statusCode:200,headers:u,body:JSON.stringify(E)}}catch(e){return console.error("Error fetching user leaderboard context:",e),{statusCode:500,headers:u,body:JSON.stringify({message:"Error fetching user leaderboard context",error:e instanceof Error?e.message:String(e)})}}}async function X(s){let n=`USER#${s}`,e={TableName:T,KeyConditionExpression:"userId = :userId",ExpressionAttributeValues:{":userId":n}},o=(await S.send(new y.QueryCommand(e))).Items||[],I={TableName:T,KeyConditionExpression:"userId = :best AND #ts = :sk",ExpressionAttributeValues:{":best":"BEST",":sk":`BEST#${s}`},ExpressionAttributeNames:{"#ts":"timestamp"}},b=await S.send(new y.QueryCommand(I)),r=b.Items&&b.Items.length>0?b.Items[0]:null,d=0,l=0,E=0,a=r?r.time:Number.MAX_SAFE_INTEGER,c=0,f=0,g=r?.userName||s,t=r?.userImage||null,p=0,C=0,N=0,A=0,h=0,w=0,R=0,P=0,x=o.filter(i=>i.timestamp.startsWith("DATE#"));d=x.length,x.forEach(i=>{i.userName&&!g&&(g=i.userName),i.userImage&&!t&&(t=i.userImage),i.bombsExploded&&(p+=i.bombsExploded),i.status==="success"&&i.noFlagWin===!0&&C++,i.timePlayed&&typeof i.timePlayed=="number"&&(N+=i.timePlayed,A++),i.cellsRevealed&&typeof i.cellsRevealed=="number"&&(h+=i.cellsRevealed),i.gameRestarts&&typeof i.gameRestarts=="number"&&(w+=i.gameRestarts),i.status==="success"?(l++,f+=i.time||0,r||(a=Math.min(a,i.time||Number.MAX_SAFE_INTEGER))):i.status==="defeat"?E++:i.status==="abandoned"?R++:i.status==="restarted"&&P++}),c=l>0?Math.round(f/l):0;let G=A>0?Math.round(N/A):0;a===Number.MAX_SAFE_INTEGER&&(a=0);let U={userId:s,userName:g,userImage:t,totalGames:d,wins:l,losses:E,winRate:d>0?Math.round(l/d*100):0,fastestWin:a,averageWinTime:c,bombsExploded:p,noFlagWins:C,timePlayed:N,averageGameTime:G,totalCellsRevealed:h,gameRestarts:w,abandonedGames:R,restartedGames:P,recentGames:x.sort((i,J)=>J.timestamp.localeCompare(i.timestamp)).slice(0,5).map(i=>({...i,userId:i.rawUserId||s}))};return{statusCode:200,headers:u,body:JSON.stringify(U)}}async function v(s,n=5){try{let e=[],m={TableName:T,KeyConditionExpression:"userId = :best AND #ts = :sk",ExpressionAttributeValues:{":best":"BEST",":sk":`BEST#${s}`},ExpressionAttributeNames:{"#ts":"timestamp"}},o=await S.send(new y.QueryCommand(m)),I=o.Items&&o.Items.length>0?o.Items[0]:null;I&&I.time>0&&e.push({...I,userId:I.rawUserId||s,status:"success",date:I.date||new Date().toISOString()});let b=`USER#${s}`,r={TableName:T,KeyConditionExpression:"userId = :userId AND begins_with(#ts, :datePrefix)",ExpressionAttributeValues:{":userId":b,":datePrefix":"DATE#"},ExpressionAttributeNames:{"#ts":"timestamp"}},a=((await S.send(new y.QueryCommand(r))).Items||[]).map(t=>({...t,userId:t.rawUserId||(t.userId.startsWith("USER#")?t.userId.substring(5):t.userId),date:t.date||(t.timestamp.startsWith("DATE#")?t.timestamp.substring(5):t.timestamp),displayTimestamp:t.timestamp.startsWith("DATE#")?t.timestamp.substring(5):t.timestamp})).filter(t=>{let p=t.time&&t.time>0||t.successTime&&t.successTime>0||t.winTime&&t.winTime>0;return t.status==="success"&&p}).map(t=>({...t,time:t.time||t.successTime||t.winTime||0,date:t.date||new Date(t.displayTimestamp).toISOString()}));e.push(...a);let c=[],f=new Set;for(let t of e){let p=`${t.time}-${t.date}`;f.has(p)||(f.add(p),c.push(t))}let g=c.sort((t,p)=>t.time-p.time).slice(0,n);return console.log(`Found ${g.length} best games for user ${s}`),{statusCode:200,headers:u,body:JSON.stringify(g)}}catch(e){return console.error(`Error fetching best games for user ${s}:`,e),{statusCode:500,headers:u,body:JSON.stringify({message:"Error fetching best games",error:e instanceof Error?e.message:String(e)})}}}0&&(module.exports={handler});
