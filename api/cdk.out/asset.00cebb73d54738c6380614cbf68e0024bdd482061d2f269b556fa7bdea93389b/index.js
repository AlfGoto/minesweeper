"use strict";var rs=Object.defineProperty;var cp=Object.getOwnPropertyDescriptor;var dp=Object.getOwnPropertyNames;var lp=Object.prototype.hasOwnProperty;var Lo=t=>{throw TypeError(t)};var fp=(t,e,r)=>e in t?rs(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var hp=(t,e)=>{for(var r in e)rs(t,r,{get:e[r],enumerable:!0})},yp=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of dp(e))!lp.call(t,s)&&s!==r&&rs(t,s,{get:()=>e[s],enumerable:!(n=cp(e,s))||n.enumerable});return t};var bp=t=>yp(rs({},"__esModule",{value:!0}),t);var A=(t,e,r)=>fp(t,typeof e!="symbol"?e+"":e,r),Ks=(t,e,r)=>e.has(t)||Lo("Cannot "+r);var h=(t,e,r)=>(Ks(t,e,"read from private field"),r?r.call(t):e.get(t)),k=(t,e,r)=>e.has(t)?Lo("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),g=(t,e,r,n)=>(Ks(t,e,"write to private field"),n?n.call(t,r):e.set(t,r),r),T=(t,e,r)=>(Ks(t,e,"access private method"),r);var Bo=(t,e,r,n)=>({set _(s){g(t,e,s,r)},get _(){return h(t,e,n)}});var nc={};hp(nc,{handler:()=>Ju});module.exports=bp(nc);var d=class extends Error{constructor(e,{message:r,path:n,payload:s}){super(r),this.code=e,this.path=n,this.payload=s}};d.match=(t,e="")=>t instanceof d&&t.code.startsWith(e);var Se=t=>typeof t=="boolean";var U=t=>typeof t=="string";var Gs=new Set(["never","atLeastOnce","always"]),He=(t,e)=>{let{required:r,hidden:n,key:s,savedAs:o}=t;if(r!==void 0&&!Gs.has(r))throw new d("schema.invalidProp",{message:`Invalid prop type${e!==void 0?` at path '${e}'`:""}. Property: 'required'. Expected: ${[...Gs].join(", ")}. Received: ${String(r)}.`,path:e,payload:{propName:"required",expected:[...Gs].join(", "),received:r}});if(n!==void 0&&!Se(n))throw new d("schema.invalidProp",{message:`Invalid prop type${e!==void 0?` at path '${e}'`:""}. Property: 'hidden'. Expected: boolean. Received: ${String(n)}.`,path:e,payload:{propName:"hidden",received:n}});if(s!==void 0&&!Se(s))throw new d("schema.invalidProp",{message:`Invalid prop type${e!==void 0?` at path '${e}'`:""}. Property: 'key'. Expected: boolean. Received: ${String(s)}.`,path:e,payload:{propName:"key",received:s}});if(o!==void 0&&!U(o))throw new d("schema.invalidProp",{message:`Invalid prop type${e!==void 0?` at path '${e}'`:""}. Property: 'savedAs'. Expected: string. Received: ${String(o)}.`,path:e,payload:{propName:"savedAs",received:o}})};var st=class{constructor(e){this.type="any",this.props=e}get checked(){return Object.isFrozen(this.props)}check(e){this.checked||(He(this.props,e),Object.freeze(this.props))}};var re=(t,e,r)=>t?e:r;var w=(t,e)=>({...t,...e});var X=t=>Array.isArray(t);var En=t=>["keyDefault","putDefault","updateDefault","keyLink","putLink","updateLink"].some(e=>t.props[e]!==void 0);var ns=Symbol("$discriminators_"),jr=Symbol("$discriminators"),Rr=Symbol("$discriminations_");var gn=class{constructor(e,r){this.type="anyOf",this.elements=e,this.props=r}get checked(){return Object.isFrozen(this.props)}check(e){if(this.checked)return;if(He(this.props,e),!X(this.elements))throw new d("schema.anyOf.invalidElements",{message:`Invalid anyOf elements${e!==void 0?` at path '${e}'`:""}: AnyOf elements must be an array.`,path:e});if(this.elements.length===0)throw new d("schema.anyOf.missingElements",{message:`Invalid anyOf elements${e!==void 0?` at path '${e}'`:""}: AnyOf attributes must have at least one element.`,path:e});for(let n of this.elements){let{required:s,hidden:o,savedAs:i}=n.props;if(s!==void 0&&s!=="atLeastOnce"&&s!=="always")throw new d("schema.anyOf.optionalElements",{message:`Invalid anyOf elements${e!==void 0?` at path '${e}'`:""}: AnyOf elements must be required.`,path:e});if(o!==void 0&&o!==!1)throw new d("schema.anyOf.hiddenElements",{message:`Invalid anyOf elements${e!==void 0?` at path '${e}'`:""}: AnyOf elements cannot be hidden.`,path:e});if(i!==void 0)throw new d("schema.anyOf.savedAsElements",{message:`Invalid anyOf elements${e!==void 0?` at path '${e}'`:""}: AnyOf elements cannot be renamed (have savedAs prop).`,path:e});if(En(n))throw new d("schema.anyOf.defaultedElements",{message:`Invalid anyOf elements${e!==void 0?` at path '${e}'`:""}: AnyOf elements cannot have default or linked values.`,path:e})}let{discriminator:r}=this.props;if(r!==void 0&&!(r in this[jr]))throw new d("schema.anyOf.invalidDiscriminator",{message:`Invalid discriminator${e!==void 0?` at path '${e}'`:""}: All elements must be map or anyOf schemas and discriminator must be the key of a string enum schema.`,path:e,payload:{discriminator:r}});this.elements.forEach((n,s)=>{n.check(`${e??""}[${s}]`)}),Object.freeze(this.props),Object.freeze(this.elements)}get[jr](){var e;return this[ns]===void 0&&(this[ns]=(e=this.elements.map(wp).reduce(Ep,void 0))!==null&&e!==void 0?e:{}),this[ns]}match(e){if(this[Rr]===void 0){this[Rr]={};let{discriminator:r}=this.props;if(r===void 0)return;for(let n of this.elements)this[Rr]={...this[Rr],...Fo(n,r)}}return this[Rr][e]}},wp=t=>{var e;switch(t.type){case"anyOf":return t[jr];case"map":{let r={};for(let[n,s]of Object.entries(t.attributes))s.type==="string"&&s.props.enum!==void 0&&(s.props.required===void 0||s.props.required!=="never")&&s.props.transform===void 0&&(r[n]=(e=s.props.savedAs)!==null&&e!==void 0?e:n);return r}default:return{}}},Ep=(t,e)=>{if(t===void 0)return e;if(e===void 0)return t;let[r,n]=[t,e].sort((o,i)=>Object.keys(o).length>Object.keys(i).length?1:-1),s={};for(let[o,i]of Object.entries(r))o in n&&n[o]===i&&(s[o]=i);return s},Fo=(t,e)=>{var r;switch(t.type){case"anyOf":{let n={};for(let s of t.elements)n={...n,...Fo(s,e)};return n}case"map":{let n={},s=t.attributes[e];if(s?.type==="string")for(let o of(r=s.props.enum)!==null&&r!==void 0?r:[])n[o]=t;return n}default:return{}}};var Hs=t=>t;var ur=t=>typeof t=="function";var Mo=t=>ur(t);var Uo=t=>!Mo(t);var ss=t=>typeof t=="bigint";var os=t=>t instanceof Uint8Array;var zo=t=>t===null;var Je=t=>typeof t=="number"&&!Number.isNaN(t);var xt=(t,e)=>{switch(t.type){case"null":return zo(e);case"boolean":return Se(e);case"number":return Je(e)||!!(t.props.big&&ss(e));case"string":return U(e);case"binary":return os(e)}};var Pt=(t,e)=>{He(t.props,e);let{type:r,props:n}=t,{enum:s}=n;s?.forEach(o=>{if(!xt(t,o))throw new d("schema.primitive.invalidEnumValueType",{message:`Invalid enum value type${e!==void 0?` at path '${e}'`:""}. Expected: ${r}. Received: ${String(o)}.`,path:e,payload:{expectedType:r,enumValue:o}})});for(let o of[n.keyDefault,n.putDefault,n.updateDefault])if(o!==void 0&&Uo(o)){if(!xt(t,o))throw new d("schema.primitive.invalidDefaultValueType",{message:`Invalid default value type${e!==void 0?` at path '${e}'`:""}: Expected: ${r}. Received: ${String(o)}.`,path:e,payload:{expectedType:r,defaultValue:o}});if(s!==void 0&&!s.some(i=>i===o))throw new d("schema.primitive.invalidDefaultValueRange",{message:`Invalid default value${e!==void 0?` at path '${e}'`:""}: Expected one of: ${s.join(", ")}. Received: ${String(o)}.`,path:e,payload:{enumValues:s,defaultValue:o}})}};var $t=class{constructor(e){this.type="binary",this.props=e}get checked(){return Object.isFrozen(this.props)}check(e){this.checked||(Pt(this,e),Object.freeze(this.props))}};var Wt=t=>t;var qr=class{constructor(e){this.type="boolean",this.props=e}get checked(){return Object.isFrozen(this.props)}check(e){this.checked||(Pt(this,e),Object.freeze(this.props))}};var Lr=(t={})=>new Sn(t),Sn=class t extends qr{required(e="atLeastOnce"){return new t(w(this.props,{required:e}))}optional(){return this.required("never")}hidden(e=!0){return new t(w(this.props,{hidden:e}))}key(e=!0){return new t(w(this.props,{key:e,required:"always"}))}savedAs(e){return new t(w(this.props,{savedAs:e}))}enum(...e){return new t(w(this.props,{enum:Wt(e)}))}const(e){return re(this.props.key,new t(w(this.props,{enum:[e],keyDefault:e})),new t(w(this.props,{enum:[e],putDefault:e})))}transform(e){return new t(w(this.props,{transform:e}))}keyDefault(e){return new t(w(this.props,{keyDefault:e}))}putDefault(e){return new t(w(this.props,{putDefault:e}))}updateDefault(e){return new t(w(this.props,{updateDefault:e}))}default(e){return re(this.props.key,new t(w(this.props,{keyDefault:e})),new t(w(this.props,{putDefault:e})))}keyLink(e){return new t(w(this.props,{keyLink:e}))}putLink(e){return new t(w(this.props,{putLink:e}))}updateLink(e){return new t(w(this.props,{updateLink:e}))}link(e){return re(this.props.key,new t(w(this.props,{keyLink:e})),new t(w(this.props,{putLink:e})))}keyValidate(e){return new t(w(this.props,{keyValidator:e}))}putValidate(e){return new t(w(this.props,{putValidator:e}))}updateValidate(e){return new t(w(this.props,{updateValidator:e}))}validate(e){return re(this.props.key,new t(w(this.props,{keyValidator:e})),new t(w(this.props,{putValidator:e})))}clone(e={}){return new t(w(this.props,e))}build(e){return new e(this)}};var Qe=class{constructor(e){this.type="item",this.attributes=e,this.props={},this.savedAttributeNames=new Set,this.keyAttributeNames=new Set,this.requiredAttributeNames={always:new Set,atLeastOnce:new Set,never:new Set};for(let[r,n]of Object.entries(e)){let{key:s=!1,required:o="atLeastOnce",savedAs:i=r}=n.props;this.savedAttributeNames.add(i),s&&this.keyAttributeNames.add(r),this.requiredAttributeNames[o].add(r)}}get checked(){return Object.isFrozen(this.props)}check(e){if(this.checked)return;He(this.props,e);let r=new Set,n=new Set,s={always:new Set,atLeastOnce:new Set,never:new Set};for(let[o,i]of Object.entries(this.attributes)){let{savedAs:a=o,key:m,required:p="atLeastOnce"}=i.props;if(r.has(a))throw new d("schema.item.duplicateSavedAs",{message:`Invalid item attributes${e!==void 0?` at path '${e}'`:""}: More than two attributes are saved as '${a}'.`,path:e,payload:{savedAs:a}});r.add(a),m!==void 0&&m&&n.add(o),s[p].add(o)}for(let[o,i]of Object.entries(this.attributes))i.check([e,o].filter(Boolean).join("."));Object.freeze(this.props),Object.freeze(this.attributes),Object.freeze(this.savedAttributeNames),Object.freeze(this.keyAttributeNames),Object.freeze(this.requiredAttributeNames)}};var is=t=>t.clone({keyLink:void 0,putLink:void 0,updateLink:void 0});var Dt=t=>new On(Hs(t)),On=class t extends Qe{pick(...e){let r={};for(let n of e)n in this.attributes&&(r[n]=is(this.attributes[n]));return new t(r)}omit(...e){let r={},n=new Set(e);for(let s of Object.keys(this.attributes)){if(n.has(s))continue;let o=s;r[o]=is(this.attributes[o])}return new t(r)}and(e){let r=typeof e=="function"?e(this):e,n={...this.attributes};for(let[s,o]of Object.entries(r))n[s]=o;return new t(n)}build(e){return new e(this)}};var K=class{constructor(e){this.type="number",this.props=e}get checked(){return Object.isFrozen(this.props)}check(e){if(this.checked)return;Pt(this,e);let{big:r}=this.props;if(r!==void 0&&!Se(r))throw new d("schema.invalidProp",{message:`Invalid property type${e!==void 0?` at path '${e}'`:""}. Property: 'big'. Expected: boolean. Received: ${String(r)}.`,path:e,payload:{propName:"big",received:r}});Object.freeze(this.props)}};var G=(t={})=>new vn(t),vn=class t extends K{required(e="atLeastOnce"){return new t(w(this.props,{required:e}))}optional(){return this.required("never")}hidden(e=!0){return new t(w(this.props,{hidden:e}))}key(e=!0){return new t(w(this.props,{key:e,required:"always"}))}savedAs(e){return new t(w(this.props,{savedAs:e}))}enum(...e){return new t(w(this.props,{enum:Wt(e)}))}const(e){return re(this.props.key,new t(w(this.props,{enum:[e],keyDefault:e})),new t(w(this.props,{enum:[e],putDefault:e})))}transform(e){return new t(w(this.props,{transform:e}))}big(e=!0){return new t(w(this.props,{big:e}))}keyDefault(e){return new t(w(this.props,{keyDefault:e}))}putDefault(e){return new t(w(this.props,{putDefault:e}))}updateDefault(e){return new t(w(this.props,{updateDefault:e}))}default(e){return re(this.props.key,new t(w(this.props,{keyDefault:e})),new t(w(this.props,{putDefault:e})))}keyLink(e){return new t(w(this.props,{keyLink:e}))}putLink(e){return new t(w(this.props,{putLink:e}))}updateLink(e){return new t(w(this.props,{updateLink:e}))}link(e){return re(this.props.key,new t(w(this.props,{keyLink:e})),new t(w(this.props,{putLink:e})))}keyValidate(e){return new t(w(this.props,{keyValidator:e}))}putValidate(e){return new t(w(this.props,{putValidator:e}))}updateValidate(e){return new t(w(this.props,{updateValidator:e}))}validate(e){return re(this.props.key,new t(w(this.props,{keyValidator:e})),new t(w(this.props,{putValidator:e})))}clone(e={}){return new t(w(this.props,e))}build(e){return new e(this)}};var Ee=class{constructor(e){this.type="string",this.props=e}get checked(){return Object.isFrozen(this.props)}check(e){this.checked||(Pt(this,e),Object.freeze(this.props))}};var he=(t={})=>new An(t),An=class t extends Ee{required(e="atLeastOnce"){return new t(w(this.props,{required:e}))}optional(){return this.required("never")}hidden(e=!0){return new t(w(this.props,{hidden:e}))}key(e=!0){return new t(w(this.props,{key:e,required:"always"}))}savedAs(e){return new t(w(this.props,{savedAs:e}))}enum(...e){return new t(w(this.props,{enum:Wt(e)}))}const(e){return re(this.props.key,new t(w(this.props,{enum:[e],keyDefault:e})),new t(w(this.props,{enum:[e],putDefault:e})))}transform(e){return new t(w(this.props,{transform:e}))}keyDefault(e){return new t(w(this.props,{keyDefault:e}))}putDefault(e){return new t(w(this.props,{putDefault:e}))}updateDefault(e){return new t(w(this.props,{updateDefault:e}))}default(e){return re(this.props.key,new t(w(this.props,{keyDefault:e})),new t(w(this.props,{putDefault:e})))}keyLink(e){return new t(w(this.props,{keyLink:e}))}putLink(e){return new t(w(this.props,{putLink:e}))}updateLink(e){return new t(w(this.props,{updateLink:e}))}link(e){return re(this.props.key,new t(w(this.props,{keyLink:e})),new t(w(this.props,{putLink:e})))}keyValidate(e){return new t(w(this.props,{keyValidator:e}))}putValidate(e){return new t(w(this.props,{putValidator:e}))}updateValidate(e){return new t(w(this.props,{updateValidator:e}))}validate(e){return re(this.props.key,new t(w(this.props,{keyValidator:e})),new t(w(this.props,{putValidator:e})))}clone(e={}){return new t(w(this.props,e))}build(e){return new e(this)}};var ce=class{constructor(e){this.schema=e}};var W=t=>{if(typeof t!="object"||t===null)return t;if(t instanceof Date)return new Date(t.getTime());if(t instanceof Array)return t.map(W);if(t instanceof Set)return new Set([...t.values()].map(W));if(t instanceof Uint8Array)return Uint8Array.from(t);if(t instanceof Object)return Object.fromEntries([...Object.entries(t).map(([e,r])=>[e,W(r)]),...Object.getOwnPropertySymbols(t).map(e=>[e,W(t[e])])]);throw new Error("Unable to clone object")};var Br=t=>t instanceof Set;var S=t=>typeof t=="object"&&t!==null&&!X(t)&&!Br(t)&&!os(t);var $p=["[","]","."],P=t=>{let e="",r=!0;for(let n of t)U(n)&&($p.some(o=>n.includes(o))?e+=`['${n}']`:e+=`${r?"":"."}${n}`),Je(n)&&(e+=`[${n}]`),r=!1;return e};var Xo=(t,e)=>({isExtension:!1,unextendedInput:e}),Yo=(t,e)=>{var r,n;switch(e){case"put":return((r=t.props)===null||r===void 0?void 0:r.required)!=="never";case"key":case"update":return((n=t.props)===null||n===void 0?void 0:n.required)==="always"}},Dp=(t,e)=>{if(t.props.key)return t.props.keyValidator;switch(e){case"key":return t.props.keyValidator;case"put":return t.props.putValidator;case"update":return t.props.updateValidator}},Le=(t,e,r={})=>{let{mode:n="put",valuePath:s}=r,o=Dp(t,n);if(o!==void 0){let i=o(e,t);if(i!==!0){let a=s!==void 0?P(s):void 0;throw new d("parsing.customValidationFailed",{message:`Custom validation${a!==void 0?` for attribute '${a}'`:""} failed${U(i)?` with message: ${i}`:""}.`,path:a,payload:{received:e,validationResult:i}})}}};function*Zo(t,e,r={}){let{fill:n=!0,transform:s=!0}=r,o;if(n){let m=W(e);yield m,o=m,yield o}let i=o??W(e);if(i!==void 0&&Le(t,i,r),s)yield i;else return i;return t.props.transform!==void 0?t.props.transform.encode(i):i}function*_o(t,e,r={}){let{discriminator:n}=t.props,{fill:s=!0,transform:o=!0,valuePath:i}=r,a,m,p,c;if(n!==void 0&&S(e)&&n in e){let l=e[n],y=U(l)?t.match(l):void 0;y!==void 0&&(a=ge(y,e,r),s&&(m=a.next().value,p=a.next().value),c=a.next().value)}if(a===void 0)for(let l of t.elements)try{a=ge(l,e,r),s&&(m=a.next().value,p=a.next().value),c=a.next().value;break}catch{a=void 0,m=void 0,p=void 0,c=void 0;continue}if(s){let l=m??W(e);yield l,yield p??l}let u=c;if(a===void 0||u===void 0){let l=i!==void 0?P(i):void 0;throw new d("parsing.invalidAttributeInput",{message:`Attribute${l!==void 0?` '${l}'`:""} does not match any of the possible sub-types.`,path:l,payload:{received:e}})}if(u!==void 0&&Le(t,u,r),o)yield u;else return u;return a.next().value}function*ei(t,e,r={}){let{valuePath:n,...s}=r,{fill:o=!0,transform:i=!0}=s,a=[],m=X(e);if(m&&(a=e.map((u,f)=>ge(t.elements,u,{...s,valuePath:[...n??[],f],defined:!1}))),o)if(m){let f=yield a.map(y=>y.next().value);yield a.map(y=>y.next(f).value)}else{let u=W(e);yield u,yield u}if(!m){let{type:u}=t,f=n!==void 0?P(n):void 0;throw new d("parsing.invalidAttributeInput",{message:`Attribute${f!==void 0?` '${f}'`:""} should be a ${u}.`,path:f,payload:{received:e,expected:u}})}let p=a.map(u=>u.next().value);if(p!==void 0&&Le(t,p,r),i)yield p;else return p;return a.map(u=>u.next().value)}function*ti(t,e,r={}){let{valuePath:n,...s}=r,{mode:o="put",fill:i=!0,transform:a=!0}=s,m={},p=[],c=S(e);if(c){let l=new Set(Object.keys(e));Object.entries(t.attributes).filter(([,y])=>o!=="key"||y.props.key).forEach(([y,x])=>{m[y]=ge(x,e[y],{...s,valuePath:[...n??[],y],defined:!1}),l.delete(y)}),p=[...l.values()].map(y=>[y,W(e[y])])}if(i)if(c){let y=yield Object.fromEntries([...Object.entries(m).map(([b,O])=>[b,O.next().value]).filter(([,b])=>b!==void 0),...p]);yield Object.fromEntries([...Object.entries(m).map(([b,O])=>[b,O.next(y).value]).filter(([,b])=>b!==void 0),...p])}else{let l=W(e);yield l,yield l}if(!c){let{type:l}=t,y=n!==void 0?P(n):void 0;throw new d("parsing.invalidAttributeInput",{message:`Attribute${y!==void 0?` '${y}'`:""} should be a ${l}.`,path:y,payload:{received:e,expected:l}})}let u=Object.fromEntries(Object.entries(m).map(([l,y])=>[l,y.next().value]).filter(([,l])=>l!==void 0));if(u!==void 0&&Le(t,u,r),a)yield u;else return u;return Object.fromEntries(Object.entries(m).map(([l,y])=>{var x;return[(x=t.attributes[l].props.savedAs)!==null&&x!==void 0?x:l,y.next().value]}).filter(([,l])=>l!==void 0))}function*ri(t,e,r={}){let{fill:n=!0,transform:s=!0,valuePath:o}=r,i=e;if(n){let c=W(e);yield c,yield c}if(!xt(t,i)){let{type:c}=t,u=o!==void 0?P(o):void 0;throw new d("parsing.invalidAttributeInput",{message:`Attribute${u!==void 0?` '${u}'`:""} should be a ${c}.`,path:u,payload:{received:i,expected:c}})}let{props:a}=t;if(a.enum!==void 0&&!a.enum.includes(i)){let c=o!==void 0?P(o):void 0;throw new d("parsing.invalidAttributeInput",{message:`Attribute${c!==void 0?` '${c}'`:""} should be one of: ${a.enum.map(String).join(", ")}.`,path:c,payload:{received:i,expected:a.enum}})}let m=i;if(Le(t,m,r),s)yield m;else return m;return a.transform!==void 0?a.transform.encode(m):m}function*ni(t,e,r={}){let{valuePath:n,...s}=r,{fill:o=!0,transform:i=!0}=s,a=[],m=[],p=new Set(t.keys.props.enum),c=S(e);if(c)for(let[l,y]of Object.entries(e)){if(y===void 0){m.push([l,void 0]);continue}p.delete(l);let x=[...n??[],l];a.push([ge(t.keys,l,{...s,valuePath:x}),ge(t.elements,y,{...s,defined:!1,valuePath:x})])}if(!t.props.partial&&r.mode!=="update")for(let l of p){let y=[...n??[],l];a.push([ge(t.keys,l,{...s,valuePath:y}),ge(t.elements,void 0,{...s,defined:!1,valuePath:y})])}if(o)if(c){let y=yield Object.fromEntries([...a.map(([b,O])=>[b.next().value,O.next().value]).filter(([,b])=>b!==void 0),...m]);yield Object.fromEntries([...a.map(([b,O])=>[b.next().value,O.next(y).value]).filter(([,b])=>b!==void 0),...m])}else{let l=W(e);yield l,yield l}if(!c){let{type:l}=t,y=n!==void 0?P(n):void 0;throw new d("parsing.invalidAttributeInput",{message:`Attribute${y!==void 0?` '${y}'`:""} should be a ${l}.`,path:y,payload:{received:e,expected:l}})}let u=Object.fromEntries(a.map(([l,y])=>[l.next().value,y.next().value]).filter(([,l])=>l!==void 0));if(u!==void 0&&Le(t,u,r),i)yield u;else return u;return Object.fromEntries(a.map(([l,y])=>[l.next().value,y.next().value]).filter(([,l])=>l!==void 0))}function*si(t,e,r={}){let{valuePath:n,...s}=r,{fill:o=!0,transform:i=!0}=s,a=[],m=Br(e);if(m&&(a=[...e.values()].map((u,f)=>ge(t.elements,u,{...s,valuePath:[...n??[],f],defined:!1}))),o)if(m)yield new Set(a.map(l=>l.next().value)),yield new Set(a.map(l=>l.next().value));else{let u=W(e);yield u,yield u}if(!m){let{type:u}=t,f=n!==void 0?P(n):void 0;throw new d("parsing.invalidAttributeInput",{message:`Attribute${f!==void 0?` '${f}'`:""} should be a ${u}.`,path:f,payload:{received:e,expected:u}})}let p=new Set(a.map(u=>u.next().value));if(p!==void 0&&Le(t,p,r),i)yield p;else return p;return new Set(a.map(u=>u.next().value))}function*ge(t,e,r={}){let{mode:n="put",fill:s=!0,transform:o=!0,defined:i=!1,parseExtension:a=Xo,valuePath:m}=r,p=e,c=s;if(c&&p===void 0){let x,b=Cp(t,n);x=ur(b)?b():W(b);let O=yield x,v=x;if(v===void 0&&O!==void 0){let D=Tp(t,n);v=ur(D)?D(O):v}yield v,p=v,c=!1}let u={...r,fill:c},{isExtension:f,extensionParser:l,unextendedInput:y}=a(t,p,{transform:o,valuePath:m});if(f){if(c){let x=p;yield x,yield x}return yield*l()}if(y===void 0){let x=m!==void 0?P(m):void 0;if(Yo(t,n)||i)throw new d("parsing.attributeRequired",{message:`Attribute${x!==void 0?` '${x}'`:""} is required.`,path:x});let b=y;if(o)yield b;else return b;return b}switch(t.type){case"any":return yield*Zo(t,y,u);case"null":case"boolean":case"number":case"string":case"binary":return yield*ri(t,y,u);case"set":return yield*si(t,y,u);case"list":return yield*ei(t,y,u);case"map":return yield*ti(t,y,u);case"record":return yield*ni(t,y,u);case"anyOf":return yield*_o(t,y,u)}}var Cp=(t,e)=>{let{props:r}=t;if(r.key)return r.keyDefault;switch(e){case"key":return r.keyDefault;case"put":return r.putDefault;case"update":return r.updateDefault}},Tp=(t,e)=>{let{props:r}=t;if(r.key)return r.keyLink;switch(e){case"key":return r.keyLink;case"put":return r.putLink;case"update":return r.updateLink}};function*oi(t,e,r={}){let{mode:n="put",fill:s=!0,transform:o=!0}=r,i={},a=[],m=S(e);if(m){let u=new Set(Object.keys(e));Object.entries(t.attributes).filter(([,f])=>n!=="key"||f.props.key).forEach(([f,l])=>{i[f]=ge(l,e[f],{...r,valuePath:[f],defined:!1}),u.delete(f)}),a=[...u.values()].map(f=>[f,W(e[f])])}if(s)if(m){let u=Object.fromEntries([...Object.entries(i).map(([l,y])=>[l,y.next().value]).filter(([,l])=>l!==void 0),...a]);yield u,yield Object.fromEntries([...Object.entries(i).map(([l,y])=>[l,y.next(u).value]).filter(([,l])=>l!==void 0),...a])}else{let u=W(e);yield u,yield u}if(!m)throw new d("parsing.invalidItem",{message:"Items should be objects",payload:{received:e,expected:"object"}});let p=Object.fromEntries(Object.entries(i).map(([u,f])=>[u,f.next().value]).filter(([,u])=>u!==void 0));if(o)yield p;else return p;return Object.fromEntries(Object.entries(i).map(([u,f])=>{var l;return[(l=t.attributes[u].props.savedAs)!==null&&l!==void 0?l:u,f.next().value]}).filter(([,u])=>u!==void 0))}var E=class extends ce{start(e,r={}){return this.schema.type==="item"?oi(this.schema,e,r):ge(this.schema,e,r)}parse(e,r={}){let n=this.start(e,r),s=!1,o;do{let i=n.next();s=!!i.done,o=i.value}while(!s);return o}reparse(e,r={}){return this.parse(e,r)}validate(e,r={}){try{this.parse(e,{...r,fill:!1,transform:!1})}catch(n){if(n instanceof d&&d.match(n,"parsing."))return!1;throw n}return!0}};E.actionName="parse";function*ii(t,e,r={}){let{format:n=!0,transform:s=!0}=r,o;if(s){let a=t.props.transform;if(o=a!==void 0?a.decode(e):W(e),n)yield o;else return o}return o??W(e)}function*ai(t,e,r={}){let{discriminator:n}=t.props,{format:s=!0,transform:o=!0,valuePath:i}=r,a,m,p,c=n&&o?t[jr][n]:n;if(c!==void 0&&S(e)&&c in e){let l=e[c],y=U(l)?t.match(l):void 0;y!==void 0&&(a=De(y,e,r),o&&(m=a.next().value),s&&(p=a.next().value))}if(a===void 0)for(let l of t.elements)try{a=De(l,e,r),o&&(m=a.next().value),s&&(p=a.next().value);break}catch{continue}let u=m,f=p;if(o&&u===void 0||s&&f===void 0){let l=i!==void 0?P(i):void 0;throw new d("formatter.invalidAttribute",{message:`Invalid attribute detected while formatting. Attribute does not match any of the possible sub-types${l!==void 0?`: '${l}'`:""}.`,path:l,payload:{received:e}})}if(o)if(s)yield u;else return u;return f}var cr=t=>t.replace(/\\/g,"\\\\").replace(/[-[\]/{}()*+?.^$|]/g,"\\$&"),Ct=(t,e)=>{if(e===void 0)return{isProjected:!0};let r=[];for(let n of e){let s=n.match(t);if(s!==null){let o=s[0];r.push(n.slice(o.length))}}return r.length===0?{isProjected:!1}:r.some(n=>n==="")?{isProjected:!0}:{isProjected:!0,childrenAttributes:r}};function*mi(t,e,{attributes:r,valuePath:n,...s}={}){let{format:o=!0,transform:i=!0}=s;if(!X(e)){let{type:c}=t,u=n!==void 0?P(n):void 0;throw new d("formatter.invalidAttribute",{message:`Invalid attribute detected while formatting${u!==void 0?`: '${u}'`:""}. Should be a ${c}.`,path:u,payload:{received:e,expected:c}})}let{childrenAttributes:a}=Ct(/\[\d+\]/,r),m=e.map((c,u)=>De(t.elements,c,{attributes:a,valuePath:[...n??[],u],...s}));if(i){let c=m.map(u=>u.next().value);if(o)yield c;else return c}return m.map(c=>c.next().value)}function*pi(t,e,{attributes:r,valuePath:n,...s}={}){let{format:o=!0,transform:i=!0}=s;if(!S(e)){let{type:p}=t,c=n!==void 0?P(n):void 0;throw new d("formatter.invalidAttribute",{message:`Invalid attribute detected while formatting${c!==void 0?`: '${c}'`:""}. Should be a ${p}.`,path:c,payload:{received:e,expected:p}})}let a={};for(let[p,c]of Object.entries(t.attributes)){let{props:u}=c,{savedAs:f}=u,l=cr(p),{isProjected:y,childrenAttributes:x}=Ct(new RegExp(`^\\.${l}|^\\['${l}']`),r);if(!y)continue;let b=i?f??p:p;a[p]=De(c,e[b],{attributes:x,valuePath:[...n??[],b],...s})}if(i){let p=Object.fromEntries(Object.entries(a).map(([c,u])=>[c,u.next().value]).filter(([,c])=>c!==void 0));if(o)yield p;else return p}return Object.fromEntries(Object.entries(a).map(([p,c])=>[p,c.next().value]).filter(([p,c])=>{var u;return((u=t.attributes[p])===null||u===void 0?void 0:u.props.hidden)!==!0&&c!==void 0}))}function*ui(t,e,{format:r=!0,transform:n=!0,valuePath:s}={}){let{props:o}=t;if(!xt(t,e)){let{type:m}=t,p=s!==void 0?P(s):void 0;throw new d("formatter.invalidAttribute",{message:`Invalid attribute detected while formatting${p!==void 0?`: '${p}'`:""}. Should be a ${m}.`,path:p,payload:{received:e,expected:m}})}let i;if(n){let m=o.transform;i=m!==void 0?m.decode(e):e}else i=e;if(o.enum!==void 0&&!o.enum.includes(i)){let m=s!==void 0?P(s):void 0;throw new d("formatter.invalidAttribute",{message:`Invalid attribute detected while formatting${m!==void 0?`: '${m}'`:""}. Should be one of: ${o.enum.map(String).join(", ")}.`,path:m,payload:{received:i,expected:o.enum}})}if(n)if(r)yield i;else return i;return i}function*ci(t,e,{attributes:r,valuePath:n,...s}={}){let{format:o=!0,transform:i=!0,partial:a=!1}=s;if(!S(e)){let{type:u}=t,f=n!==void 0?P(n):void 0;throw new d("formatter.invalidAttribute",{message:`Invalid attribute detected while formatting${f!==void 0?`: '${f}'`:""}. Should be a ${u}.`,path:f,payload:{received:e,expected:u}})}let m=[],p=new Set(t.keys.props.enum);for(let[u,f]of Object.entries(e)){if(f===void 0)continue;let l=[...n??[],u],y=new Tt(t.keys).format(u,{transform:i,valuePath:l});p.delete(y);let x=cr(y),{isProjected:b,childrenAttributes:O}=Ct(new RegExp(`^\\.${x}|^\\['${x}']`),r);b&&m.push([y,De(t.elements,f,{attributes:O,valuePath:l,...s})])}if(!t.props.partial&&!a)for(let u of p){let f=cr(u),{isProjected:l,childrenAttributes:y}=Ct(new RegExp(`^\\.${f}|^\\['${f}']`),r);if(!l)continue;let x=i&&t.keys.props.transform!==void 0?[...n??[],t.keys.props.transform.encode(u)]:[...n??[],u];m.push([u,De(t.elements,void 0,{attributes:y,valuePath:x,...s})])}if(i){let u=Object.fromEntries(m.map(([f,l])=>[f,l.next().value]).filter(([,f])=>f!==void 0));if(o)yield u;else return u}return Object.fromEntries(m.map(([u,f])=>[u,f.next().value]).filter(([,u])=>u!==void 0))}function*di(t,e,{valuePath:r,...n}={}){let{format:s=!0,transform:o=!0}=n;if(!Br(e)){let{type:m}=t,p=r!==void 0?P(r):void 0;throw new d("formatter.invalidAttribute",{message:`Invalid attribute detected while formatting${p!==void 0?`: '${p}'`:""}. Should be a ${m}.`,path:p,payload:{received:e,expected:m}})}let i=[...e.values()].map((m,p)=>De(t.elements,m,{...n,valuePath:[...r??[],p],attributes:void 0}));if(o){let m=new Set(i.map(p=>p.next().value).filter(p=>p!==void 0));if(s)yield m;else return m}return new Set(i.map(m=>m.next().value).filter(m=>m!==void 0))}var Np=new Set(["always","atLeastOnce"]),Ip=({props:t})=>{var e;return Np.has((e=t.required)!==null&&e!==void 0?e:"atLeastOnce")};function*De(t,e,r={}){let{format:n=!0,transform:s=!0,valuePath:o}=r;if(e===void 0){if(Ip(t)&&r.partial!==!0){let i=o!==void 0?P(o):void 0;throw new d("formatter.missingAttribute",{message:`Missing required attribute for formatting${i!==void 0?`: '${i}'`:""}.`,path:i,payload:{}})}if(s)if(n)yield void 0;else return;return}switch(t.type){case"any":return yield*ii(t,e,r);case"null":case"boolean":case"number":case"string":case"binary":return yield*ui(t,e,{...r,attributes:void 0});case"set":return yield*di(t,e,{...r,attributes:void 0});case"list":return yield*mi(t,e,r);case"map":return yield*pi(t,e,r);case"record":return yield*ci(t,e,r);case"anyOf":return yield*ai(t,e,r)}}function*li(t,e,{attributes:r,...n}={}){let{format:s=!0,transform:o=!0}=n;if(!S(e))throw new d("formatter.invalidItem",{message:"Invalid item detected while formatting. Should be an object.",payload:{received:e,expected:"Object"}});let i={};for(let[m,p]of Object.entries(t.attributes)){let{savedAs:c}=p.props,u=cr(m),{isProjected:f,childrenAttributes:l}=Ct(new RegExp(`^${u}|^\\['${u}']`),r);if(!f)continue;let y=o?c??m:m;i[m]=De(p,e[y],{attributes:l,valuePath:[y],...n})}if(o){let m=Object.fromEntries(Object.entries(i).map(([p,c])=>[p,c.next().value]).filter(([,p])=>p!==void 0));if(s)yield m;else return m}return Object.fromEntries(Object.entries(i).map(([m,p])=>[m,p.next().value]).filter(([m,p])=>{var c;return((c=t.attributes[m])===null||c===void 0?void 0:c.props.hidden)!==!0&&p!==void 0}))}var Tt=class extends ce{start(e,r={}){return this.schema.type==="item"?li(this.schema,e,r):De(this.schema,e,r)}format(e,r={}){let n=this.start(e,r),s=!1,o;do{let i=n.next();s=!!i.done,o=i.value}while(!s);return o}validate(e){try{this.format(e,{format:!1})}catch(r){if(r instanceof d&&d.match(r,"formatter."))return!1;throw r}return!0}};Tt.actionName="format";var fi=(...t)=>{let e=t.map(n=>n.source).join("|"),r=new Set(t.flatMap(n=>[...n.flags]));return new RegExp(e,[...r].join(""))};var Vp=/\[(\d+)\]/g,jp=/\['(.+?)'\]/g,Rp=/[\w#@-]+(?=(\.|\[|$))/g,qp=fi(Vp,jp,Rp),as=t=>{var e;if(t==="")return[];let r=[],n;for(let s of t.matchAll(qp)){let[o,i,a,m]=s;n=m;let p=(e=a??i)!==null&&e!==void 0?e:o;switch(a!==void 0?"escapedStr":i!==void 0?"listIndex":"regularStr"){case"listIndex":r.push(parseInt(p));break;default:r.push(p)}}if(r.length===0||n!==void 0&&n.length>0)throw new d("actions.invalidExpressionAttributePath",{message:`Unable to match expression attribute path with schema: ${t}`,payload:{attributePath:t}});return r};var ze=class t{static fromArray(e){return new t(P(e),e)}constructor(e="",r=as(e)){this.arrayPath=r,this.strPath=P(this.arrayPath)}prepend(...e){return this.prependPath(t.fromArray(e))}prependPath(e){return new t([e.strPath,this.strPath].filter(Boolean).join(this.strPath[0]!=="["?".":""),e.arrayPath.concat(this.arrayPath))}append(...e){return this.appendPath(t.fromArray(e))}appendPath(e){return new t([this.strPath,e.strPath].filter(Boolean).join(e.strPath[0]!=="["?".":""),this.arrayPath.concat(e.arrayPath))}};var hi=t=>{let e="",r={},n={},s=1;return t.forEach((o,i)=>{i>0&&(e+=", "),new ze(o).arrayPath.forEach((a,m)=>{if(Je(a)){e+=`[${a}]`;return}let p=n[a];p===void 0&&(p=`#p_${s}`,n[a]=p,r[p]=a,s++),m>0&&(e+="."),e+=p})}),{ProjectionExpression:e,ExpressionAttributeNames:r}};var Ke=t=>Je(t)&&Number.isInteger(t);var wt=class extends ce{constructor({schema:e,formattedPath:r,transformedPath:n}){super(e),this.formattedPath=r,this.transformedPath=n}};var z=class extends ce{search(e){return kn(this.schema,as(e))}};z.actionName="finder";var kn=(t,e)=>{var r;let[n,...s]=e;if(n===void 0)return[new wt({schema:t,formattedPath:new ze,transformedPath:new ze})];switch(t.type){case"any":return[new wt({schema:new st({}),formattedPath:ze.fromArray(e),transformedPath:ze.fromArray(e)})];case"null":case"boolean":case"number":case"string":case"binary":case"set":return[];case"record":{let o=t.keys,i;try{i=new E(o).parse(n)}catch{return[]}return kn(t.elements,s).map(({schema:a,formattedPath:m,transformedPath:p})=>new wt({schema:a,formattedPath:m.prepend(n),transformedPath:p.prepend(i)}))}case"item":case"map":{let o=t.attributes[n];if(!o)return[];let i=(r=o.props.savedAs)!==null&&r!==void 0?r:n;return kn(o,s).map(({schema:a,formattedPath:m,transformedPath:p})=>new wt({schema:a,formattedPath:m.prepend(n),transformedPath:p.prepend(i)}))}case"list":return Ke(n)?kn(t.elements,s).map(({schema:o,formattedPath:i,transformedPath:a})=>new wt({schema:o,formattedPath:i.prepend(n),transformedPath:a.prepend(n)})):[];case"anyOf":return t.elements.map(o=>kn(o,e)).flat()}};var L=class{constructor({serializer:e=JSON.stringify}={}){this.values=[],this.serializedValues=new Set,this.serializer=e}push(e){let r=this.serializer(e),n=this.serializedValues.has(r);return n||(this.values.push(e),this.serializedValues.add(r)),n}};var yi=(t,e,{strict:r=!0}={})=>{let n=new L({serializer:o=>o}),s=new z(t);for(let o of e){let i=s.search(o);if(i.length===0&&r)throw new d("actions.invalidExpressionAttributePath",{message:`Unable to match expression attribute path with schema: ${o}`,payload:{attributePath:o}});for(let a of i)n.push(a.transformedPath.strPath)}return n.values};var Ht=class t extends ce{static express(e){return hi(e)}transform(e,r){return yi(this.schema,e,r)}parse(e,r){return t.express(this.transform(e,r))}};Ht.actionName="parsePath";var me=(t,e="",r,n=!1)=>{let s="";return new ze(t).arrayPath.forEach((o,i)=>{if(Je(o)){s+=`[${o}]`;return}let a=r.tokens[o];a===void 0&&(a=`#c${e}_${r.namesCursor}`,r.tokens[o]=a,r.ExpressionAttributeNames[a]=o,r.namesCursor++),i>0&&(s+="."),s+=a}),n&&(s=["size(",s,")"].join("")),s},to=(t,e="",r)=>{let n=`:c${e}_${r.valuesCursor}`;return r.ExpressionAttributeValues[n]=t,r.valuesCursor++,n},Lp=t=>S(t),Oe=(t,e="",r)=>Lp(t)?me(t.attr,e,r):to(t,e,r);var bi=(t,e="",r)=>{let n="",{attr:s,beginsWith:o}=t;return n+="begins_with(",n+=me(s,e,r),n+=", ",n+=Oe(o,e,r),n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var xi=(t,e="",r)=>{let n="",{between:s}=t,[o,i]=s,a="size"in t,m=a?t.size:t.attr;return n+=me(m,e,r,a),n+=" BETWEEN ",n+=Oe(o,e,r),n+=" AND ",n+=Oe(i,e,r),{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var wi=(t,e="",r)=>{let n="",{attr:s,contains:o}=t;return n+="contains(",n+=me(s,e,r),n+=", ",n+=Oe(o,e,r),n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var Ei=(t,e="",r)=>{let n="",{eq:s}=t,o="size"in t,i=o?t.size:t.attr;return n+=me(i,e,r,o),n+=" = ",n+=Oe(s,e,r),{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}},gi=(t,e="",r)=>{let n="",{ne:s}=t,o="size"in t,i=o?t.size:t.attr;return n+=me(i,e,r,o),n+=" <> ",n+=Oe(s,e,r),{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var Si=(t,e="",r)=>{let n="",{attr:s,exists:o}=t;return n+=o?"attribute_exists(":"attribute_not_exists(",n+=me(s,e,r),n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var Oi=(t,e="",r)=>{let n="",{in:s}=t,o="size"in t,i=o?t.size:t.attr;return n+=me(i,e,r,o),n+=" IN (",n+=s.map(a=>Oe(a,e,r)).join(", "),n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var vi=(t,e="",r)=>{let n="",{or:s}=t,[o,...i]=s;return i.length===0?Xe(o,e,r):(n+="(",n+=s.map(a=>Xe(a,e,r).ConditionExpression).join(") OR ("),n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues})},Ai=(t,e="",r)=>{let n="",{and:s}=t,[o,...i]=s;return i.length===0?Xe(o,e,r):(n+="(",n+=s.map(a=>Xe(a,e,r).ConditionExpression).join(") AND ("),n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues})},ki=(t,e="",r)=>{let n="",{not:s}=t;return n+="NOT (",n+=Xe(s,e,r).ConditionExpression,n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var Pi=(t,e="",r)=>{let n="",{gte:s}=t,o="size"in t,i=o?t.size:t.attr;return n+=me(i,e,r,o),n+=" >= ",n+=Oe(s,e,r),{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}},$i=(t,e="",r)=>{let n="",{gt:s}=t,o="size"in t,i=o?t.size:t.attr;return n+=me(i,e,r,o),n+=" > ",n+=Oe(s,e,r),{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}},Di=(t,e="",r)=>{let n="",{lte:s}=t,o="size"in t,i=o?t.size:t.attr;return n+=me(i,e,r,o),n+=" <= ",n+=Oe(s,e,r),{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}},Ci=(t,e="",r)=>{let n="",{lt:s}=t,o="size"in t,i=o?t.size:t.attr;return n+=me(i,e,r,o),n+=" < ",n+=Oe(s,e,r),{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var Ti=(t,e="",r)=>{let n="",{attr:s,type:o}=t;return n+="attribute_type(",n+=me(s,e,r),n+=", ",n+=to(o,e,r),n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var Xe=(t,e="",r={namesCursor:1,valuesCursor:1,tokens:{},ExpressionAttributeNames:{},ExpressionAttributeValues:{}})=>{if("or"in t)return vi(t,e,r);if("and"in t)return Ai(t,e,r);if("not"in t)return ki(t,e,r);if("eq"in t)return Ei(t,e,r);if("ne"in t)return gi(t,e,r);if("gte"in t)return Pi(t,e,r);if("gt"in t)return $i(t,e,r);if("lte"in t)return Di(t,e,r);if("lt"in t)return Ci(t,e,r);if("between"in t)return xi(t,e,r);if("beginsWith"in t)return bi(t,e,r);if("in"in t)return Oi(t,e,r);if("contains"in t)return wi(t,e,r);if("exists"in t)return Si(t,e,r);if("type"in t)return Ti(t,e,r);throw new d("actions.invalidCondition",{message:"Invalid condition: Unable to detect valid condition type."})};var ve=(t,e,r)=>S(e)&&"attr"in e&&U(e.attr)&&r!==!0?t.search(e.attr):void 0,de=(t,e)=>{let[r,...n]=t.values;if(r===void 0)throw new d("actions.invalidExpressionAttributePath",{message:`Unable to match expression attribute path with schema: ${e}`,payload:{attributePath:e}});return n.length>0?{or:[r,...n]}:r};var Ni=(t,e)=>{let r=new L,n=new z(t),{beginsWith:s,transform:o}=e,i=e.attr,a=n.search(i),m=ve(n,s,o);for(let p of a){let c=p.transformedPath.strPath;if(m!==void 0)for(let u of m){let f={attr:u.transformedPath.strPath};r.push({attr:c,beginsWith:f})}else{let u=p.schema,f=new E(u);try{let l=f.parse(s,{fill:!1,transform:o});r.push({attr:c,beginsWith:l})}catch{}}}return de(r,i)};var Ii=(t,e)=>{let r=new L,n=new z(t),{between:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i),[p,c]=s,u=ve(n,p,a),f=ve(n,c,a);for(let l of m){let y=l.transformedPath.strPath,x=o?new K({}):l.schema,b=new E(x),O=new L;if(u!==void 0)for(let v of u){let D={attr:v.transformedPath.strPath};if(f!==void 0)for(let V of f){let J={attr:V.transformedPath.strPath};O.push([D,J])}else try{let V=b.parse(c,{fill:!1,transform:a});O.push([D,V])}catch{}}else{let v;try{v=b.parse(p,{fill:!1,transform:a})}catch{continue}if(f!==void 0)for(let D of f){let V={attr:D.transformedPath.strPath};O.push([v,V])}else try{let D=b.parse(c,{fill:!1,transform:a});O.push([v,D])}catch{}}if(O.values.length!==0)for(let v of O.values)r.push(o?{size:y,between:v}:{attr:y,between:v})}return de(r,i)};var Vi=(t,e)=>{let r=new L,n=new z(t),{contains:s,transform:o}=e,i=e.attr,a=n.search(i),m=ve(n,s,o);for(let p of a){let c=p.transformedPath.strPath;if(m!==void 0)for(let u of m){let f={attr:u.transformedPath.strPath};r.push({attr:c,contains:f})}else try{let u=p.schema;switch(p.schema.type){case"set":case"list":u=p.schema.elements;break;case"string":u=new Ee({});break;default:}let l=new E(u).parse(s,{fill:!1,transform:o});r.push({attr:c,contains:l})}catch{}}return de(r,i)};var ji=(t,e)=>{let r=new L,n=new z(t),{eq:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i),p=ve(n,s,a);for(let c of m){let u=c.transformedPath.strPath;if(p!==void 0)for(let f of p){let l={attr:f.transformedPath.strPath};r.push(o?{size:u,eq:l}:{attr:u,eq:l})}else{let f=o?new K({}):c.schema,l=new E(f);try{let y=l.parse(s,{fill:!1,transform:a});r.push(o?{size:u,eq:y}:{attr:u,eq:y})}catch{}}}return de(r,i)},Ri=(t,e)=>{let r=new L,n=new z(t),{ne:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i),p=ve(n,s,a);for(let c of m){let u=c.transformedPath.strPath;if(p!==void 0)for(let f of p){let l={attr:f.transformedPath.strPath};r.push(o?{size:u,ne:l}:{attr:u,ne:l})}else{let f=o?new K({}):c.schema,l=new E(f);try{let y=l.parse(s,{fill:!1,transform:a});r.push(o?{size:u,ne:y}:{attr:u,ne:y})}catch{}}}return de(r,i)};var qi=(t,e)=>{let r=new L,n=new z(t),{exists:s}=e,o=e.attr,i=n.search(o);for(let a of i){let m=a.transformedPath.strPath;r.push({attr:m,exists:s})}return de(r,o)};var Li=(t,e)=>{let r=new L,n=new z(t),{in:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i);for(let p of m){let c=p.transformedPath.strPath,u=o?new K({}):p.schema,f=new E(u),l=new L({serializer:x=>JSON.stringify({_:x})});for(let x of s){let b=ve(n,x,a);if(b!==void 0)for(let O of b)l.push({attr:O.transformedPath.strPath});else try{l.push(f.parse(x,{fill:!1,transform:a}))}catch{}}let y=l.values;y.length!==0&&r.push(o?{size:c,in:y}:{attr:c,in:y})}return de(r,i)};var Bi=(t,e)=>({or:e.or.map(r=>dr(t,r))}),Fi=(t,e)=>({and:e.and.map(r=>dr(t,r))}),Mi=(t,e)=>({not:dr(t,e.not)});var Ui=(t,e)=>{let r=new L,n=new z(t),{gte:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i),p=ve(n,s,a);for(let c of m){let u=c.transformedPath.strPath;if(p!==void 0)for(let f of p){let l={attr:f.transformedPath.strPath};r.push(o?{size:u,gte:l}:{attr:u,gte:l})}else{let f=o?new K({}):c.schema,l=new E(f);try{let y=l.parse(s,{fill:!1,transform:a});r.push(o?{size:u,gte:y}:{attr:u,gte:y})}catch{}}}return de(r,i)},zi=(t,e)=>{let r=new L,n=new z(t),{gt:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i),p=ve(n,s,a);for(let c of m){let u=c.transformedPath.strPath;if(p!==void 0)for(let f of p){let l={attr:f.transformedPath.strPath};r.push(o?{size:u,gt:l}:{attr:u,gt:l})}else{let f=o?new K({}):c.schema,l=new E(f);try{let y=l.parse(s,{fill:!1,transform:a});r.push(o?{size:u,gt:y}:{attr:u,gt:y})}catch{}}}return de(r,i)},Ki=(t,e)=>{let r=new L,n=new z(t),{lte:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i),p=ve(n,s,a);for(let c of m){let u=c.transformedPath.strPath;if(p!==void 0)for(let f of p){let l={attr:f.transformedPath.strPath};r.push(o?{size:u,lte:l}:{attr:u,lte:l})}else{let f=o?new K({}):c.schema,l=new E(f);try{let y=l.parse(s,{fill:!1,transform:a});r.push(o?{size:u,lte:y}:{attr:u,lte:y})}catch{}}}return de(r,i)},Gi=(t,e)=>{let r=new L,n=new z(t),{lt:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i),p=ve(n,s,a);for(let c of m){let u=c.transformedPath.strPath;if(p!==void 0)for(let f of p){let l={attr:f.transformedPath.strPath};r.push(o?{size:u,lt:l}:{attr:u,lt:l})}else{let f=o?new K({}):c.schema,l=new E(f);try{let y=l.parse(s,{fill:!1,transform:a});r.push(o?{size:u,lt:y}:{attr:u,lt:y})}catch{}}}return de(r,i)};var Bp=new Ee({enum:["S","SS","N","NS","B","BS","BOOL","NULL","L","M"]}),Fp=new E(Bp),Wi=(t,e)=>{let r=new L,n=new z(t),{type:s}=e,o=e.attr,i=n.search(o);for(let a of i){let m=a.transformedPath.strPath,p=Fp.parse(s,{fill:!1,transform:!1});r.push({attr:m,type:p})}return de(r,o)};var dr=(t,e)=>{if("or"in e)return Bi(t,e);if("and"in e)return Fi(t,e);if("not"in e)return Mi(t,e);if("eq"in e)return ji(t,e);if("ne"in e)return Ri(t,e);if("gte"in e)return Ui(t,e);if("gt"in e)return zi(t,e);if("lte"in e)return Ki(t,e);if("lt"in e)return Gi(t,e);if("between"in e)return Ii(t,e);if("beginsWith"in e)return Ni(t,e);if("in"in e)return Li(t,e);if("contains"in e)return Vi(t,e);if("exists"in e)return qi(t,e);if("type"in e)return Wi(t,e);throw new d("actions.invalidCondition",{message:"Invalid condition: Unable to detect valid condition type."})};var Be=class t extends ce{static express(e,r=""){return Xe(e,r)}transform(e){return dr(this.schema,e)}parse(e,{expressionId:r}={}){return t.express(this.transform(e),r)}};Be.actionName="parseCondition";var Hi=t=>({anyOf:t.elements.map(e=>Ce(e))});var Ji=t=>{let e=Object.entries(t.attributes).filter(([,n])=>!n.props.hidden),r=e.filter(([,{props:n}])=>n.required!=="never").map(([n])=>n);return{type:"object",properties:Object.fromEntries(e.map(([n,s])=>[n,Ce(s)])),...r.length>0?{required:r}:{}}};var Qi=t=>({type:"array",items:Ce(t.elements)});var Xi=t=>{let e=Object.entries(t.attributes).filter(([,n])=>!n.props.hidden),r=e.filter(([,{props:n}])=>n.required!=="never").map(([n])=>n);return{type:"object",properties:Object.fromEntries(e.map(([n,s])=>[n,Ce(s)])),...r.length>0?{required:r}:{}}};var Yi=t=>t.type==="binary"?{type:"string"}:{type:t.type};var Zi=t=>({type:"object",propertyNames:Ce(t.keys),additionalProperties:Ce(t.elements)});var _i=t=>({type:"array",items:Ce(t.elements),uniqueItems:!0});var Ce=t=>{switch(t.type){case"any":return{};case"null":case"boolean":case"number":case"string":case"binary":return Yi(t);case"set":return _i(t);case"list":return Qi(t);case"map":return Xi(t);case"record":return Zi(t);case"anyOf":return Hi(t);case"item":return Ji(t)}};var Pn=class extends ce{formattedValueSchema(){return Ce(this.schema)}};Pn.actionName="jsonSchemer";var Fe=t=>{let e={};for(let r of["keyDefault","putDefault","updateDefault"]){let n=t.props[r];n!==void 0&&(e[r]=ur(n)?{defaulterId:"custom"}:{defaulterId:"value",value:n})}return e},ms=t=>S(t)&&"transformerId"in t&&"toJSON"in t;var ea=t=>{let e=Fe(t),{required:r,hidden:n,key:s,savedAs:o,transform:i}=t.props;return{type:"any",...r!==void 0&&r!=="atLeastOnce"?{required:r}:{},...n!==void 0&&n?{hidden:n}:{},...s!==void 0&&s?{key:s}:{},...o!==void 0?{savedAs:o}:{},...i!==void 0?{transform:ms(i)?i.toJSON():{transformerId:"custom"}}:{},...e}};var ta=t=>{let e=Fe(t),{required:r,hidden:n,key:s,savedAs:o,discriminator:i}=t.props;return{type:"anyOf",elements:t.elements.map(Ae),...r!==void 0&&r!=="atLeastOnce"?{required:r}:{},...n!==void 0&&n?{hidden:n}:{},...s!==void 0&&s?{key:s}:{},...o!==void 0?{savedAs:o}:{},...i!==void 0?{discriminator:i}:{},...e}};var ra=t=>({type:"item",attributes:Object.fromEntries(Object.entries(t.attributes).map(([e,r])=>[e,Ae(r)]))});var na=t=>{let e=Fe(t),{required:r,hidden:n,key:s,savedAs:o}=t.props;return{type:"list",elements:Ae(t.elements),...r!==void 0&&r!=="atLeastOnce"?{required:r}:{},...n!==void 0&&n?{hidden:n}:{},...s!==void 0&&s?{key:s}:{},...o!==void 0?{savedAs:o}:{},...e}};var sa=t=>{let e=Fe(t),{required:r,hidden:n,key:s,savedAs:o}=t.props;return{type:"map",attributes:Object.fromEntries(Object.entries(t.attributes).map(([i,a])=>[i,Ae(a)])),...r!==void 0&&r!=="atLeastOnce"?{required:r}:{},...n!==void 0&&n?{hidden:n}:{},...s!==void 0&&s?{key:s}:{},...o!==void 0?{savedAs:o}:{},...e}};var oa=t=>{let e=Fe(t),{props:r}=t,{required:n,hidden:s,key:o,savedAs:i,transform:a}=r,m={type:t.type,...n!==void 0&&n!=="atLeastOnce"?{required:n}:{},...s!==void 0&&s!==!1?{hidden:s}:{},...o!==void 0&&o!==!1?{key:o}:{},...i!==void 0?{savedAs:i}:{},...a!==void 0?{transform:ms(a)?a.toJSON():{transformerId:"custom"}}:{},...e};if(r.enum)switch(t.type){case"binary":{let p=new TextDecoder("utf8");m.enum=r.enum.map(c=>btoa(p.decode(c)));break}case"number":{m.enum=r.enum.map(p=>ss(p)?p.toString():p);break}default:m.enum=r.enum}return m};var ia=t=>{let e=Fe(t),{required:r,hidden:n,key:s,savedAs:o}=t.props;return{type:"record",keys:Ae(t.keys),elements:Ae(t.elements),...r!==void 0&&r!=="atLeastOnce"?{required:r}:{},...n!==void 0&&n?{hidden:n}:{},...s!==void 0&&s?{key:s}:{},...o!==void 0?{savedAs:o}:{},...e}};var aa=t=>{let e=Fe(t),{required:r,hidden:n,key:s,savedAs:o}=t.props;return{type:t.type,elements:Ae(t.elements),...r!==void 0&&r!=="atLeastOnce"?{required:r}:{},...n!==void 0&&n?{hidden:n}:{},...s!==void 0&&s?{key:s}:{},...o!==void 0?{savedAs:o}:{},...e}};var Ae=t=>{switch(t.type){case"any":return ea(t);case"null":case"boolean":case"number":case"string":case"binary":return oa(t);case"set":return aa(t);case"list":return na(t);case"map":return sa(t);case"record":return ia(t);case"anyOf":return ta(t);case"item":return ra(t)}};var Jt=class extends ce{constructor(e){super(e),this.type="item",this.attributes=Object.fromEntries(Object.entries(this.schema.attributes).map(([r,n])=>[r,Ae(n)]))}toJSON(){return{type:this.type,attributes:this.attributes}}};Jt.actionName="dto";var C=Symbol("$entities"),no=Symbol("$interceptor"),Nt=Symbol("$sentArgs");var fr=class{constructor({documentClient:e,name:r,partitionKey:n,sortKey:s,indexes:o={},entityAttributeSavedAs:i="_et",meta:a={}}){this.getDocumentClient=()=>{if(this.documentClient===void 0)throw new d("actions.missingDocumentClient",{message:"You need to set a document client on your table to send a command"});return this.documentClient},this.documentClient=e,this.tableName=r,this.partitionKey=n,s&&(this.sortKey=s),this.indexes=o,this.entityAttributeSavedAs=i,this[C]=[],this.meta=a}getName(){if(this.tableName===void 0)throw new d("table.missingTableName",{message:"Please specify a table name in your Table constructor or in your command options."});return U(this.tableName)?this.tableName:this.tableName()}build(e){return new e(this,this[C])}},Y=class{constructor(e,r=[]){this.table=e,this[C]=r}};var It=class extends Y{constructor(e){super(e)}parse(e){let r=this.table,{partitionKey:n,sortKey:s}=r,o={},i=e[n.name];if(!xt(ma(n),i))throw new d("actions.parsePrimaryKey.invalidKeyPart",{message:`Invalid partition key: ${n.name}`,path:n.name,payload:{expected:n.type,received:i,keyPart:"partitionKey"}});if(o[n.name]=i,s===void 0)return o;let a=e[s.name];if(!xt(ma(s),a))throw new d("actions.parsePrimaryKey.invalidKeyPart",{message:`Invalid sort key: ${s.name}`,path:s.name,payload:{expected:s.type,received:a,keyPart:"sortKey"}});return o[s.name]=a,o}};It.actionName="parsePrimaryKey";var ma=t=>{switch(t.type){case"number":return new K({big:!0});case"string":return new Ee({});case"binary":return new $t({})}};var ya=require("@aws-sdk/lib-dynamodb");var so=Symbol("$interceptor"),Te=Symbol("$sentArgs");var Ye=Symbol("$IS_EXTENSION");var Ge=Symbol("$GET"),Fr=(t,e)=>({[Ye]:!0,[Ge]:e===void 0?[t]:[t,e]}),Ze=t=>S(t)&&Ge in t;var $n=(t,e)=>{if(t===!0)return!0;if(S(t)){let r=t[e];if(r===!0||typeof r=="object")return!0}return!1},Mp={created:{name:"created",savedAs:"_ct",hidden:!1},modified:{name:"modified",savedAs:"_md",hidden:!1}},Vt=(t,e,r)=>{var n;let s=Mp[e][r];if(S(t)){let o=t[e];return S(o)&&(n=o[r])!==null&&n!==void 0?n:s}return s},Ne=t=>!!t,Up={name:"entity",hidden:!0},ke=(t,e)=>{var r;let n=Up[e];return S(t)&&(r=t[e])!==null&&r!==void 0?r:n};var ps=({schema:t,table:e,entityName:r,entityAttribute:n,timestamps:s})=>{let o={};if(Ne(n)){let i=ke(n,"name"),a=new Ee({hidden:ke(n,"hidden"),enum:[r],putDefault:r,updateDefault:()=>Fr(i,r),savedAs:e.entityAttributeSavedAs});o[i]=a}if($n(s,"created")){let i=Vt(s,"created","name"),a=new Ee({hidden:Vt(s,"created","hidden"),savedAs:Vt(s,"created","savedAs"),putDefault:()=>new Date().toISOString(),updateDefault:()=>Fr(i,new Date().toISOString())});o[i]=a}if($n(s,"modified")){let i=Vt(s,"modified","name"),a=new Ee({hidden:Vt(s,"modified","hidden"),savedAs:Vt(s,"modified","savedAs"),putDefault:()=>new Date().toISOString(),updateDefault:()=>new Date().toISOString()});o[i]=a}for(let[i,a]of Object.entries(o)){if(i in t.attributes)throw new d("entity.reservedAttributeName",{message:`'${i}' is a reserved attribute name.`,path:i});let{savedAs:m}=a.props;if(m!==void 0&&t.savedAttributeNames.has(m))throw new d("entity.reservedAttributeSavedAs",{message:`'${m}' is a reserved attribute alias (savedAs).`,path:i})}return new Qe({...t.attributes,...o})};var pa=(t,e)=>{if(e===void 0)return!0;let r=[...t.keyAttributeNames.values()].map(s=>[s,t.attributes[s]]).find(([s,{props:o}])=>o.savedAs===e.name||o.savedAs===void 0&&s===e.name);if(r===void 0)return!1;let[,n]=r;return n!==void 0&&n.type===e.type&&n.props.key===!0&&(n.props.required==="always"||n.props.keyDefault!==void 0)},oo=(t,e)=>{let{partitionKey:r,sortKey:n}=e;return pa(t,r)&&pa(t,n)};var jt=class{constructor({name:e,table:r,schema:n,computeKey:s,entityAttribute:o=!0,timestamps:i=!0,meta:a={}}){if(this.type="entity",this.entityName=e,this.table=r,this.entityAttribute=o,this.timestamps=i,s===void 0&&!oo(n,r))throw new d("entity.invalidSchema",{message:`Entity ${e} schema does not follow its table primary key schema`});this.attributes=n.attributes,this.schema=ps({...this,schema:n}),this.schema.check(),this.computeKey=s,this.meta=a}build(e){return new e(this)}},I=class{constructor(e){this.entity=e}};var io=Symbol("$formatter");var _=class extends I{constructor(e){super(e),this[io]=new Tt(e.schema)}format(e,r={}){let{transform:n=!0}=r,{table:s,entityAttribute:o,entityName:i}=this.entity,{entityAttributeSavedAs:a}=s,m=n?a:ke(o,"name"),p=Ne(o)&&e[m]===void 0;try{let c=this[io].start({...e,...p?{[m]:i}:{}},{...r,format:!0});return n&&c.next(),c.next().value}catch(c){if(!d.match(c,"formatter."))throw c;let u=e[this.entity.table.partitionKey.name],f=this.entity.table.sortKey&&e[this.entity.table.sortKey.name];if(u===void 0&&f===void 0)throw c;let l=u&&[u&&`Partition key: ${String(u)}`,f&&`Sort key: ${String(f)}`].filter(Boolean).join(" / ");throw c.message+=` ${l}`,c.payload.partitionKey=u,c.payload.sortKey=f,c}}};var Mr=()=>(t,e,r)=>{let n=r.value;r.value=async function(...s){let o=this,i=o.table[no];if(i!==void 0){let a=await i(o);if(a!==void 0)return a}return n.apply(this,s)}};var Ur=Symbol("$query"),zr=Symbol("$options"),Kr=Symbol("$entity");var us=Symbol("$conditionParser");var Q=class extends I{static express(e,r=""){return Be.express(e,r)}constructor(e){super(e),this[us]=new Be(e.schema)}transform(e){return this[us].transform(e)}parse(e,r={}){return this[us].parse(e,r)}};var cs=Symbol("$pathParser");var ye=class extends I{static express(e){return Ht.express(e)}constructor(e){super(e),this[cs]=new Ht(e.schema)}transform(e,r){return this[cs].transform(e,r)}parse(e,r){return this[cs].parse(e,r)}};var zp=["NONE","TOTAL","INDEXES"],ua=new Set(zp),oe=t=>{if(!ua.has(t))throw new d("options.invalidCapacityOption",{message:`Invalid capacity option: '${String(t)}'. 'capacity' must be one of: ${[...ua].join(", ")}.`,payload:{capacity:t}});return t};var Qt=(t,e)=>{if(!Se(t))throw new d("options.invalidConsistentOption",{message:`Invalid consistent option: '${String(t)}'. 'consistent' must be boolean.`,payload:{consistent:t}});if(t&&e!==void 0&&e.type!=="local")throw new d("options.invalidConsistentOption",{message:`Invalid consistent option: '${String(t)}'. Queries on global secondary indexes cannot be consistent.`,payload:{consistent:t}});return t};var ds=(t,e,r)=>{if(!Se(t))throw new d("options.invalidEntityAttrFilterOption",{message:`Invalid 'entityAttrFilter' option: '${String(t)}'. 'entityAttrFilter' must be a boolean.`,payload:{entityAttrFilter:t}});let n=e.find(o=>!o.entityAttribute);if(t&&n!==void 0)throw new d("options.invalidEntityAttrFilterOption",{message:`Invalid 'entityAttrFilter' option: '${String(t)}'. 'entityAttrFilter' cannot be true as ${n.entityName} entity has no entity attribute.`,payload:{entityAttrFilter:t}});let s=e.filter(o=>r[o.entityName]!==void 0);if(!t&&s.length>1)throw new d("options.invalidEntityAttrFilterOption",{message:`Invalid 'entityAttrFilter' option: '${String(t)}'. 'entityAttrFilter' must be true when applying multiple filters.`,payload:{entityAttrFilter:t}});return t};var ls=(t,e)=>{if(!U(e))throw new d("options.invalidIndexOption",{message:`Invalid index option: '${String(e)}'. 'index' must be a string.`,payload:{index:e}});if(t.indexes[e]===void 0)throw new d("options.invalidIndexOption",{message:`Invalid index option: '${String(e)}'. Index is not defined on Table, please provide an 'indexes' option to its constructor.`,payload:{index:e}});return e};var fs=t=>{if(!Ke(t)||t<=0)throw new d("options.invalidLimitOption",{message:`Invalid limit option: '${String(t)}'. 'limit' must be an integer > 0.`,payload:{limit:t}});return t};var hs=t=>{if(t===1/0)return t;if(!Ke(t)||t<=0)throw new d("options.invalidMaxPagesOption",{message:`Invalid limit option: '${String(t)}'. 'limit' must be Infinity or an integer > 0.`,payload:{maxPages:t}});return t};var ca=new Set(["DISCARD","THROW"]),ys=t=>{if(!ca.has(t))throw new d("options.invalidNoEntityMatchBehaviorOption",{message:`Invalid noEntityMatchBehavior option: '${String(t)}'. 'noEntityMatchBehavior' must be one of: ${[...ca].join(", ")}.`,payload:{noEntityMatchBehavior:t}});return t};var B=t=>{let[e]=Object.keys(t);if(e!==void 0)throw new d("options.unknownOption",{message:`Unknown option: ${e}.`,payload:{option:e}})};var Kp=["ALL_ATTRIBUTES","ALL_PROJECTED_ATTRIBUTES","COUNT","SPECIFIC_ATTRIBUTES"],da=new Set(Kp),bs=(t,{index:e,attributes:r}={})=>{if(!da.has(t))throw new d("options.invalidSelectOption",{message:`Invalid select option: '${String(t)}'. 'select' must be one of: ${[...da].join(", ")}.`,payload:{select:t}});if(t==="ALL_PROJECTED_ATTRIBUTES"&&e===void 0)throw new d("options.invalidSelectOption",{message:`Invalid select option: '${String(t)}'. Please provide an 'index' option.`,payload:{select:t}});if(r!==void 0&&t!=="SPECIFIC_ATTRIBUTES")throw new d("options.invalidSelectOption",{message:`Invalid select option: '${String(t)}'. Select must be 'SPECIFIC_ATTRIBUTES' if a filter expression has been provided.`,payload:{select:t}});return t};var xs=t=>{if(!Se(t))throw new d("options.invalidShowEntityAttrOption",{message:`Invalid 'showEntityAttr' option: '${String(t)}'. 'showEntityAttr' must be a boolean.`,payload:{showEntityAttr:t}});return t};var H=t=>{if(!U(t))throw new d("options.invalidTableNameOption",{message:`Invalid tableName option: '${String(t)}'. 'tableName' must be a string.`,payload:{tableName:t}});return t};var N=t=>Object.keys(t).length===0;var la=(t,...e)=>{let r=new Set(e);return Object.fromEntries(Object.entries(t).filter(([n])=>r.has(n)))};var Gp=new Set(["eq","gt","gte","lt","lte","between","beginsWith"]),fa=t=>{switch(t.type){case"number":return new K({required:"never"});case"string":return new Ee({required:"never"});case"binary":return new $t({required:"never"})}},ha=(t,e)=>{let{index:r,partition:n,range:s}=e,o;if(r!==void 0){let y=t.indexes[r];if(y===void 0){let x=Object.keys(t.indexes),b=x.length>0;throw new d("queryCommand.invalidIndex",{message:`Unknown index: ${r}. ${b?` Expected one of: ${x.join(", ")}.`:""}`,payload:{received:r,...b?{expected:Object.keys(t.indexes)}:{}}})}o=y}else o=t;let{partitionKey:i=t.partitionKey,sortKey:a}=o;if(n===void 0)throw new d("queryCommand.invalidPartition",{message:`Missing query partition. Expected: ${i.type}.`,path:i.name,payload:{partition:n}});let m=new Qe({[i.name]:fa(i),...a!==void 0&&s!==void 0?{[a.name]:fa(a)}:{}}),p={attr:i.name,eq:n};if(a!==void 0&&s!==void 0){let y={attr:a.name,...la(s,...Gp)};p={and:[p,y]}}let c=new Be(m),{ConditionExpression:u,ExpressionAttributeNames:f,ExpressionAttributeValues:l}=c.parse(p,{expressionId:"0"});return{KeyConditionExpression:u,ExpressionAttributeNames:f,ExpressionAttributeValues:l}};var Wp=new st({required:"never"}),ao=(t,e=[],r,n={})=>{var s;let{entityAttributeSavedAs:o,indexes:i}=t,{index:a}=r,{capacity:m,consistent:p,exclusiveStartKey:c,limit:u,maxPages:f,reverse:l,select:y,filter:x,filters:b,attributes:O,tableName:v,entityAttrFilter:D=e.every(le=>Ne(le.entityAttribute))&&!Hp(a!==void 0&&(s=i[a])!==null&&s!==void 0?s:t,o),showEntityAttr:V,tagEntities:J,noEntityMatchBehavior:R,...q}=n;B(q);let te=b??{},j=O;v!==void 0&&H(v);let $={TableName:v??t.getName()};if(m!==void 0&&($.ReturnConsumedCapacity=oe(m)),a!==void 0&&($.IndexName=ls(t,a)),p!==void 0&&($.ConsistentRead=Qt(p,a!==void 0?t.indexes[a]:void 0)),c!==void 0&&($.ExclusiveStartKey=c),u!==void 0&&($.Limit=fs(u)),f!==void 0&&hs(f),l!==void 0){if(!Se(l))throw new d("queryCommand.invalidReverseOption",{message:'Invalid "reverse" options: Must be a boolean',payload:{reverse:l}});$.ScanIndexForward=!l}if(y!==void 0&&($.Select=bs(y,{index:a,attributes:j})),ds(D,e,te),V!==void 0&&xs(V),J!==void 0&&!Se(J))throw new d("queryCommand.invalidTagEntitiesOption",{message:`Invalid 'tagEntities' option: '${String(J)}'. 'tagEntities' must be a boolean.`,payload:{tagEntities:J}});R!==void 0&&ys(R);let Z={},ae={};if(j!==void 0&&j.length>0&&e.length!==0){let le=new L({serializer:Ue=>Ue});for(let Ue of e){let kt=Ue.build(ye).transform(j,{strict:!1});if(kt.length===0)throw new d("queryCommand.invalidProjectionExpression",{message:`Unable to match any expression attribute path with entity: ${Ue.entityName}`,payload:{entity:Ue.entityName}});for(let wn of kt)le.push(wn)}let fe=ye.express(le.values);Object.assign(Z,fe.ExpressionAttributeNames);let{entityAttributeSavedAs:bt}=t;Object.values(fe.ExpressionAttributeNames).includes(bt)?$.ProjectionExpression=fe.ProjectionExpression:($.ProjectionExpression=[fe.ProjectionExpression,"#_et"].join(", "),Z["#_et"]=bt)}let{KeyConditionExpression:qe,ExpressionAttributeNames:At,ExpressionAttributeValues:Gt}=ha(t,r);if($.KeyConditionExpression=qe,Object.assign(Z,At),Object.assign(ae,Gt),e.length===0&&x!==void 0){let le=new Be(Wp).parse(x,{expressionId:"1"});Object.assign(Z,le.ExpressionAttributeNames),Object.assign(ae,le.ExpressionAttributeValues),$.FilterExpression=le.ConditionExpression}if(e.length>0){let le=[];for(let fe of e){let bt=te[fe.entityName],Ue=D?{attr:ke(fe.entityAttribute,"name"),eq:fe.entityName}:void 0;if(bt===void 0&&Ue===void 0)continue;let kt=fe.build(Q).transform({and:[Ue,bt].filter(Boolean)});le.push(kt)}if(le.length>0){let fe=Xe({or:le},"1");Object.assign(Z,fe.ExpressionAttributeNames),Object.assign(ae,fe.ExpressionAttributeValues),$.FilterExpression=fe.ConditionExpression}}return N(Z)||($.ExpressionAttributeNames=Z),N(ae)||($.ExpressionAttributeValues=ae),$},Hp=({partitionKey:t,sortKey:e},r)=>t?.name===r||e?.name===r;var Jp=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},hr=class extends Y{constructor(e,r=[],n,s={}){super(e,r),this.params=()=>ao(this.table,...this[Nt]()),this[Ur]=n,this[zr]=s}[Nt](){if(!this[Ur])throw new d("actions.incompleteAction",{message:'QueryCommand incomplete: Missing "query" property'});return[this[C],this[Ur],this[zr]]}async send(e){let r=this.table.entityAttributeSavedAs,n=this.params(),s={};this[C].forEach(O=>{s[O.entityName]=O.build(_)});let o=[],i,a=0,m=0,p,c,{attributes:u,maxPages:f=1,showEntityAttr:l=!1,tagEntities:y=!1,noEntityMatchBehavior:x="THROW"}=this[zr],b=0;do{b+=1;let O={...n,...i!==void 0?{ExclusiveStartKey:i}:{}},{Items:v=[],LastEvaluatedKey:D,Count:V,ScannedCount:J,ConsumedCapacity:R,$metadata:q}=await this.table.getDocumentClient().send(new ya.QueryCommand(O),e);for(let te of v){if(this[C].length===0){o.push(te);continue}let j=te[r],$=s[String(j)];if(!U(j)||$===void 0){let le=!1;for(let[fe,bt]of Object.entries(s))try{let Ue=bt.format(te,{attributes:u}),{entityAttribute:kt}=bt.entity,wn=ke(kt,"name"),up=l&&Ne(kt);o.push({...Ue,...up?{[wn]:fe}:{},...y?{[Kr]:fe}:{}}),le=!0;break}catch{continue}if(!le&&x==="THROW")throw new d("queryCommand.noEntityMatched",{message:"Unable to match item of unidentified entity to the QueryCommand entities",payload:{item:te}});continue}let Z=$.format(te,{attributes:u}),{entityAttribute:ae,entityName:qe}=$.entity,At=ke(ae,"name"),Gt=l&&Ne(ae);o.push({...Z,...Gt?{[At]:qe}:{},...y?{[Kr]:qe}:{}})}i=D,a!==void 0&&(a=V!==void 0?a+V:void 0),m!==void 0&&(m=J!==void 0?m+J:void 0),p=R,c=q}while(b<f&&i!==void 0);return{Items:o,...i!==void 0?{LastEvaluatedKey:i}:{},...a!==void 0?{Count:a}:{},...m!==void 0?{ScannedCount:m}:{},...b===1?{...p!==void 0?{ConsumedCapacity:p}:{},...c!==void 0?{$metadata:c}:{}}:{}}}};hr.actionName="query";Jp([Mr()],hr.prototype,"send",null);var pe=class t extends hr{constructor(e,r=[],n,s={}){super(e,r,n,s)}entities(...e){return new t(this.table,e,this[Ur],this[zr])}query(e){return new t(this.table,this[C],e,this[zr])}options(e){return new t(this.table,this[C],this[Ur],e)}};var ba=require("@aws-sdk/lib-dynamodb");var Dn=Symbol("$options");var Qp=new st({required:"never"}),mo=(t,e=[],r={})=>{let{capacity:n,consistent:s,exclusiveStartKey:o,index:i,limit:a,maxPages:m,select:p,totalSegments:c,segment:u,filter:f,filters:l,attributes:y,tableName:x,entityAttrFilter:b=e.every(j=>Ne(j.entityAttribute)),showEntityAttr:O,noEntityMatchBehavior:v,...D}=r;B(D);let V=l??{},J=y;x!==void 0&&H(x);let R={TableName:x??t.getName()};if(n!==void 0&&(R.ReturnConsumedCapacity=oe(n)),s!==void 0&&(R.ConsistentRead=Qt(s,i!==void 0?t.indexes[i]:void 0)),o!==void 0&&(R.ExclusiveStartKey=o),i!==void 0&&(R.IndexName=ls(t,i)),a!==void 0&&(R.Limit=fs(a)),m!==void 0&&hs(m),p!==void 0&&(R.Select=bs(p,{index:i,attributes:J})),ds(b,e,V),O!==void 0&&xs(O),v!==void 0&&ys(v),u!==void 0){if(c===void 0)throw new d("scanCommand.invalidSegmentOption",{message:"If a segment option has been provided, totalSegments must also be defined",payload:{}});if(!Ke(c)||c<1)throw new d("scanCommand.invalidSegmentOption",{message:`Invalid totalSegments option: '${String(c)}'. 'totalSegments' must be a strictly positive integer.`,payload:{totalSegments:c}});if(!Ke(u)||u<0||u>=c)throw new d("scanCommand.invalidSegmentOption",{message:`Invalid segment option: '${String(u)}'. 'segment' must be a positive integer strictly lower than 'totalSegments'.`,payload:{segment:u,totalSegments:c}});R.TotalSegments=c,R.Segment=u}let q={},te={};if(J!==void 0&&J.length>0&&e.length!==0){let j=new L({serializer:ae=>ae});for(let ae of e){let qe=ae.build(ye).transform(J,{strict:!1});if(qe.length===0)throw new d("scanCommand.invalidProjectionExpression",{message:`Unable to match any expression attribute path with entity: ${ae.entityName}`,payload:{entity:ae.entityName}});for(let At of qe)j.push(At)}let $=ye.express(j.values);Object.assign(q,$.ExpressionAttributeNames);let{entityAttributeSavedAs:Z}=t;Object.values($.ExpressionAttributeNames).includes(Z)?R.ProjectionExpression=$.ProjectionExpression:(R.ProjectionExpression=[$.ProjectionExpression,"#_et"].join(", "),q["#_et"]=Z)}if(e.length===0&&f!==void 0){let{ExpressionAttributeNames:j,ExpressionAttributeValues:$,ConditionExpression:Z}=new Be(Qp).parse(f);Object.assign(q,j),Object.assign(te,$),R.FilterExpression=Z}if(e.length>0){let j=[];for(let $ of e){let Z=V[$.entityName],ae=b?{attr:ke($.entityAttribute,"name"),eq:$.entityName}:void 0;if(Z===void 0&&ae===void 0)continue;let qe=$.build(Q).transform({and:[ae,Z].filter(Boolean)});j.push(qe)}if(j.length>0){let $=Xe({or:j});Object.assign(q,$.ExpressionAttributeNames),Object.assign(te,$.ExpressionAttributeValues),R.FilterExpression=$.ConditionExpression}}return N(q)||(R.ExpressionAttributeNames=q),N(te)||(R.ExpressionAttributeValues=te),R};var Xp=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},yr=class extends Y{constructor(e,r=[],n={}){super(e,r),this[Dn]=n}[Nt](){return[this[C],this[Dn]]}params(){return mo(this.table,...this[Nt]())}async send(e){let r=this.table.entityAttributeSavedAs,n=this.params(),s={};this[C].forEach(b=>{s[b.entityName]=b.build(_)});let o=[],i,a=0,m=0,p,c,{attributes:u,maxPages:f=1,showEntityAttr:l=!1,noEntityMatchBehavior:y="THROW"}=this[Dn],x=0;do{x+=1;let b={...n,...i!==void 0?{ExclusiveStartKey:i}:{}},{Items:O=[],LastEvaluatedKey:v,Count:D,ScannedCount:V,ConsumedCapacity:J,$metadata:R}=await this.table.getDocumentClient().send(new ba.ScanCommand(b),e);for(let q of O){if(this[C].length===0){o.push(q);continue}let te=q[r],j=s[String(te)];if(!U(te)||j===void 0){let Gt=!1;for(let[le,fe]of Object.entries(s))try{let bt=fe.format(q,{attributes:u}),{entityAttribute:Ue}=fe.entity,kt=ke(Ue,"name"),wn=l&&Ne(Ue);o.push({...bt,...wn?{[kt]:le}:{}}),Gt=!0;break}catch{continue}if(!Gt&&y==="THROW")throw new d("scanCommand.noEntityMatched",{message:"Unable to match item of unidentified entity to the ScanCommand entities",payload:{item:q}});continue}let $=j.format(q,{attributes:u}),{entityAttribute:Z,entityName:ae}=j.entity,qe=ke(Z,"name"),At=l&&Ne(Z);o.push({...$,...At?{[qe]:ae}:{}})}i=v,a!==void 0&&(a=D!==void 0?a+D:void 0),m!==void 0&&(m=V!==void 0?m+V:void 0),p=J,c=R}while(x<f&&i!==void 0);return{Items:o,...i!==void 0?{LastEvaluatedKey:i}:{},...a!==void 0?{Count:a}:{},...m!==void 0?{ScannedCount:m}:{},...x===1?{...p!==void 0?{ConsumedCapacity:p}:{},...c!==void 0?{$metadata:c}:{}}:{}}}};yr.actionName="scan";Xp([Mr()],yr.prototype,"send",null);var Et=class t extends yr{constructor(e,r=[],n={}){super(e,r,n)}entities(...e){return new t(this.table,e,this[Dn])}options(e){return new t(this.table,this[C],e)}};var po=Symbol("$parser");var F=class extends I{constructor(e){super(e),this[po]=new E(e.schema)}parse(e,r={}){let{fill:n=!0}=r,s=this[po].start(e,{...r,transform:!0});n&&(s.next(),s.next());let o=s.next().value,i=s.next().value,a=this.entity.computeKey?this.entity.computeKey(o):i,m=new It(this.entity.table).parse(a);return{parsedItem:o,item:{...i,...m},key:m}}reparse(e,r={}){return this.parse(e,r)}};var ws=Symbol("$key");var ot=class t extends I{constructor(e,r){super(e),this[ws]=r}key(e){return new t(this.entity,e)}params(){if(!this[ws])throw new d("actions.incompleteAction",{message:'DeleteItemCommand incomplete: Missing "key" property'});let{key:e}=this.entity.build(F).parse(this[ws],{mode:"key"});return{DeleteRequest:{Key:e}}}};ot.actionName="batchDelete";var Gr=Symbol("$requests"),uo=Symbol("$options");var it=class t extends Y{constructor(e,r=[],n,s={}){super(e,r),this[Gr]=n,this[uo]=s}requests(...e){let r=[],n=new Set;for(let s of e)n.has(s.entity.entityName)||(r.push(s.entity),n.add(s.entity.entityName));return new t(this.table,r,e)}options(e){return new t(this.table,this[C],this[Gr],e)}params(){var e;if(this[Gr]===void 0||this[Gr].length===0)throw new d("actions.incompleteAction",{message:"BatchWriteCommand incomplete: No BatchWriteRequest supplied"});let{tableName:r,...n}=(e=this[uo])!==null&&e!==void 0?e:{};return B(n),r&&H(r),{[r??this.table.getName()]:this[Gr].map(s=>s.params())}}};it.actionName="batchWrite";var wa=require("@aws-sdk/lib-dynamodb");var Yp=["NONE","SIZE"],xa=new Set(Yp),_e=t=>{if(!xa.has(t))throw new d("options.invalidMetricsOption",{message:`Invalid metrics option: '${String(t)}'. 'metrics' must be one of: ${[...xa].join(", ")}.`,payload:{metrics:t}});return t};var Wr=async(...t)=>{let[e={},...r]=t,n=r,s={};e instanceof it?n.unshift(e):s=e;let o=n[0];if(o===void 0)throw new d("actions.incompleteAction",{message:"Cannot execute BatchWriteCommands: No BatchWriteCommand supplied"});let{maxAttempts:i=1,metrics:a,capacity:m,documentClient:p,...c}=s,u=p??o.table.getDocumentClient(),{RequestItems:f,...l}=Zp(n,{metrics:a,capacity:m}),y=0,x=f,b={},O,v,D={};do{y+=1;let{UnprocessedItems:V={},ConsumedCapacity:J,ItemCollectionMetrics:R,$metadata:q}=await u.send(new wa.BatchWriteCommand({RequestItems:x,...l}),c);x=V,b=V,O=J,v=R,D=q}while(y<i&&!N(b));return{...b!==void 0?{UnprocessedItems:b}:{},$metadata:{},...y===1?{...O!==void 0?{ConsumedCapacity:O}:{},...v!==void 0?{ItemCollectionMetrics:v}:{},...D!==void 0?{$metadata:D}:{}}:{}}},Zp=(t,e={})=>{let r={};if(t.length===0)throw new d("actions.incompleteAction",{message:"batchWrite arguments incomplete: No BatchWriteCommand supplied"});for(let o of t){let i=o.params();for(let a of Object.keys(i))if(a in r)throw new d("actions.invalidAction",{message:`Two BatchWriteCommands detected for table: ${a}. Please provide only one BatchWriteCommand per table`});Object.assign(r,i)}let{capacity:n,metrics:s}=e;return{RequestItems:r,...n!==void 0?{ReturnConsumedCapacity:oe(n)}:{},...s!==void 0?{ReturnItemCollectionMetrics:_e(s)}:{}}};var Ea=(t,e)=>{let r=[...t],n=[];for(;r.length>0;)n.push(r.splice(0,e));return n};var br=Symbol("$query"),xr=Symbol("$options");var _p=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},Xt=class t extends Y{constructor(e,r=[],n,s={}){super(e,r),this[br]=n,this[xr]=s}entities(...e){return new t(this.table,e,this[br],this[xr])}query(e){return new t(this.table,this[C],e,this[xr])}options(e){return new t(this.table,this[C],this[br],e)}[Nt](){if(this[C].length===0)throw new d("actions.incompleteAction",{message:'DeletePartitionCommand incomplete: Missing "entities" property'});if(!this[br])throw new d("actions.incompleteAction",{message:'DeletePartitionCommand incomplete: Missing "query" property'});return[this[C],this[br],this[xr]]}queryCommand({exclusiveStartKey:e}={}){return new pe(this.table,this[C],this[br],{...this[xr],attributes:void 0,tagEntities:!0,...e!==void 0?{ExclusiveStartKey:e}:{},maxPages:16})}params(){return this.queryCommand().params()}async send(e){let r={};this[C].forEach(u=>{r[u.entityName]=u});let{capacity:n,tableName:s}=this[xr],o,i=0,a=0,m,p=[],c=0;do{c+=1;let{Items:u=[],Count:f,ScannedCount:l,ConsumedCapacity:y,...x}=await this.queryCommand({exclusiveStartKey:o}).send(e);for(let b of Ea(u,25)){if(b.length===0)continue;let O=[];for(let D of b){let V=r[D[Kr]];V!==void 0&&O.push(new ot(V,D))}let{ConsumedCapacity:v}=await Wr({maxAttempts:1/0,capacity:n,...e},this.table.build(it).options({tableName:s}).requests(...O));v!==void 0?p?.push(...v):p=void 0}o=x.LastEvaluatedKey,i!==void 0&&(i=f!==void 0?i+f:void 0),a!==void 0&&(a=l!==void 0?a+l:void 0),m=y}while(o!==void 0);return{...o!==void 0?{LastEvaluatedKey:o}:{},...i!==void 0?{Count:i}:{},...a!==void 0?{ScannedCount:a}:{},...p!==void 0?{BatchWriteConsumedCapacity:p}:{},...c===1?{...m!==void 0?{QueryConsumedCapacity:m}:{}}:{}}}};Xt.actionName="deletePartition";_p([Mr()],Xt.prototype,"send",null);var Hr=Symbol("$requests"),Jr=Symbol("$options");var Rt=class t extends Y{constructor(e,r=[],n,s={}){super(e,r),this[Hr]=n,this[Jr]=s}requests(...e){let r=[],n=new Set;for(let s of e)n.has(s.entity.entityName)||(r.push(s.entity),n.add(s.entity.entityName));return new t(this.table,r,e,this[Jr])}options(e){return new t(this.table,this[C],this[Hr],e)}params(){var e;let r=this[Hr];if(r===void 0||r.length===0)throw new d("actions.incompleteAction",{message:"BatchGetCommand incomplete: No BatchGetRequest supplied"});let{consistent:n,attributes:s,tableName:o,...i}=(e=this[Jr])!==null&&e!==void 0?e:{};B(i),o&&H(o);let a=s,m,p={};if(a!==void 0&&a.length>0){let u=new L({serializer:v=>v});for(let v of this[C]){let D=v.build(ye).transform(a,{strict:!1});if(D.length===0)throw new d("batchGetCommand.invalidProjectionExpression",{message:`Unable to match any expression attribute path with entity: ${v.entityName}`,payload:{entity:v.entityName}});for(let V of D)u.push(V)}let{ExpressionAttributeNames:f,ProjectionExpression:l}=ye.express(u.values);Object.assign(p,f),m=l;let{partitionKey:y,sortKey:x,entityAttributeSavedAs:b}=this.table,O=new Set(Object.values(p));O.has(y.name)||(m+=", #_pk",p["#_pk"]=y.name),x!==void 0&&!O.has(x.name)&&(m+=", #_sk",p["#_sk"]=x.name),O.has(b)||(m+=", #_et",p["#_et"]=b)}let c=[];for(let u of r){let f=u.params();c.push(f)}return{[o??this.table.getName()]:{Keys:c,...n!==void 0?{ConsistentRead:Qt(n)}:{},...m!==void 0?{ProjectionExpression:m}:{},...N(p)?{}:{ExpressionAttributeNames:p}}}}};Rt.actionName="batchGet";var ga=require("@aws-sdk/lib-dynamodb");var Es=async(...t)=>{let[e={},...r]=t,n=r,s={};e instanceof Rt?n.unshift(e):s=e;let o=n[0];if(o===void 0)throw new d("actions.incompleteAction",{message:"batchGet incomplete: No BatchGetCommand supplied"});let{maxAttempts:i=1,documentClient:a,capacity:m,...p}=s,c=a??o.table.getDocumentClient(),{RequestItems:u,...f}=eu(n,{capacity:m}),l=0,y=u,x,b={},O,v={};do{l+=1;let{Responses:V,UnprocessedKeys:J={},ConsumedCapacity:R,$metadata:q}=await c.send(new ga.BatchGetCommand({RequestItems:y,...f}),p);if(V!==void 0){x===void 0&&(x={});for(let[te,j]of Object.entries(V)){let $=x[te];$===void 0?x[te]=j:$.push(...j)}}y=J,b=J,O=R,v=q}while(l<i&&!N(b));let D;return x!==void 0&&(D=n.map(V=>{let J=V.table.getName(),R=V[Hr],{attributes:q}=V[Jr];return R?.map((te,j)=>{let $=te.entity,Z=x[J];if(Z===void 0)return;let ae=u[J].Keys[j],qe=Z.find(At=>Object.entries(ae).every(([Gt,le])=>At[Gt]===le));if(qe!==void 0)return $.build(_).format(qe,{attributes:q})})})),{...D!==void 0?{Responses:D}:{},...b!==void 0?{UnprocessedKeys:b}:{},...l===1?{...O!==void 0?{ConsumedCapacity:O}:{},...v!==void 0?{$metadata:v}:{}}:{}}},eu=(t,e={})=>{let r={};if(t.length===0)throw new d("actions.incompleteAction",{message:"Unable to execute BatchGetCommands: No BatchGetCommand supplied"});for(let s of t){let o=s.params();for(let i of Object.keys(o))if(i in r)throw new d("actions.invalidAction",{message:`Two BatchGetCommands detected for table: ${i}. Please provide only one BatchGetCommand per table`});Object.assign(r,o)}let{capacity:n}=e;return{RequestItems:r,...n!==void 0?{ReturnConsumedCapacity:oe(n)}:{}}};var wr=Symbol("$schema"),Er=Symbol("$pattern"),gr=Symbol("$options"),Sa=Symbol("$meta");var Qr=class extends Y{constructor(e,r=[],n,s,o={},i={}){super(e,r),this[wr]=n,this[Er]=s,this[gr]=o,this[Sa]=i}query(e){let r=this[wr];if(r===void 0)throw new d("actions.incompleteAction",{message:'AccessPattern incomplete: Missing "schema" property'});let n=this[Er];if(n===void 0)throw new d("actions.incompleteAction",{message:'AccessPattern incomplete: Missing "pattern" property'});let o=new E(r).parse(e),i=n(o),a=this[gr];return new pe(this.table,this[C],i,a)}};Qr.actionName="access-pattern";var Xr=class t extends Qr{constructor(e,r=[],n,s,o={},i={}){super(e,r,n,s,o,i)}entities(...e){return new t(this.table,e,this[wr],this[Er],this[gr])}schema(e){return new t(this.table,this[C],e,this[Er],this[gr])}pattern(e){return new t(this.table,this[C],this[wr],e,this[gr])}options(e){return new t(this.table,this[C],this[wr],this[Er],e)}meta(e){return new t(this.table,this[C],this[wr],this[Er],this[gr],e)}};var Oa=Symbol("$actionName"),va=Symbol("$sentActions"),Aa=Symbol("$spy"),ka=Symbol("$mocks");var Yt=class extends Y{constructor(e){super(e),this.tableName=this.table.tableName!==void 0?this.table.getName():void 0,this.partitionKey=this.table.partitionKey,this.sortKey=this.table.sortKey,this.indexes=this.table.indexes,this.entityAttributeSavedAs=this.table.entityAttributeSavedAs}toJSON(){return{...this.tableName!==void 0?{tableName:this.tableName}:{},partitionKey:this.partitionKey,...this.sortKey!==void 0?{sortKey:this.sortKey}:{},...this.indexes!==void 0&&Object.entries(this.indexes).length>0?{indexes:this.indexes}:{},entityAttributeSavedAs:this.entityAttributeSavedAs}}};Yt.actionName="dto";var gs=Symbol("$key");var qt=class t extends I{constructor(e,r){super(e),this[gs]=r}key(e){return new t(this.entity,e)}params(){if(!this[gs])throw new d("actions.incompleteAction",{message:'BatchGetRequest incomplete: Missing "key" property'});let{key:e}=this.entity.build(F).parse(this[gs],{mode:"key"});return e}};qt.actionName="batchGet";var Ss=Symbol("$item");var Lt=class t extends I{constructor(e,r){super(e),this[Ss]=r}item(e){return new t(this.entity,e)}params(){if(!this[Ss])throw new d("actions.incompleteAction",{message:'BatchPutRequest incomplete: Missing "item" property'});let{item:e}=this.entity.build(F).parse(this[Ss]);return{PutRequest:{Item:e}}}};Lt.actionName="batchPut";var Cn=class t extends Y{constructor(e,r=[]){super(e,r)}entities(...e){return new t(this.table,e)}parsePrimaryKey(e){return new It(this.table).parse(e)}async scan(e={}){return new Et(this.table,this[C],e).send()}async query(e,r={}){return new pe(this.table,this[C],e,r).send()}async deletePartition(e,r={}){return new Xt(this.table,this[C],e,r).send()}static executeBatchGet(...e){return Es(...e)}batchGet(...e){let[r={},...n]=e,s=n,o={};if(ru(r)?s.unshift(r):o=r,s[0]===void 0)throw new d("actions.incompleteAction",{message:"batchGet incomplete: No BatchGetRequest supplied"});let a=[],m=new Set;for(let p of s)m.has(p.entity.entityName)||(a.push(p.entity),m.add(p.entity.entityName));return new Rt(this.table,a,s,o)}static executeBatchWrite(...e){return Wr(...e)}batchWrite(...e){let[r={},...n]=e,s=n,o={};if(nu(r)?s.unshift(r):o=r,s[0]===void 0)throw new d("actions.incompleteAction",{message:"batchGet incomplete: No BatchWriteRequest supplied"});let a=[],m=new Set;for(let p of s)m.has(p.entity.entityName)||(a.push(p.entity),m.add(p.entity.entityName));return new it(this.table,a,s,o)}accessPattern(e,r,n={}){return new Xr(this.table,this[C],e,r,n)}};Cn.actionName="repository";var ru=t=>t instanceof qt,nu=t=>t instanceof Lt||t instanceof ot;var Tn=class t extends Y{constructor(e,r=[],n={},{entities:s=$a(r),query:o=Pa(n)}={}){super(e,r),this.entities=s,this.accessPatterns=n,this.query=o}registerEntities(...e){return new t(this.table,e,this.accessPatterns,{entities:$a(e),query:this.query})}registerAccessPatterns(e){return new t(this.table,this[C],e,{entities:this.entities,query:Pa(e)})}build(e){return new e(this.table,this[C])}};Tn.actionName="registry";var Pa=t=>Object.fromEntries(Object.entries(t).map(([e,r])=>[e,n=>r.query(n)])),$a=t=>Object.fromEntries(t.map(e=>[e.entityName,e]));var Ca=require("@aws-sdk/lib-dynamodb");var gt=()=>(t,e,r)=>{let n=r.value;r.value=async function(...s){let o=this,i=o.entity[so];if(i!==void 0){let a=await i(o);if(a!==void 0)return a}return n.apply(this,s)}};var Nn=Symbol("$key"),In=Symbol("$options");var Da=(t,e)=>{let r={},{capacity:n,consistent:s,attributes:o,tableName:i,...a}=e;if(B(a),n!==void 0&&(r.ReturnConsumedCapacity=oe(n)),s!==void 0&&(r.ConsistentRead=Qt(s)),o!==void 0){let{ExpressionAttributeNames:m,ProjectionExpression:p}=t.build(ye).parse(o);N(m)||(r.ExpressionAttributeNames=m),r.ProjectionExpression=p}return i!==void 0&&H(i),r};var lo=(t,e,r={})=>{var n;let{key:s}=t.build(F).parse(e,{mode:"key"}),o=Da(t,r);return{TableName:(n=r.tableName)!==null&&n!==void 0?n:t.table.getName(),Key:s,...o}};var su=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},at=class t extends I{constructor(e,r,n={}){super(e),this[Nn]=r,this[In]=n}key(e){return new t(this.entity,e,this[In])}options(e){return new t(this.entity,this[Nn],e)}[Te](){if(!this[Nn])throw new d("actions.incompleteAction",{message:'GetItemCommand incomplete: Missing "key" property'});return[this[Nn],this[In]]}params(){return lo(this.entity,...this[Te]())}async send(e){let r=this.params(),n=await this.entity.table.getDocumentClient().send(new Ca.GetCommand(r),e),{Item:s,...o}=n;if(s===void 0)return o;let{attributes:i}=this[In];return{Item:new _(this.entity).format(s,{attributes:i}),...o}}};at.actionName="get";su([gt()],at.prototype,"send",null);var Va=require("@aws-sdk/lib-dynamodb");var Vn=Symbol("$item"),Os=Symbol("$options");var Zt=(t,e)=>{if(!t.has(e))throw new d("options.invalidReturnValuesOption",{message:`Invalid returnValues option: '${String(e)}'. 'returnValues' must be one of: ${[...t].join(", ")}.`,payload:{returnValues:e}});return e};var Ta=new Set(["NONE","ALL_OLD"]),Ie=t=>{if(!Ta.has(t))throw new d("options.invalidReturnValuesOnConditionFalseOption",{message:`Invalid returnValues option: '${String(t)}'. 'returnValuesOnConditionFalse' must be one of: ${[...Ta].join(", ")}.`,payload:{returnValues:t}});return t};var ou=["NONE","ALL_OLD"],Na=new Set(ou);var Ia=(t,e)=>{let r={},{capacity:n,metrics:s,returnValues:o,returnValuesOnConditionFalse:i,condition:a,tableName:m,...p}=e;if(B(p),n!==void 0&&(r.ReturnConsumedCapacity=oe(n)),s!==void 0&&(r.ReturnItemCollectionMetrics=_e(s)),o!==void 0&&(r.ReturnValues=Zt(Na,o)),i!==void 0&&(r.ReturnValuesOnConditionCheckFailure=Ie(i)),a!==void 0){let{ExpressionAttributeNames:c,ExpressionAttributeValues:u,ConditionExpression:f}=t.build(Q).parse(a);N(c)||(r.ExpressionAttributeNames=c),N(u)||(r.ExpressionAttributeValues=u),r.ConditionExpression=f}return m!==void 0&&H(m),r};var fo=(t,e,r={})=>{var n;let{parsedItem:s,item:o}=t.build(F).parse(e),i=Ia(t,r);return{TableName:(n=r.tableName)!==null&&n!==void 0?n:t.table.getName(),Item:o,ToolboxItem:s,...i}};var iu=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},mt=class t extends I{constructor(e,r,n={}){super(e),this[Vn]=r,this[Os]=n}item(e){return new t(this.entity,e,this[Os])}options(e){return new t(this.entity,this[Vn],e)}[Te](){if(!this[Vn])throw new d("actions.incompleteAction",{message:'PutItemCommand incomplete: Missing "item" property'});return[this[Vn],this[Os]]}params(){let[e,r]=this[Te]();return fo(this.entity,e,r)}async send(e){let{ToolboxItem:r,...n}=this.params(),s=await this.entity.table.getDocumentClient().send(new Va.PutCommand(n),e),{Attributes:o,...i}=s;if(o===void 0)return{ToolboxItem:r,...i};let a=new _(this.entity).format(o);return{ToolboxItem:r,Attributes:a,...i}}};mt.actionName="put";iu([gt()],mt.prototype,"send",null);var qa=require("@aws-sdk/lib-dynamodb");var jn=Symbol("$key"),vs=Symbol("$options");var au=["NONE","ALL_OLD"],ja=new Set(au);var Ra=(t,e)=>{let r={},{capacity:n,metrics:s,returnValues:o,returnValuesOnConditionFalse:i,condition:a,tableName:m,...p}=e;if(B(p),n!==void 0&&(r.ReturnConsumedCapacity=oe(n)),s!==void 0&&(r.ReturnItemCollectionMetrics=_e(s)),o!==void 0&&(r.ReturnValues=Zt(ja,o)),i!==void 0&&(r.ReturnValuesOnConditionCheckFailure=Ie(i)),a!==void 0){let{ExpressionAttributeNames:c,ExpressionAttributeValues:u,ConditionExpression:f}=t.build(Q).parse(a);N(c)||(r.ExpressionAttributeNames=c),N(u)||(r.ExpressionAttributeValues=u),r.ConditionExpression=f}return m!==void 0&&H(m),r};var ho=(t,e,r={})=>{var n;let{key:s}=t.build(F).parse(e,{mode:"key"}),o=Ra(t,r);return{TableName:(n=r.tableName)!==null&&n!==void 0?n:t.table.getName(),Key:s,...o}};var mu=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},_t=class t extends I{constructor(e,r,n={}){super(e),this[jn]=r,this[vs]=n}key(e){return new t(this.entity,e,this[vs])}options(e){return new t(this.entity,this[jn],e)}[Te](){if(!this[jn])throw new d("actions.incompleteAction",{message:'DeleteItemCommand incomplete: Missing "key" property'});return[this[jn],this[vs]]}params(){return ho(this.entity,...this[Te]())}async send(e){let r=this.params(),n=await this.entity.table.getDocumentClient().send(new qa.DeleteCommand(r),e),{Attributes:s,...o}=n;return s===void 0?o:{Attributes:new _(this.entity).format(s),...o}}};_t.actionName="delete";mu([gt()],_t.prototype,"send",null);var im=require("@aws-sdk/lib-dynamodb");var Rn=Symbol("$item"),qn=Symbol("$options");var Yr=(t,...e)=>{let r=new Set(e);return Object.fromEntries(Object.entries(t).filter(([n])=>!r.has(n)))};var Re=Symbol("$ADD");var er=t=>S(t)&&Re in t;var be=Symbol("$APPEND");var tr=t=>S(t)&&be in t;var St=Symbol("$DELETE");var Zr=t=>S(t)&&St in t;var xe=Symbol("$PREPEND");var rr=t=>S(t)&&xe in t;var yo=Symbol("$REMOVE");var et=t=>S(t)&&yo in t;var M=Symbol("$SET");var Ot=t=>S(t)&&M in t;var pt=Symbol("$SUBTRACT");var _r=t=>S(t)&&pt in t;var ut=Symbol("$SUM");var en=t=>S(t)&&ut in t;var ee=(t,e,r)=>{let n="";return t.arrayPath.forEach((s,o)=>{if(Je(s)){n+=`[${s}]`;return}let i=r.tokens[e][s];i===void 0&&(i=`#${e}_${r.nameCursors[e]}`,r.tokens[e][s]=i,r.ExpressionAttributeNames[i]=s,r.nameCursors[e]++),o>0&&(n+="."),n+=i}),n},uu=(t,e,r)=>{let n=`:${e}_${r.valueCursors[e]}`;return r.ExpressionAttributeValues[n]=t,r.valueCursors[e]++,n},ne=(t,e,r)=>{if(Ze(t)){let[n,s]=t[Ge],[o]=new z(r.rootSchema).search(n);if(o===void 0)throw new d("actions.invalidExpressionAttributePath",{message:`Unable to match update reference with schema: ${n}`,payload:{attributePath:n}});if(s===void 0)return ee(o.transformedPath,e,r);{let i="if_not_exists(";return i+=ee(o.transformedPath,e,r),i+=", ",i+=ne(s,e,r),i+=")",i}}return uu(t,e,r)};var Wa=(t,e,r)=>{let n=ee(e,"a",r);return n+=" ",n+=ne(t[Re],"a",r),r.addExpressions.push(n),r};var Ha=(t,e,r)=>{let n=ee(e,"s",r);return n+=" = list_append(if_not_exists(",n+=ee(e,"s",r),n+=", ",n+=ne([],"s",r),n+="), ",n+=ne(t[be],"s",r),n+=")",r.setExpressions.push(n),r};var Ja=(t,e,r)=>{let n=ee(e,"d",r);return n+=" ",n+=ne(t[St],"d",r),r.deleteExpressions.push(n),r};var Qa=(t,e,r)=>{let n=ee(e,"s",r);return n+=" = ",n+=ne(t,"s",r),r.setExpressions.push(n),r};var Xa=(t,e,r)=>{let n=ee(e,"s",r);return n+=" = list_append(",n+=ne(t[xe],"s",r),n+=", if_not_exists(",n+=ee(e,"s",r),n+=", ",n+=ne([],"s",r),n+="))",r.setExpressions.push(n),r};var Ya=(t,e,r)=>(r.removeExpressions.push(ee(e,"r",r)),r);var Za=(t,e,r)=>{let n=ee(e,"s",r);return n+=" = ",n+=ne(t[M],"s",r),r.setExpressions.push(n),r};var _a=(t,e,r)=>{let[n,s]=t[pt],o=ee(e,"s",r);return o+=" = ",o+=ne(n,"s",r),o+=" - ",o+=ne(s,"s",r),r.setExpressions.push(o),r};var em=(t,e,r)=>{let[n,s]=t[ut],o=ee(e,"s",r);return o+=" = ",o+=ne(n,"s",r),o+=" + ",o+=ne(s,"s",r),r.setExpressions.push(o),r};var Sr=(t,e)=>{let{setExpressions:r,removeExpressions:n,addExpressions:s,deleteExpressions:o,ExpressionAttributeNames:i,ExpressionAttributeValues:a}=bo(e,new ze,{rootSchema:t.schema,setExpressions:[],removeExpressions:[],addExpressions:[],deleteExpressions:[],nameCursors:{s:1,r:1,a:1,d:1},valueCursors:{s:1,r:1,a:1,d:1},tokens:{s:{},r:{},a:{},d:{}},ExpressionAttributeNames:{},ExpressionAttributeValues:{}}),m=[];return r.length>0&&m.push(`SET ${r.join(", ")}`),n.length>0&&m.push(`REMOVE ${n.join(", ")}`),s.length>0&&m.push(`ADD ${s.join(", ")}`),o.length>0&&m.push(`DELETE ${o.join(", ")}`),{UpdateExpression:m.join(" "),ExpressionAttributeNames:i,ExpressionAttributeValues:a}},bo=(t,e,r)=>{if(t===void 0)return r;if(Ot(t))return Za(t,e,r);if(Ze(t))return Qa(t,e,r);if(en(t))return em(t,e,r);if(_r(t))return _a(t,e,r);if(tr(t))return Ha(t,e,r);if(rr(t))return Xa(t,e,r);if(et(t))return Ya(t,e,r);if(er(t))return Wa(t,e,r);if(Zr(t))return Ja(t,e,r);if(S(t)){for(let[s,o]of Object.entries(t))bo(o,e.append(s),r);return r}if(X(t))return t.forEach((s,o)=>{s!==void 0&&bo(s,e.append(o),r)}),r;let n=ee(e,"s",r);return n+=" = ",n+=ne(t,"s",r),r.setExpressions.push(n),r};var Pe=(t,e,{transform:r=!0,valuePath:n}={})=>!Ze(e)||e[Ge]===void 0?{isExtension:!1,unextendedInput:e}:{isExtension:!0,*extensionParser(){let s=e[Ge],o=[...n??[],"$GET"];if(!X(s)){let u=P(o);throw new d("parsing.invalidAttributeInput",{message:`References ${u!==void 0?`for attribute '${u}' `:""}should be a tuple of one or two elements`,path:u,payload:{received:s}})}let[i,a]=s;if(!U(i)){let u=P([...o,0]);throw new d("parsing.invalidAttributeInput",{message:`First elements of references ${u!==void 0?`for attribute '${u}' `:""}should be strings`,path:u,payload:{received:i}})}let m=a!==void 0?new E(t).start(a,{fill:!1,transform:r,parseExtension:Pe,valuePath:[...o,1]}):void 0,p={[Ge]:[i,...m!==void 0?[m.next().value]:[]]};if(r)yield p;else return p;return{[Ge]:[i,...m!==void 0?[m.next().value]:[]]}}};function*cu(t,e,{transform:r=!0,valuePath:n}){if(et(e)){let s=e;if(r)yield s;else return s;return s}if(e===void 0){if(r)yield void 0;else return;return void 0}return yield*new E(t.elements).start(e,{mode:"update",fill:!1,transform:r,parseExtension:tt,valuePath:n})}var tm=(t,e,{transform:r=!0,valuePath:n})=>{if(Ot(e)&&e[M]!==void 0)return{isExtension:!0,*extensionParser(){let s=new E(t).start(e[M],{fill:!1,transform:r,valuePath:[...n??[],"$SET"]}),o={[M]:s.next().value};if(r)yield o;else return o;return{[M]:s.next().value}}};if(S(e)||X(e)){if(tr(e)&&e[be]!==void 0){let s=e[be],o=[...n??[],"$APPEND"];return X(s)?{isExtension:!0,*extensionParser(){let i=s.map((p,c)=>new E(t.elements).start(p,{fill:!1,transform:r,valuePath:[...o,c]})),a={[be]:i.map(p=>p.next().value)};if(r)yield a;else return a;return{[be]:i.map(p=>p.next().value)}}}:{isExtension:!0,*extensionParser(){let i=new E(t).start(s,{fill:!1,transform:r,parseExtension:Pe,valuePath:o}),a={[be]:i.next().value};if(r)yield a;else return a;return{[be]:i.next().value}}}}if(rr(e)&&e[xe]!==void 0){let s=e[xe],o=[...n??[],"$PREPEND"];return X(s)?{isExtension:!0,*extensionParser(){let i=s.map((p,c)=>new E(t.elements).start(p,{fill:!1,transform:r,valuePath:[...o,c]})),a={[xe]:i.map(p=>p.next().value)};if(r)yield a;else return a;return{[xe]:i.map(p=>p.next().value)}}}:{isExtension:!0,*extensionParser(){let i=new E(t).start(s,{fill:!1,transform:r,parseExtension:Pe,valuePath:o}),a={[xe]:i.next().value};if(r)yield a;else return a;return{[xe]:i.next().value}}}}return{isExtension:!0,*extensionParser(){let s=0,o=Object.fromEntries(Object.entries(e).map(([m,p])=>[m,cu(t,p,{transform:r,valuePath:[...n??[],m]})]));for(let m of Object.keys(o)){let p=parseFloat(m),c=n!==void 0?P(n):void 0;if(!Ke(p))throw new d("parsing.invalidAttributeInput",{message:`Index of array attribute ${c!==void 0?`'${c}' `:""}is not a valid integer`,path:c,payload:{received:m}});s=Math.max(s,p)}let i=Object.fromEntries(Object.entries(o).map(([m,p])=>[m,p.next().value]).filter(([,m])=>m!==void 0));if(r)yield i;else return i;return[...Array(s+1).keys()].map(m=>{let p=o[m];return p===void 0?void 0:p.next().value})}}}return{isExtension:!1,unextendedInput:e}};var rm=(t,e,{transform:r=!0,valuePath:n}={})=>Ot(e)&&e[M]!==void 0?{isExtension:!0,*extensionParser(){let s=new E(t).start(e[M],{fill:!1,transform:r,valuePath:[...n??[],"$SET"]}),o={[M]:s.next().value};if(r)yield o;else return o;return{[M]:s.next().value}}}:{isExtension:!1,unextendedInput:e};var As=(t,e,{transform:r=!0,valuePath:n}={})=>{let{props:s}=t;if(en(e)&&e[ut]!==void 0)return{isExtension:!0,*extensionParser(){let o=e[ut],i=[...n??[],"$SUM"];if(!X(o)||o.length!==2){let f=P(i);throw new d("parsing.invalidAttributeInput",{message:`Sum for number attribute ${f!==void 0?`'${f}' `:""}should be a tuple of length 2`,path:f,payload:{received:e[ut]}})}let[a,m]=o,p=[new E(new K({big:s.big})).start(a,{fill:!1,transform:r,parseExtension:Pe,valuePath:[...i,0]}),new E(new K({big:s.big})).start(m,{fill:!1,transform:r,parseExtension:Pe,valuePath:[...i,1]})],c={[ut]:p.map(f=>f.next().value)};if(r)yield c;else return c;return{[ut]:p.map(f=>f.next().value)}}};if(_r(e)&&e[pt]!==void 0)return{isExtension:!0,*extensionParser(){let o=e[pt],i=[...n??[],"$SUBTRACT"];if(!X(o)||o.length!==2){let f=P(i);throw new d("parsing.invalidAttributeInput",{message:`Subtraction for number attribute ${f!==void 0?`'${f}' `:""}should be a tuple of length 2`,path:f,payload:{received:e[pt]}})}let[a,m]=o,p=[new E(new K({big:s.big})).start(a,{fill:!1,transform:r,parseExtension:Pe,valuePath:[...i,0]}),new E(new K({big:s.big})).start(m,{fill:!1,transform:r,parseExtension:Pe,valuePath:[...i,1]})],c={[pt]:p.map(f=>f.next().value)};if(r)yield c;else return c;return{[pt]:p.map(f=>f.next().value)}}};if(er(e)&&e[Re]!==void 0){let o=new E(new K({big:s.big})).start(e[Re],{fill:!1,transform:r,parseExtension:Pe,valuePath:[...n??[],"$ADD"]});return{isExtension:!0,*extensionParser(){let i={[Re]:o.next().value};if(r)yield i;else return i;return{[Re]:o.next().value}}}}return{isExtension:!1,unextendedInput:e}};function*du(t,e,{transform:r=!0,valuePath:n}={}){if(et(e)){let s=e;if(r)yield s;else return s;return s}return yield*new E(t.elements).start(e,{mode:"update",fill:!1,transform:r,parseExtension:tt,valuePath:n})}var nm=(t,e,{transform:r=!0,valuePath:n}={})=>Ot(e)&&e[M]!==void 0?{isExtension:!0,*extensionParser(){let s=new E(t).start(e[M],{fill:!1,transform:r,valuePath:[...n??[],"$SET"]}),o={[M]:s.next().value};if(r)yield o;else return o;return{[M]:s.next().value}}}:S(e)?{isExtension:!0,*extensionParser(){let s=Object.entries(e).filter(([,a])=>a!==void 0).map(([a,m])=>[new E(t.keys).start(a,{fill:!1,transform:r}),du(t,m,{transform:r,valuePath:[...n??[],a]})]),o=Object.fromEntries(s.map(([a,m])=>[a.next().value,m.next().value]).filter(([,a])=>a!==void 0));if(r)yield o;else return o;return Object.fromEntries(s.map(([a,m])=>[a.next().value,m.next().value]).filter(([,a])=>a!==void 0))}}:{isExtension:!1,unextendedInput:e};var ks=(t,e,{transform:r=!0,valuePath:n}={})=>er(e)&&e[Re]!==void 0?{isExtension:!0,*extensionParser(){let s=new E(t).start(e[Re],{fill:!1,transform:r,valuePath:[...n??[],"$ADD"]}),o={[Re]:s.next().value};if(r)yield o;else return o;return{[Re]:s.next().value}}}:Zr(e)&&e[St]!==void 0?{isExtension:!0,*extensionParser(){let s=new E(t).start(e[St],{fill:!1,transform:r,valuePath:[...n??[],"$DELETE"]}),o={[St]:s.next().value};if(r)yield o;else return o;return{[St]:s.next().value}}}:{isExtension:!1,unextendedInput:e};var tt=(t,e,r={})=>{let{transform:n=!0,valuePath:s}=r;if(et(e))return{isExtension:!0,*extensionParser(){let{props:o}=t,{required:i}=o,a=s!==void 0?P(s):void 0;if(i!=="never")throw new d("parsing.attributeRequired",{message:`Attribute ${a!==void 0?`'${a}' `:""}is required and cannot be removed`,path:a});let m=e;if(n)yield m;else return m;return e}};if(Ze(e))return Pe(t,e,r);switch(t.type){case"number":return As(t,e,r);case"set":return ks(t,e,r);case"list":return tm(t,e,r);case"map":return rm(t,e,r);case"record":return nm(t,e,r);default:return{isExtension:!1,unextendedInput:e}}};var sm=new Set(["NONE","ALL_OLD","UPDATED_OLD","ALL_NEW","UPDATED_NEW"]);var om=(t,e)=>{let r={},{capacity:n,metrics:s,returnValues:o,returnValuesOnConditionFalse:i,condition:a,tableName:m,...p}=e;if(B(p),n!==void 0&&(r.ReturnConsumedCapacity=oe(n)),s!==void 0&&(r.ReturnItemCollectionMetrics=_e(s)),o!==void 0&&(r.ReturnValues=Zt(sm,o)),i!==void 0&&(r.ReturnValuesOnConditionCheckFailure=Ie(i)),a!==void 0){let{ExpressionAttributeNames:c,ExpressionAttributeValues:u,ConditionExpression:f}=t.build(Q).parse(a);r.ExpressionAttributeNames=c,r.ExpressionAttributeValues=u,r.ConditionExpression=f}return m!==void 0&&H(m),r};var xo=(t,e,r={})=>{var n;let{parsedItem:s,item:o,key:i}=t.build(F).parse(e,{mode:"update",parseExtension:tt}),{ExpressionAttributeNames:a,ExpressionAttributeValues:m,...p}=Sr(t,Yr(o,...Object.keys(i))),{ExpressionAttributeNames:c,ExpressionAttributeValues:u,...f}=om(t,r),l={...c,...a},y={...u,...m};return{TableName:(n=r.tableName)!==null&&n!==void 0?n:t.table.getName(),ToolboxItem:s,Key:i,...p,...f,...N(l)?{}:{ExpressionAttributeNames:l},...N(y)?{}:{ExpressionAttributeValues:y}}};var lu=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},nr=class t extends I{constructor(e,r,n={}){super(e),this[Rn]=r,this[qn]=n}item(e){return new t(this.entity,e,this[qn])}options(e){return new t(this.entity,this[Rn],e)}[Te](){if(!this[Rn])throw new d("actions.incompleteAction",{message:'UpdateItemCommand incomplete: Missing "item" property'});return[this[Rn],this[qn]]}params(){let[e,r]=this[Te]();return xo(this.entity,e,r)}async send(e){let{ToolboxItem:r,...n}=this.params(),s=await this.entity.table.getDocumentClient().send(new im.UpdateCommand(n),e),{Attributes:o,...i}=s;if(o===void 0)return{ToolboxItem:r,...i};let{returnValues:a}=this[qn],m=new _(this.entity).format(o,{partial:a==="UPDATED_NEW"||a==="UPDATED_OLD"});return{ToolboxItem:r,Attributes:m,...i}}};nr.actionName="updateItem";lu([gt()],nr.prototype,"send",null);var lm=require("@aws-sdk/lib-dynamodb");var Ln=Symbol("$item"),Bn=Symbol("$options");var am=(t,e,{transform:r=!0,valuePath:n}={})=>S(e)||X(e)?{isExtension:!0,*extensionParser(){let s=new E(t).start(e,{fill:!1,transform:r,valuePath:n}),o={[M]:s.next().value};if(r)yield o;else return o;return{[M]:s.next().value}}}:{isExtension:!1,unextendedInput:e};var mm=(t,e,r)=>{let{transform:n=!0,valuePath:s}=r;if(S(e)){if(tr(e)&&e[be]!==void 0){let o=e[be],i=[...s??[],"$APPEND"];return X(o)?{isExtension:!0,*extensionParser(){let a=o.map((c,u)=>new E(t.elements).start(c,{fill:!1,transform:n,valuePath:[...i,u]})),m={[be]:a.map(c=>c.next().value)};if(n)yield m;else return m;return{[be]:a.map(c=>c.next().value)}}}:{isExtension:!0,*extensionParser(){let a=new E(t).start(o,{fill:!1,transform:n,parseExtension:Pe,valuePath:i}),m={[be]:a.next().value};if(n)yield m;else return m;return{[be]:a.next().value}}}}if(rr(e)&&e[xe]!==void 0){let o=e[xe],i=[...s??[],"$PREPEND"];return X(o)?{isExtension:!0,*extensionParser(){let a=o.map((c,u)=>new E(t.elements).start(c,{fill:!1,transform:n,valuePath:[...i,u]})),m={[xe]:a.map(c=>c.next().value)};if(n)yield m;else return m;return{[xe]:a.map(c=>c.next().value)}}}:{isExtension:!0,*extensionParser(){let a=new E(t).start(o,{fill:!1,transform:n,parseExtension:Pe,valuePath:i}),m={[xe]:a.next().value};if(n)yield m;else return m;return{[xe]:a.next().value}}}}}return X(e)?{isExtension:!0,*extensionParser(){let o=new E(t).start(e,{fill:!1,transform:n,valuePath:s}),i={[M]:o.next().value};if(n)yield i;else return i;return{[M]:o.next().value}}}:{isExtension:!1,unextendedInput:e}};var pm=(t,e,{transform:r=!0,valuePath:n}={})=>S(e)?{isExtension:!0,*extensionParser(){let s=new E(t).start(e,{fill:!1,transform:r,valuePath:n}),o={[M]:s.next().value};if(r)yield o;else return o;return{[M]:s.next().value}}}:{isExtension:!1,unextendedInput:e};var um=(t,e,{transform:r=!0,valuePath:n}={})=>S(e)?{isExtension:!0,*extensionParser(){let s=new E(t).start(e,{fill:!1,transform:r,valuePath:n}),o={[M]:s.next().value};if(r)yield o;else return o;return{[M]:s.next().value}}}:{isExtension:!1,unextendedInput:e};var tn=(t,e,r={})=>{let{transform:n=!0,valuePath:s}=r;if(et(e))return{isExtension:!0,*extensionParser(){let{props:o}=t,{required:i}=o,a=s!==void 0?P(s):void 0;if(i!=="never")throw new d("parsing.attributeRequired",{message:`Attribute ${a!==void 0?`'${a}' `:""}is required and cannot be removed`,path:a});let m=e;if(n)yield m;else return m;return e}};if(Ze(e)&&e[Ge]!==void 0)return Pe(t,e,r);switch(t.type){case"any":return am(t,e,r);case"number":return As(t,e,r);case"set":return ks(t,e,r);case"list":return mm(t,e,r);case"map":return pm(t,e,r);case"record":return um(t,e,r);default:return{isExtension:!1,unextendedInput:e}}};var cm=new Set(["NONE","ALL_OLD","UPDATED_OLD","ALL_NEW","UPDATED_NEW"]);var dm=(t,e)=>{let r={},{capacity:n,metrics:s,returnValues:o,returnValuesOnConditionFalse:i,condition:a,tableName:m,...p}=e;if(B(p),n!==void 0&&(r.ReturnConsumedCapacity=oe(n)),s!==void 0&&(r.ReturnItemCollectionMetrics=_e(s)),o!==void 0&&(r.ReturnValues=Zt(cm,o)),i!==void 0&&(r.ReturnValuesOnConditionCheckFailure=Ie(i)),a!==void 0){let{ExpressionAttributeNames:c,ExpressionAttributeValues:u,ConditionExpression:f}=t.build(Q).parse(a);r.ExpressionAttributeNames=c,r.ExpressionAttributeValues=u,r.ConditionExpression=f}return m!==void 0&&H(m),r};var wo=(t,e,r={})=>{var n;let{parsedItem:s,item:o,key:i}=t.build(F).parse(e,{mode:"update",parseExtension:tn}),{ExpressionAttributeNames:a,ExpressionAttributeValues:m,...p}=Sr(t,Yr(o,...Object.keys(i))),{ExpressionAttributeNames:c,ExpressionAttributeValues:u,...f}=dm(t,r),l={...c,...a},y={...u,...m};return{TableName:(n=r.tableName)!==null&&n!==void 0?n:t.table.getName(),ToolboxItem:s,Key:i,...p,...f,...N(l)?{}:{ExpressionAttributeNames:l},...N(y)?{}:{ExpressionAttributeValues:y}}};var fu=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},sr=class t extends I{constructor(e,r,n={}){super(e),this[Ln]=r,this[Bn]=n}item(e){return new t(this.entity,e,this[Bn])}options(e){return new t(this.entity,this[Ln],e)}[Te](){if(!this[Ln])throw new d("actions.incompleteAction",{message:'UpdateAttributesCommand incomplete: Missing "item" property'});return[this[Ln],this[Bn]]}params(){let[e,r]=this[Te]();return wo(this.entity,e,r)}async send(e){let{ToolboxItem:r,...n}=this.params(),s=await this.entity.table.getDocumentClient().send(new lm.UpdateCommand(n),e),{Attributes:o,...i}=s;if(o===void 0)return{ToolboxItem:r,...i};let{returnValues:a}=this[Bn],m=new _(this.entity).format(o,{partial:a==="UPDATED_NEW"||a==="UPDATED_OLD"});return{ToolboxItem:r,Attributes:m,...i}}};sr.actionName="updateAttributes";fu([gt()],sr.prototype,"send",null);var hm=require("@aws-sdk/lib-dynamodb");var Fn=Symbol("$key"),rn=Symbol("$options");var fm=(t,e)=>{let r={},{attributes:n,tableName:s,...o}=e;if(B(o),n!==void 0){let{ExpressionAttributeNames:i,ProjectionExpression:a}=t.build(ye).parse(n);N(i)||(r.ExpressionAttributeNames=i),r.ProjectionExpression=a}return s!==void 0&&H(s),r};var vt=class t extends I{constructor(e,r,n={}){super(e),this[Fn]=r,this[rn]=n}key(e){return new t(this.entity,e,this[rn])}options(e){return new t(this.entity,this[Fn],e)}params(){var e;if(!this[Fn])throw new d("actions.incompleteAction",{message:'GetTransaction incomplete: Missing "key" property'});let r=this[rn],{key:n}=this.entity.build(F).parse(this[Fn],{mode:"key"}),s=fm(this.entity,r);return{Get:{TableName:(e=r.tableName)!==null&&e!==void 0?e:this.entity.table.getName(),Key:n,...s}}}};vt.actionName="transactGet";var hu=(t,...e)=>t.map(({Item:r},n)=>{let s=e[n],o=s.entity,{attributes:i}=s[rn];return{Item:r?new _(o).format(r,i?{attributes:i}:{}):void 0}}),Ps=async(...t)=>{let[e={},...r]=t,n=r,s={};e instanceof vt?n.unshift(e):s=e;let o=n[0];if(o===void 0)throw new d("actions.incompleteAction",{message:"transactGet incomplete: No GetTransaction supplied"});let{documentClient:i,capacity:a,...m}=s,p=i??o.entity.table.getDocumentClient(),{Responses:c,...u}=await p.send(new hm.TransactGetCommand(yu(n,{capacity:a})),m);return c===void 0?u:{...u,Responses:hu(c,...n)}},yu=(t,e={})=>{let{capacity:r,...n}=e;return B(n),{TransactItems:t.map(s=>s.params()),...r!==void 0?{ReturnConsumedCapacity:oe(r)}:{}}};var xm=require("@aws-sdk/lib-dynamodb");var ym=t=>{if(!U(t))throw new d("options.invalidClientRequestToken",{message:`Invalid client request token option: '${String(t)}'. 'clientRequestToken' must be a string.`,payload:{clientRequestToken:t}});return t};var ct=class extends I{},bm=t=>t instanceof ct;var $s=async(...t)=>{let[e={},...r]=t,n=r,s={};bm(e)?n.unshift(e):s=e;let o=n[0];if(o===void 0)throw new d("actions.incompleteAction",{message:"Cannot execute WriteTransactions: No transaction supplied"});let{documentClient:i,capacity:a,metrics:m,clientRequestToken:p,...c}=s,u=i??o.entity.table.getDocumentClient(),{TransactItems:f=[],...l}=xu(n,{capacity:a,metrics:m,clientRequestToken:p}),y=[];for(let b of f){let{ToolboxItem:O}=b;y.push(O),delete b.ToolboxItem}let x=await u.send(new xm.TransactWriteCommand({TransactItems:f,...l}),c);return{ToolboxItems:y,...x}},bu=t=>{let e={},{clientRequestToken:r,capacity:n,metrics:s,...o}=t;return B(o),r!==void 0&&(e.ClientRequestToken=ym(r)),n!==void 0&&(e.ReturnConsumedCapacity=oe(n)),s!==void 0&&(e.ReturnItemCollectionMetrics=_e(s)),e},xu=(t,e={})=>({...bu(e),TransactItems:t.map(r=>r.params())});var Mn=Symbol("$item"),Ds=Symbol("$options");var wm=(t,e)=>{let r={},{condition:n,returnValuesOnConditionFalse:s,tableName:o,...i}=e;if(B(i),n!==void 0){let{ExpressionAttributeNames:a,ExpressionAttributeValues:m,ConditionExpression:p}=t.build(Q).parse(n);N(a)||(r.ExpressionAttributeNames=a),N(m)||(r.ExpressionAttributeValues=m),r.ConditionExpression=p}return s!==void 0&&(r.ReturnValuesOnConditionCheckFailure=Ie(s)),o!==void 0&&H(o),r};var Or=class t extends ct{constructor(e,r,n={}){super(e),this[Mn]=r,this[Ds]=n}item(e){return new t(this.entity,e,this[Ds])}options(e){return new t(this.entity,this[Mn],e)}params(){var e;if(!this[Mn])throw new d("actions.incompleteAction",{message:'PutTransaction incomplete: Missing "item" property'});let r=this[Ds],{parsedItem:n,item:s}=this.entity.build(F).parse(this[Mn]),o=wm(this.entity,r);return{ToolboxItem:n,Put:{TableName:(e=r?.tableName)!==null&&e!==void 0?e:this.entity.table.getName(),Item:s,...o}}}};Or.actionName="transactPut";var Un=Symbol("$item"),Cs=Symbol("$options");var Em=(t,e)=>{let r={},{condition:n,returnValuesOnConditionFalse:s,tableName:o,...i}=e;if(B(i),n!==void 0){let{ExpressionAttributeNames:a,ExpressionAttributeValues:m,ConditionExpression:p}=t.build(Q).parse(n);r.ExpressionAttributeNames=a,r.ExpressionAttributeValues=m,r.ConditionExpression=p}return s!==void 0&&(r.ReturnValuesOnConditionCheckFailure=Ie(s)),o!==void 0&&H(o),r};var vr=class t extends ct{constructor(e,r,n={}){super(e),this[Un]=r,this[Cs]=n}item(e){return new t(this.entity,e,this[Cs])}options(e){return new t(this.entity,this[Un],e)}params(){var e;if(!this[Un])throw new d("actions.incompleteAction",{message:'UpdateTransaction incomplete: Missing "item" property'});let{parsedItem:r,item:n,key:s}=this.entity.build(F).parse(this[Un],{mode:"update",parseExtension:tt}),{ExpressionAttributeNames:o,ExpressionAttributeValues:i,UpdateExpression:a}=Sr(this.entity,Yr(n,...Object.keys(s))),m=this[Cs],{ExpressionAttributeNames:p,ExpressionAttributeValues:c,...u}=Em(this.entity,m),f={...p,...o},l={...c,...i};return{ToolboxItem:r,Update:{TableName:(e=m.tableName)!==null&&e!==void 0?e:this.entity.table.getName(),Key:s,UpdateExpression:a,...u,...N(f)?{}:{ExpressionAttributeNames:f},...N(l)?{}:{ExpressionAttributeValues:l}}}}};vr.actionName="transactUpdate";var zn=Symbol("$key"),Ts=Symbol("$options");var gm=(t,e)=>{let r={},{condition:n,returnValuesOnConditionFalse:s,tableName:o,...i}=e;if(B(i),n!==void 0){let{ExpressionAttributeNames:a,ExpressionAttributeValues:m,ConditionExpression:p}=t.build(Q).parse(n);N(a)||(r.ExpressionAttributeNames=a),N(m)||(r.ExpressionAttributeValues=m),r.ConditionExpression=p}return s!==void 0&&(r.ReturnValuesOnConditionCheckFailure=Ie(s)),o!==void 0&&H(o),r};var Ar=class t extends ct{constructor(e,r,n={}){super(e),this[zn]=r,this[Ts]=n}key(e){return new t(this.entity,e,this[Ts])}options(e){return new t(this.entity,this[zn],e)}params(){var e;if(!this[zn])throw new d("actions.incompleteAction",{message:'DeleteTransaction incomplete: Missing "key" property'});let r=this[Ts],{key:n}=this.entity.build(F).parse(this[zn],{mode:"key"}),s=gm(this.entity,r);return{Delete:{TableName:(e=r.tableName)!==null&&e!==void 0?e:this.entity.table.getName(),Key:n,...s}}}};Ar.actionName="transactDelete";var nn=Symbol("$key"),sn=Symbol("$condition"),Kn=Symbol("$options");var Sm=(t,e,r={})=>{let{returnValuesOnConditionFalse:n,tableName:s,...o}=r;B(o);let{ExpressionAttributeNames:i,ExpressionAttributeValues:a,ConditionExpression:m}=t.build(Q).parse(e),p={ConditionExpression:m};return N(i)||(p.ExpressionAttributeNames=i),N(a)||(p.ExpressionAttributeValues=a),n!==void 0&&(p.ReturnValuesOnConditionCheckFailure=Ie(n)),s!==void 0&&H(s),p};var kr=class t extends ct{constructor(e,r,n,s={}){super(e),this[nn]=r,this[sn]=n,this[Kn]=s}key(e){return new t(this.entity,e,this[sn],this[Kn])}condition(e){return new t(this.entity,this[nn],e,this[Kn])}options(e){return new t(this.entity,this[nn],this[sn],e)}params(){var e;if(!this[nn])throw new d("actions.incompleteAction",{message:'ConditionCheck incomplete: Missing "key" property'});if(!this[sn])throw new d("actions.incompleteAction",{message:'ConditionCheck incomplete: Missing "condition" property'});let r=this[Kn],{key:n}=this.entity.build(F).parse(this[nn],{mode:"key"}),s=Sm(this.entity,this[sn],r);return{ConditionCheck:{TableName:(e=r.tableName)!==null&&e!==void 0?e:this.entity.table.getName(),Key:n,...s}}}};kr.actionName="conditionCheck";var on=Symbol("$schema"),an=Symbol("$pattern"),mn=Symbol("$options"),Gn=Symbol("$meta");var pn=class extends I{constructor(e,r,n,s={},o={}){super(e),this[on]=r,this[an]=n,this[mn]=s,this[Gn]=o}query(e){let r=this[on];if(r===void 0)throw new d("actions.incompleteAction",{message:'AccessPattern incomplete: Missing "schema" property'});let n=this[an];if(n===void 0)throw new d("actions.incompleteAction",{message:'AccessPattern incomplete: Missing "pattern" property'});let o=new E(r).parse(e),i=n(o),a=this[mn];return new pe(this.entity.table,[this.entity],i,a)}};pn.actionName="access-pattern";var un=class t extends pn{constructor(e,r,n,s={},o={}){super(e,r,n,s,o)}schema(e){return new t(this.entity,e,this[an],this[mn],this[Gn])}pattern(e){return new t(this.entity,this[on],e,this[mn],this[Gn])}options(e){return new t(this.entity,this[on],this[an],e,this[Gn])}meta(e){return new t(this.entity,this[on],this[an],this[mn],e)}};var Om=Symbol("$actionName"),vm=Symbol("$sentActions"),Am=Symbol("$spy"),km=Symbol("$mocks");var Wn=class extends I{async put(e,r={}){return new mt(this.entity,e,r).send()}async get(e,r={}){return new at(this.entity,e,r).send()}async update(e,r={}){return new nr(this.entity,e,r).send()}async updateAttributes(e,r={}){return new sr(this.entity,e,r).send()}async delete(e,r={}){return new _t(this.entity,e,r).send()}async scan(e={}){return new Et(this.entity.table,[this.entity],e).send()}async query(e,r={}){return new pe(this.entity.table,[this.entity],e,r).send()}batchGet(e){return new qt(this.entity,e)}batchPut(e){return new Lt(this.entity,e)}batchDelete(e){return new ot(this.entity,e)}static executeTransactGet(...e){return Ps(...e)}transactGet(e,r={}){return new vt(this.entity,e,r)}static executeTransactWrite(...e){return $s(...e)}transactPut(e,r={}){return new Or(this.entity,e,r)}transactUpdate(e,r={}){return new vr(this.entity,e,r)}transactDelete(e,r={}){return new Ar(this.entity,e,r)}transactCheck(e,r,n={}){return new kr(this.entity,e,r,n)}accessPattern(e,r,n={}){return new un(this.entity,e,r,n)}parse(e,r={}){return new F(this.entity).parse(e,r)}parseCondition(e,r={}){return new Q(this.entity).parse(e,r)}parsePaths(e,r={}){return new ye(this.entity).parse(e,r)}format(e,r={}){return new _(this.entity).format(e,r)}};Wn.actionName="repository";var cn=class extends I{constructor(e){super(e);let r=new Jt(new Qe(this.entity.attributes)),{partitionKey:n,sortKey:s}=this.entity.table;Object.entries(r.attributes).find(([i,a])=>{var m;return((m=a.savedAs)!==null&&m!==void 0?m:i)===n.name})===void 0&&(r.attributes[n.name]={type:n.type,key:!0,required:"always",hidden:!0}),s!==void 0&&Object.entries(r.attributes).find(([a,m])=>{var p;return((p=m.savedAs)!==null&&p!==void 0?p:a)===s.name})===void 0&&(r.attributes[s.name]={type:s.type,key:!0,required:"always",hidden:!0}),this.entityName=this.entity.entityName,this.schema=r,this.entityAttribute=this.entity.entityAttribute,this.timestamps=this.entity.timestamps,this.table=this.entity.table.build(Yt)}toJSON(){return{entityName:this.entityName,schema:this.schema.toJSON(),entityAttribute:this.entity.entityAttribute,timestamps:this.entity.timestamps,table:this.table.toJSON()}}};cn.actionName="dto";var $m=require("@aws-sdk/client-dynamodb"),Dm=require("@aws-sdk/lib-dynamodb");var Eu=Dm.DynamoDBDocumentClient.from(new $m.DynamoDBClient),rt=new fr({name:process.env.TABLE_NAME,partitionKey:{name:"userId",type:"string"},sortKey:{name:"timestamp",type:"string"},documentClient:Eu,indexes:{"status-time-index":{type:"global",partitionKey:{name:"status",type:"string"},sortKey:{name:"time",type:"number"}}}});var Cm=new jt({name:"Game",schema:Dt({userId:he().key(),timestamp:he().key(),bombsExploded:G().optional(),cellsRevealed:G().optional(),date:he().optional(),gameRestarts:G().optional(),lastUpdated:he().optional(),noFlagWin:Lr().optional(),rawUserId:he().optional(),time:G().optional(),timePlayed:G().optional(),usedFlags:G().optional(),status:he().optional(),userName:he().optional(),userImage:he().optional(),ttl:G()}),table:rt});var Ns=new jt({name:"UserStats",schema:Dt({userId:he().key(),timestamp:he().key(),fastestWin:G().optional(),gamesAbandoned:G().optional(),gamesLost:G().optional(),gamesPlayed:G().optional(),gamesRestarted:G().optional(),gamesWon:G().optional(),noFlagWins:G().optional(),totalBombsExploded:G().optional(),totalCellsRevealed:G().optional(),totalFlagsPlaced:G().optional(),totalGameRestarts:G().optional(),totalTimePlayed:G().optional(),totalWinTime:G().optional(),userName:he().optional(),userImage:he().optional(),status:he().optional(),time:G().optional(),ttl:G()}),table:rt});var Eo=(t,e,r)=>(n,s)=>{let o=-1;return i(0);async function i(a){if(a<=o)throw new Error("next() called multiple times");o=a;let m,p=!1,c;if(t[a]?(c=t[a][0][0],n.req.routeIndex=a):c=a===t.length&&s||void 0,c)try{m=await c(n,()=>i(a+1))}catch(u){if(u instanceof Error&&e)n.error=u,m=await e(u,n),p=!0;else throw u}else n.finalized===!1&&r&&(m=await r(n));return m&&(n.finalized===!1||p)&&(n.res=m),n}};var Tm=async(t,e=Object.create(null))=>{let{all:r=!1,dot:n=!1}=e,o=(t instanceof Is?t.raw.headers:t.headers).get("Content-Type");return o?.startsWith("multipart/form-data")||o?.startsWith("application/x-www-form-urlencoded")?gu(t,{all:r,dot:n}):{}};async function gu(t,e){let r=await t.formData();return r?Su(r,e):{}}function Su(t,e){let r=Object.create(null);return t.forEach((n,s)=>{e.all||s.endsWith("[]")?Ou(r,s,n):r[s]=n}),e.dot&&Object.entries(r).forEach(([n,s])=>{n.includes(".")&&(vu(r,n,s),delete r[n])}),r}var Ou=(t,e,r)=>{t[e]!==void 0?Array.isArray(t[e])?t[e].push(r):t[e]=[t[e],r]:t[e]=r},vu=(t,e,r)=>{let n=t,s=e.split(".");s.forEach((o,i)=>{i===s.length-1?n[o]=r:((!n[o]||typeof n[o]!="object"||Array.isArray(n[o])||n[o]instanceof File)&&(n[o]=Object.create(null)),n=n[o])})};var So=t=>{let e=t.split("/");return e[0]===""&&e.shift(),e},Nm=t=>{let{groups:e,path:r}=Au(t),n=So(r);return ku(n,e)},Au=t=>{let e=[];return t=t.replace(/\{[^}]+\}/g,(r,n)=>{let s=`@${n}`;return e.push([s,r]),s}),{groups:e,path:t}},ku=(t,e)=>{for(let r=e.length-1;r>=0;r--){let[n]=e[r];for(let s=t.length-1;s>=0;s--)if(t[s].includes(n)){t[s]=t[s].replace(n,e[r][1]);break}}return t},Vs={},Oo=(t,e)=>{if(t==="*")return"*";let r=t.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){let n=`${t}#${e}`;return Vs[n]||(r[2]?Vs[n]=e&&e[0]!==":"&&e[0]!=="*"?[n,r[1],new RegExp(`^${r[2]}(?=/${e})`)]:[t,r[1],new RegExp(`^${r[2]}$`)]:Vs[n]=[t,r[1],!0]),Vs[n]}return null},vo=(t,e)=>{try{return e(t)}catch{return t.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return e(r)}catch{return r}})}},Pu=t=>vo(t,decodeURI),Ao=t=>{let e=t.url,r=e.indexOf("/",8),n=r;for(;n<e.length;n++){let s=e.charCodeAt(n);if(s===37){let o=e.indexOf("?",n),i=e.slice(r,o===-1?void 0:o);return Pu(i.includes("%25")?i.replace(/%25/g,"%2525"):i)}else if(s===63)break}return e.slice(r,n)};var Im=t=>{let e=Ao(t);return e.length>1&&e.at(-1)==="/"?e.slice(0,-1):e},Pr=(t,e,...r)=>(r.length&&(e=Pr(e,...r)),`${t?.[0]==="/"?"":"/"}${t}${e==="/"?"":`${t?.at(-1)==="/"?"":"/"}${e?.[0]==="/"?e.slice(1):e}`}`),js=t=>{if(t.charCodeAt(t.length-1)!==63||!t.includes(":"))return null;let e=t.split("/"),r=[],n="";return e.forEach(s=>{if(s!==""&&!/\:/.test(s))n+="/"+s;else if(/\:/.test(s))if(/\?/.test(s)){r.length===0&&n===""?r.push("/"):r.push(n);let o=s.replace("?","");n+="/"+o,r.push(n)}else n+="/"+s}),r.filter((s,o,i)=>i.indexOf(s)===o)},go=t=>/[%+]/.test(t)?(t.indexOf("+")!==-1&&(t=t.replace(/\+/g," ")),t.indexOf("%")!==-1?ko(t):t):t,Vm=(t,e,r)=>{let n;if(!r&&e&&!/[%+]/.test(e)){let i=t.indexOf(`?${e}`,8);for(i===-1&&(i=t.indexOf(`&${e}`,8));i!==-1;){let a=t.charCodeAt(i+e.length+1);if(a===61){let m=i+e.length+2,p=t.indexOf("&",m);return go(t.slice(m,p===-1?void 0:p))}else if(a==38||isNaN(a))return"";i=t.indexOf(`&${e}`,i+1)}if(n=/[%+]/.test(t),!n)return}let s={};n??(n=/[%+]/.test(t));let o=t.indexOf("?",8);for(;o!==-1;){let i=t.indexOf("&",o+1),a=t.indexOf("=",o);a>i&&i!==-1&&(a=-1);let m=t.slice(o+1,a===-1?i===-1?void 0:i:a);if(n&&(m=go(m)),o=i,m==="")continue;let p;a===-1?p="":(p=t.slice(a+1,i===-1?void 0:i),n&&(p=go(p))),r?(s[m]&&Array.isArray(s[m])||(s[m]=[]),s[m].push(p)):s[m]??(s[m]=p)}return e?s[e]:s},jm=Vm,Rm=(t,e)=>Vm(t,e,!0),ko=decodeURIComponent;var qm=t=>vo(t,ko),dn,dt,Bt,Bm,Fm,Po,or,Lm,Is=(Lm=class{constructor(t,e="/",r=[[]]){k(this,Bt);A(this,"raw");k(this,dn);k(this,dt);A(this,"routeIndex",0);A(this,"path");A(this,"bodyCache",{});k(this,or,t=>{let{bodyCache:e,raw:r}=this,n=e[t];if(n)return n;let s=Object.keys(e)[0];return s?e[s].then(o=>(s==="json"&&(o=JSON.stringify(o)),new Response(o)[t]())):e[t]=r[t]()});this.raw=t,this.path=e,g(this,dt,r),g(this,dn,{})}param(t){return t?T(this,Bt,Bm).call(this,t):T(this,Bt,Fm).call(this)}query(t){return jm(this.url,t)}queries(t){return Rm(this.url,t)}header(t){if(t)return this.raw.headers.get(t)??void 0;let e={};return this.raw.headers.forEach((r,n)=>{e[n]=r}),e}async parseBody(t){var e;return(e=this.bodyCache).parsedBody??(e.parsedBody=await Tm(this,t))}json(){return h(this,or).call(this,"json")}text(){return h(this,or).call(this,"text")}arrayBuffer(){return h(this,or).call(this,"arrayBuffer")}blob(){return h(this,or).call(this,"blob")}formData(){return h(this,or).call(this,"formData")}addValidatedData(t,e){h(this,dn)[t]=e}valid(t){return h(this,dn)[t]}get url(){return this.raw.url}get method(){return this.raw.method}get matchedRoutes(){return h(this,dt)[0].map(([[,t]])=>t)}get routePath(){return h(this,dt)[0].map(([[,t]])=>t)[this.routeIndex].path}},dn=new WeakMap,dt=new WeakMap,Bt=new WeakSet,Bm=function(t){let e=h(this,dt)[0][this.routeIndex][1][t],r=T(this,Bt,Po).call(this,e);return r?/\%/.test(r)?qm(r):r:void 0},Fm=function(){let t={},e=Object.keys(h(this,dt)[0][this.routeIndex][1]);for(let r of e){let n=T(this,Bt,Po).call(this,h(this,dt)[0][this.routeIndex][1][r]);n&&typeof n=="string"&&(t[r]=/\%/.test(n)?qm(n):n)}return t},Po=function(t){return h(this,dt)[1]?h(this,dt)[1][t]:t},or=new WeakMap,Lm);var Mm={Stringify:1,BeforeStream:2,Stream:3},$u=(t,e)=>{let r=new String(t);return r.isEscaped=!0,r.callbacks=e,r};var $o=async(t,e,r,n,s)=>{typeof t=="object"&&!(t instanceof String)&&(t instanceof Promise||(t=t.toString()),t instanceof Promise&&(t=await t));let o=t.callbacks;if(!o?.length)return Promise.resolve(t);s?s[0]+=t:s=[t];let i=Promise.all(o.map(a=>a({phase:e,buffer:s,context:n}))).then(a=>Promise.all(a.filter(Boolean).map(m=>$o(m,e,!1,n,s))).then(()=>s[0]));return r?$u(await i,o):i};var Du="text/plain; charset=UTF-8",Do=(t,e={})=>{for(let r of Object.keys(e))t.set(r,e[r]);return t},Hn,Jn,Ft,$r,Mt,se,ue,We,Ut,Qn,ln,fn,Xn,Yn,Me,nt,Um,zm=(Um=class{constructor(t,e){k(this,Me);k(this,Hn);k(this,Jn);A(this,"env",{});k(this,Ft);A(this,"finalized",!1);A(this,"error");k(this,$r,200);k(this,Mt);k(this,se);k(this,ue);k(this,We);k(this,Ut,!0);k(this,Qn);k(this,ln);k(this,fn);k(this,Xn);k(this,Yn);A(this,"render",(...t)=>(h(this,ln)??g(this,ln,e=>this.html(e)),h(this,ln).call(this,...t)));A(this,"setLayout",t=>g(this,Qn,t));A(this,"getLayout",()=>h(this,Qn));A(this,"setRenderer",t=>{g(this,ln,t)});A(this,"header",(t,e,r)=>{if(this.finalized&&g(this,We,new Response(h(this,We).body,h(this,We))),e===void 0){h(this,se)?h(this,se).delete(t):h(this,ue)&&delete h(this,ue)[t.toLocaleLowerCase()],this.finalized&&this.res.headers.delete(t);return}r?.append?(h(this,se)||(g(this,Ut,!1),g(this,se,new Headers(h(this,ue))),g(this,ue,{})),h(this,se).append(t,e)):h(this,se)?h(this,se).set(t,e):(h(this,ue)??g(this,ue,{}),h(this,ue)[t.toLowerCase()]=e),this.finalized&&(r?.append?this.res.headers.append(t,e):this.res.headers.set(t,e))});A(this,"status",t=>{g(this,Ut,!1),g(this,$r,t)});A(this,"set",(t,e)=>{h(this,Ft)??g(this,Ft,new Map),h(this,Ft).set(t,e)});A(this,"get",t=>h(this,Ft)?h(this,Ft).get(t):void 0);A(this,"newResponse",(...t)=>T(this,Me,nt).call(this,...t));A(this,"body",(t,e,r)=>typeof e=="number"?T(this,Me,nt).call(this,t,e,r):T(this,Me,nt).call(this,t,e));A(this,"text",(t,e,r)=>{if(!h(this,ue)){if(h(this,Ut)&&!r&&!e)return new Response(t);g(this,ue,{})}return h(this,ue)["content-type"]=Du,typeof e=="number"?T(this,Me,nt).call(this,t,e,r):T(this,Me,nt).call(this,t,e)});A(this,"json",(t,e,r)=>{let n=JSON.stringify(t);return h(this,ue)??g(this,ue,{}),h(this,ue)["content-type"]="application/json",typeof e=="number"?T(this,Me,nt).call(this,n,e,r):T(this,Me,nt).call(this,n,e)});A(this,"html",(t,e,r)=>(h(this,ue)??g(this,ue,{}),h(this,ue)["content-type"]="text/html; charset=UTF-8",typeof t=="object"?$o(t,Mm.Stringify,!1,{}).then(n=>typeof e=="number"?T(this,Me,nt).call(this,n,e,r):T(this,Me,nt).call(this,n,e)):typeof e=="number"?T(this,Me,nt).call(this,t,e,r):T(this,Me,nt).call(this,t,e)));A(this,"redirect",(t,e)=>(h(this,se)??g(this,se,new Headers),h(this,se).set("Location",String(t)),this.newResponse(null,e??302)));A(this,"notFound",()=>(h(this,fn)??g(this,fn,()=>new Response),h(this,fn).call(this,this)));g(this,Hn,t),e&&(g(this,Mt,e.executionCtx),this.env=e.env,g(this,fn,e.notFoundHandler),g(this,Yn,e.path),g(this,Xn,e.matchResult))}get req(){return h(this,Jn)??g(this,Jn,new Is(h(this,Hn),h(this,Yn),h(this,Xn))),h(this,Jn)}get event(){if(h(this,Mt)&&"respondWith"in h(this,Mt))return h(this,Mt);throw Error("This context has no FetchEvent")}get executionCtx(){if(h(this,Mt))return h(this,Mt);throw Error("This context has no ExecutionContext")}get res(){return g(this,Ut,!1),h(this,We)||g(this,We,new Response("404 Not Found",{status:404}))}set res(t){if(g(this,Ut,!1),h(this,We)&&t){t=new Response(t.body,t);for(let[e,r]of h(this,We).headers.entries())if(e!=="content-type")if(e==="set-cookie"){let n=h(this,We).headers.getSetCookie();t.headers.delete("set-cookie");for(let s of n)t.headers.append("set-cookie",s)}else t.headers.set(e,r)}g(this,We,t),this.finalized=!0}get var(){return h(this,Ft)?Object.fromEntries(h(this,Ft)):{}}},Hn=new WeakMap,Jn=new WeakMap,Ft=new WeakMap,$r=new WeakMap,Mt=new WeakMap,se=new WeakMap,ue=new WeakMap,We=new WeakMap,Ut=new WeakMap,Qn=new WeakMap,ln=new WeakMap,fn=new WeakMap,Xn=new WeakMap,Yn=new WeakMap,Me=new WeakSet,nt=function(t,e,r){if(h(this,Ut)&&!r&&!e&&h(this,$r)===200)return new Response(t,{headers:h(this,ue)});if(e&&typeof e!="number"){let s=new Headers(e.headers);h(this,se)&&h(this,se).forEach((i,a)=>{a==="set-cookie"?s.append(a,i):s.set(a,i)});let o=Do(s,h(this,ue));return new Response(t,{headers:o,status:e.status??h(this,$r)})}let n=typeof e=="number"?e:h(this,$r);h(this,ue)??g(this,ue,{}),h(this,se)??g(this,se,new Headers),Do(h(this,se),h(this,ue)),h(this,We)&&(h(this,We).headers.forEach((s,o)=>{o==="set-cookie"?h(this,se)?.append(o,s):h(this,se)?.set(o,s)}),Do(h(this,se),h(this,ue))),r??(r={});for(let[s,o]of Object.entries(r))if(typeof o=="string")h(this,se).set(s,o);else{h(this,se).delete(s);for(let i of o)h(this,se).append(s,i)}return new Response(t,{status:n,headers:h(this,se)})},Um);var ie="ALL",Km="all",Gm=["get","post","put","delete","options","patch"],Rs="Can not add a route since the matcher is already built.",qs=class extends Error{};var Wm="__COMPOSED_HANDLER";var Cu=t=>t.text("404 Not Found",404),Hm=(t,e)=>{if("getResponse"in t){let r=t.getResponse();return e.newResponse(r.body,r)}return console.error(t),e.text("Internal Server Error",500)},lt,we,Qm,ft,Dr,Ls,Bs,Jm,Co=(Jm=class{constructor(t={}){k(this,we);A(this,"get");A(this,"post");A(this,"put");A(this,"delete");A(this,"options");A(this,"patch");A(this,"all");A(this,"on");A(this,"use");A(this,"router");A(this,"getPath");A(this,"_basePath","/");k(this,lt,"/");A(this,"routes",[]);k(this,ft,Cu);A(this,"errorHandler",Hm);A(this,"onError",t=>(this.errorHandler=t,this));A(this,"notFound",t=>(g(this,ft,t),this));A(this,"fetch",(t,...e)=>T(this,we,Bs).call(this,t,e[1],e[0],t.method));A(this,"request",(t,e,r,n)=>t instanceof Request?this.fetch(e?new Request(t,e):t,r,n):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${Pr("/",t)}`,e),r,n)));A(this,"fire",()=>{addEventListener("fetch",t=>{t.respondWith(T(this,we,Bs).call(this,t.request,t,void 0,t.request.method))})});[...Gm,Km].forEach(s=>{this[s]=(o,...i)=>(typeof o=="string"?g(this,lt,o):T(this,we,Dr).call(this,s,h(this,lt),o),i.forEach(a=>{T(this,we,Dr).call(this,s,h(this,lt),a)}),this)}),this.on=(s,o,...i)=>{for(let a of[o].flat()){g(this,lt,a);for(let m of[s].flat())i.map(p=>{T(this,we,Dr).call(this,m.toUpperCase(),h(this,lt),p)})}return this},this.use=(s,...o)=>(typeof s=="string"?g(this,lt,s):(g(this,lt,"*"),o.unshift(s)),o.forEach(i=>{T(this,we,Dr).call(this,ie,h(this,lt),i)}),this);let{strict:r,...n}=t;Object.assign(this,n),this.getPath=r??!0?t.getPath??Ao:Im}route(t,e){let r=this.basePath(t);return e.routes.map(n=>{var o;let s;e.errorHandler===Hm?s=n.handler:(s=async(i,a)=>(await Eo([],e.errorHandler)(i,()=>n.handler(i,a))).res,s[Wm]=n.handler),T(o=r,we,Dr).call(o,n.method,n.path,s)}),this}basePath(t){let e=T(this,we,Qm).call(this);return e._basePath=Pr(this._basePath,t),e}mount(t,e,r){let n,s;r&&(typeof r=="function"?s=r:(s=r.optionHandler,r.replaceRequest===!1?n=a=>a:n=r.replaceRequest));let o=s?a=>{let m=s(a);return Array.isArray(m)?m:[m]}:a=>{let m;try{m=a.executionCtx}catch{}return[a.env,m]};n||(n=(()=>{let a=Pr(this._basePath,t),m=a==="/"?0:a.length;return p=>{let c=new URL(p.url);return c.pathname=c.pathname.slice(m)||"/",new Request(c,p)}})());let i=async(a,m)=>{let p=await e(n(a.req.raw),...o(a));if(p)return p;await m()};return T(this,we,Dr).call(this,ie,Pr(t,"*"),i),this}},lt=new WeakMap,we=new WeakSet,Qm=function(){let t=new Co({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,g(t,ft,h(this,ft)),t.routes=this.routes,t},ft=new WeakMap,Dr=function(t,e,r){t=t.toUpperCase(),e=Pr(this._basePath,e);let n={path:e,method:t,handler:r};this.router.add(t,e,[r,n]),this.routes.push(n)},Ls=function(t,e){if(t instanceof Error)return this.errorHandler(t,e);throw t},Bs=function(t,e,r,n){if(n==="HEAD")return(async()=>new Response(null,await T(this,we,Bs).call(this,t,e,r,"GET")))();let s=this.getPath(t,{env:r}),o=this.router.match(n,s),i=new zm(t,{path:s,matchResult:o,env:r,executionCtx:e,notFoundHandler:h(this,ft)});if(o[0].length===1){let m;try{m=o[0][0][0][0](i,async()=>{i.res=await h(this,ft).call(this,i)})}catch(p){return T(this,we,Ls).call(this,p,i)}return m instanceof Promise?m.then(p=>p||(i.finalized?i.res:h(this,ft).call(this,i))).catch(p=>T(this,we,Ls).call(this,p,i)):m??h(this,ft).call(this,i)}let a=Eo(o[0],this.errorHandler,h(this,ft));return(async()=>{try{let m=await a(i);if(!m.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return m.res}catch(m){return T(this,we,Ls).call(this,m,i)}})()},Jm);var Fs="[^/]+",Zn=".*",_n="(?:|/.*)",hn=Symbol(),Tu=new Set(".\\+*[^]$()");function Nu(t,e){return t.length===1?e.length===1?t<e?-1:1:-1:e.length===1||t===Zn||t===_n?1:e===Zn||e===_n?-1:t===Fs?1:e===Fs?-1:t.length===e.length?t<e?-1:1:e.length-t.length}var Cr,Tr,ht,Xm,Ms=(Xm=class{constructor(){k(this,Cr);k(this,Tr);k(this,ht,Object.create(null))}insert(t,e,r,n,s){if(t.length===0){if(h(this,Cr)!==void 0)throw hn;if(s)return;g(this,Cr,e);return}let[o,...i]=t,a=o==="*"?i.length===0?["","",Zn]:["","",Fs]:o==="/*"?["","",_n]:o.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),m;if(a){let p=a[1],c=a[2]||Fs;if(p&&a[2]&&(c=c.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(c)))throw hn;if(m=h(this,ht)[c],!m){if(Object.keys(h(this,ht)).some(u=>u!==Zn&&u!==_n))throw hn;if(s)return;m=h(this,ht)[c]=new Ms,p!==""&&g(m,Tr,n.varIndex++)}!s&&p!==""&&r.push([p,h(m,Tr)])}else if(m=h(this,ht)[o],!m){if(Object.keys(h(this,ht)).some(p=>p.length>1&&p!==Zn&&p!==_n))throw hn;if(s)return;m=h(this,ht)[o]=new Ms}m.insert(i,e,r,n,s)}buildRegExpStr(){let e=Object.keys(h(this,ht)).sort(Nu).map(r=>{let n=h(this,ht)[r];return(typeof h(n,Tr)=="number"?`(${r})@${h(n,Tr)}`:Tu.has(r)?`\\${r}`:r)+n.buildRegExpStr()});return typeof h(this,Cr)=="number"&&e.unshift(`#${h(this,Cr)}`),e.length===0?"":e.length===1?e[0]:"(?:"+e.join("|")+")"}},Cr=new WeakMap,Tr=new WeakMap,ht=new WeakMap,Xm);var Us,es,Ym,Zm=(Ym=class{constructor(){k(this,Us,{varIndex:0});k(this,es,new Ms)}insert(t,e,r){let n=[],s=[];for(let i=0;;){let a=!1;if(t=t.replace(/\{[^}]+\}/g,m=>{let p=`@\\${i}`;return s[i]=[p,m],i++,a=!0,p}),!a)break}let o=t.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let i=s.length-1;i>=0;i--){let[a]=s[i];for(let m=o.length-1;m>=0;m--)if(o[m].indexOf(a)!==-1){o[m]=o[m].replace(a,s[i][1]);break}}return h(this,es).insert(o,e,n,h(this,Us),r),n}buildRegExp(){let t=h(this,es).buildRegExpStr();if(t==="")return[/^$/,[],[]];let e=0,r=[],n=[];return t=t.replace(/#(\d+)|@(\d+)|\.\*\$/g,(s,o,i)=>o!==void 0?(r[++e]=Number(o),"$()"):(i!==void 0&&(n[Number(i)]=++e),"")),[new RegExp(`^${t}`),r,n]}},Us=new WeakMap,es=new WeakMap,Ym);var ep=[],Iu=[/^$/,[],Object.create(null)],zs=Object.create(null);function tp(t){return zs[t]??(zs[t]=new RegExp(t==="*"?"":`^${t.replace(/\/\*$|([.\\+*[^\]$()])/g,(e,r)=>r?`\\${r}`:"(?:|/.*)")}$`))}function Vu(){zs=Object.create(null)}function ju(t){let e=new Zm,r=[];if(t.length===0)return Iu;let n=t.map(p=>[!/\*|\/:/.test(p[0]),...p]).sort(([p,c],[u,f])=>p?1:u?-1:c.length-f.length),s=Object.create(null);for(let p=0,c=-1,u=n.length;p<u;p++){let[f,l,y]=n[p];f?s[l]=[y.map(([b])=>[b,Object.create(null)]),ep]:c++;let x;try{x=e.insert(l,c,f)}catch(b){throw b===hn?new qs(l):b}f||(r[c]=y.map(([b,O])=>{let v=Object.create(null);for(O-=1;O>=0;O--){let[D,V]=x[O];v[D]=V}return[b,v]}))}let[o,i,a]=e.buildRegExp();for(let p=0,c=r.length;p<c;p++)for(let u=0,f=r[p].length;u<f;u++){let l=r[p][u]?.[1];if(!l)continue;let y=Object.keys(l);for(let x=0,b=y.length;x<b;x++)l[y[x]]=a[l[y[x]]]}let m=[];for(let p in i)m[p]=r[i[p]];return[o,m,s]}function yn(t,e){if(t){for(let r of Object.keys(t).sort((n,s)=>s.length-n.length))if(tp(r).test(e))return[...t[r]]}}var ir,ar,bn,rp,np,_m,To=(_m=class{constructor(){k(this,bn);A(this,"name","RegExpRouter");k(this,ir);k(this,ar);g(this,ir,{[ie]:Object.create(null)}),g(this,ar,{[ie]:Object.create(null)})}add(t,e,r){var a;let n=h(this,ir),s=h(this,ar);if(!n||!s)throw new Error(Rs);n[t]||[n,s].forEach(m=>{m[t]=Object.create(null),Object.keys(m[ie]).forEach(p=>{m[t][p]=[...m[ie][p]]})}),e==="/*"&&(e="*");let o=(e.match(/\/:/g)||[]).length;if(/\*$/.test(e)){let m=tp(e);t===ie?Object.keys(n).forEach(p=>{var c;(c=n[p])[e]||(c[e]=yn(n[p],e)||yn(n[ie],e)||[])}):(a=n[t])[e]||(a[e]=yn(n[t],e)||yn(n[ie],e)||[]),Object.keys(n).forEach(p=>{(t===ie||t===p)&&Object.keys(n[p]).forEach(c=>{m.test(c)&&n[p][c].push([r,o])})}),Object.keys(s).forEach(p=>{(t===ie||t===p)&&Object.keys(s[p]).forEach(c=>m.test(c)&&s[p][c].push([r,o]))});return}let i=js(e)||[e];for(let m=0,p=i.length;m<p;m++){let c=i[m];Object.keys(s).forEach(u=>{var f;(t===ie||t===u)&&((f=s[u])[c]||(f[c]=[...yn(n[u],c)||yn(n[ie],c)||[]]),s[u][c].push([r,o-p+m+1]))})}}match(t,e){Vu();let r=T(this,bn,rp).call(this);return this.match=(n,s)=>{let o=r[n]||r[ie],i=o[2][s];if(i)return i;let a=s.match(o[0]);if(!a)return[[],ep];let m=a.indexOf("",1);return[o[1][m],a]},this.match(t,e)}},ir=new WeakMap,ar=new WeakMap,bn=new WeakSet,rp=function(){let t=Object.create(null);return Object.keys(h(this,ar)).concat(Object.keys(h(this,ir))).forEach(e=>{t[e]||(t[e]=T(this,bn,np).call(this,e))}),g(this,ir,g(this,ar,void 0)),t},np=function(t){let e=[],r=t===ie;return[h(this,ir),h(this,ar)].forEach(n=>{let s=n[t]?Object.keys(n[t]).map(o=>[o,n[t][o]]):[];s.length!==0?(r||(r=!0),e.push(...s)):t!==ie&&e.push(...Object.keys(n[ie]).map(o=>[o,n[ie][o]]))}),r?ju(e):null},_m);var mr,zt,sp,No=(sp=class{constructor(t){A(this,"name","SmartRouter");k(this,mr,[]);k(this,zt,[]);g(this,mr,t.routers)}add(t,e,r){if(!h(this,zt))throw new Error(Rs);h(this,zt).push([t,e,r])}match(t,e){if(!h(this,zt))throw new Error("Fatal error");let r=h(this,mr),n=h(this,zt),s=r.length,o=0,i;for(;o<s;o++){let a=r[o];try{for(let m=0,p=n.length;m<p;m++)a.add(...n[m]);i=a.match(t,e)}catch(m){if(m instanceof qs)continue;throw m}this.match=a.match.bind(a),g(this,mr,[a]),g(this,zt,void 0);break}if(o===s)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,i}get activeRouter(){if(h(this,zt)||h(this,mr).length!==1)throw new Error("No active router has been determined yet.");return h(this,mr)[0]}},mr=new WeakMap,zt=new WeakMap,sp);var ts=Object.create(null),pr,Ve,Ir,xn,$e,Kt,Nr,op,Io=(op=class{constructor(t,e,r){k(this,Kt);k(this,pr);k(this,Ve);k(this,Ir);k(this,xn,0);k(this,$e,ts);if(g(this,Ve,r||Object.create(null)),g(this,pr,[]),t&&e){let n=Object.create(null);n[t]={handler:e,possibleKeys:[],score:0},g(this,pr,[n])}g(this,Ir,[])}insert(t,e,r){g(this,xn,++Bo(this,xn)._);let n=this,s=Nm(e),o=[];for(let m=0,p=s.length;m<p;m++){let c=s[m],u=s[m+1],f=Oo(c,u),l=Array.isArray(f)?f[0]:c;if(Object.keys(h(n,Ve)).includes(l)){n=h(n,Ve)[l];let y=Oo(c,u);y&&o.push(y[1]);continue}h(n,Ve)[l]=new Io,f&&(h(n,Ir).push(f),o.push(f[1])),n=h(n,Ve)[l]}let i=Object.create(null),a={handler:r,possibleKeys:o.filter((m,p,c)=>c.indexOf(m)===p),score:h(this,xn)};return i[t]=a,h(n,pr).push(i),n}search(t,e){let r=[];g(this,$e,ts);let s=[this],o=So(e),i=[];for(let a=0,m=o.length;a<m;a++){let p=o[a],c=a===m-1,u=[];for(let f=0,l=s.length;f<l;f++){let y=s[f],x=h(y,Ve)[p];x&&(g(x,$e,h(y,$e)),c?(h(x,Ve)["*"]&&r.push(...T(this,Kt,Nr).call(this,h(x,Ve)["*"],t,h(y,$e))),r.push(...T(this,Kt,Nr).call(this,x,t,h(y,$e)))):u.push(x));for(let b=0,O=h(y,Ir).length;b<O;b++){let v=h(y,Ir)[b],D=h(y,$e)===ts?{}:{...h(y,$e)};if(v==="*"){let j=h(y,Ve)["*"];j&&(r.push(...T(this,Kt,Nr).call(this,j,t,h(y,$e))),g(j,$e,D),u.push(j));continue}if(p==="")continue;let[V,J,R]=v,q=h(y,Ve)[V],te=o.slice(a).join("/");if(R instanceof RegExp){let j=R.exec(te);if(j){if(D[J]=j[0],r.push(...T(this,Kt,Nr).call(this,q,t,h(y,$e),D)),Object.keys(h(q,Ve)).length){g(q,$e,D);let $=j[0].match(/\//)?.length??0;(i[$]||(i[$]=[])).push(q)}continue}}(R===!0||R.test(p))&&(D[J]=p,c?(r.push(...T(this,Kt,Nr).call(this,q,t,D,h(y,$e))),h(q,Ve)["*"]&&r.push(...T(this,Kt,Nr).call(this,h(q,Ve)["*"],t,D,h(y,$e)))):(g(q,$e,D),u.push(q)))}}s=u.concat(i.shift()??[])}return r.length>1&&r.sort((a,m)=>a.score-m.score),[r.map(({handler:a,params:m})=>[a,m])]}},pr=new WeakMap,Ve=new WeakMap,Ir=new WeakMap,xn=new WeakMap,$e=new WeakMap,Kt=new WeakSet,Nr=function(t,e,r,n){let s=[];for(let o=0,i=h(t,pr).length;o<i;o++){let a=h(t,pr)[o],m=a[e]||a[ie],p={};if(m!==void 0&&(m.params=Object.create(null),s.push(m),r!==ts||n&&n!==ts))for(let c=0,u=m.possibleKeys.length;c<u;c++){let f=m.possibleKeys[c],l=p[m.score];m.params[f]=n?.[f]&&!l?n[f]:r[f]??n?.[f],p[m.score]=!0}}return s},op);var Vr,ip,Vo=(ip=class{constructor(){A(this,"name","TrieRouter");k(this,Vr);g(this,Vr,new Io)}add(t,e,r){let n=js(e);if(n){for(let s=0,o=n.length;s<o;s++)h(this,Vr).insert(t,n[s],r);return}h(this,Vr).insert(t,e,r)}match(t,e){return h(this,Vr).search(t,e)}},Vr=new WeakMap,ip);var jo=class extends Co{constructor(t={}){super(t),this.router=t.router??new No({routers:[new To,new Vo]})}};var ap=t=>{let r={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...t},n=(s=>typeof s=="string"?s==="*"?()=>s:o=>s===o?o:null:typeof s=="function"?s:o=>s.includes(o)?o:null)(r.origin);return async function(o,i){function a(p,c){o.res.headers.set(p,c)}let m=n(o.req.header("origin")||"",o);if(m&&a("Access-Control-Allow-Origin",m),r.origin!=="*"){let p=o.req.header("Vary");p?a("Vary",p):a("Vary","Origin")}if(r.credentials&&a("Access-Control-Allow-Credentials","true"),r.exposeHeaders?.length&&a("Access-Control-Expose-Headers",r.exposeHeaders.join(",")),o.req.method==="OPTIONS"){r.maxAge!=null&&a("Access-Control-Max-Age",r.maxAge.toString()),r.allowMethods?.length&&a("Access-Control-Allow-Methods",r.allowMethods.join(","));let p=r.allowHeaders;if(!p?.length){let c=o.req.header("Access-Control-Request-Headers");c&&(p=c.split(/\s*,\s*/))}return p?.length&&(a("Access-Control-Allow-Headers",p.join(",")),o.res.headers.append("Vary","Access-Control-Request-Headers")),o.res.headers.delete("Content-Length"),o.res.headers.delete("Content-Type"),new Response(null,{headers:o.res.headers,status:204,statusText:"No Content"})}await i()}};var mp=t=>{let e="",r=new Uint8Array(t);for(let n=0,s=r.length;n<s;n++)e+=String.fromCharCode(r[n]);return btoa(e)},pp=t=>{let e=atob(t),r=new Uint8Array(new ArrayBuffer(e.length)),n=e.length/2;for(let s=0,o=e.length-1;s<=n;s++,o--)r[s]=e.charCodeAt(s),r[o]=e.charCodeAt(o);return r};var Ru=t=>t.requestContext;var Ro=t=>async(e,r)=>{let n=zu(e),s=n.createRequest(e),o=Ru(e),i=await t.fetch(s,{event:e,requestContext:o,lambdaContext:r});return n.createResult(e,i)},qo=class{createRequest(t){let e=this.getQueryString(t),r=t.requestContext&&"domainName"in t.requestContext?t.requestContext.domainName:t.headers?.host??t.multiValueHeaders?.host?.[0],n=this.getPath(t),s=`https://${r}${n}`,o=e?`${s}?${e}`:s,i=this.getHeaders(t),a=this.getMethod(t),m={headers:i,method:a};return t.body&&(m.body=t.isBase64Encoded?pp(t.body):t.body),new Request(o,m)}async createResult(t,e){let r=e.headers.get("content-type"),n=!!(r&&Wu(r));if(!n){let i=e.headers.get("content-encoding");n=Hu(i)}let o={body:n?mp(await e.arrayBuffer()):await e.text(),statusCode:e.status,isBase64Encoded:n,...t.multiValueHeaders?{multiValueHeaders:{}}:{headers:{}}};return this.setCookies(t,e,o),o.multiValueHeaders?e.headers.forEach((i,a)=>{o.multiValueHeaders[a]=[i]}):e.headers.forEach((i,a)=>{o.headers[a]=i}),o}setCookies(t,e,r){if(e.headers.has("set-cookie")){let n=e.headers.getSetCookie?e.headers.getSetCookie():Array.from(e.headers.entries()).filter(([s])=>s==="set-cookie").map(([,s])=>s);Array.isArray(n)&&(this.setCookiesToResult(r,n),e.headers.delete("set-cookie"))}}},qu=class extends qo{getPath(t){return t.rawPath}getMethod(t){return t.requestContext.http.method}getQueryString(t){return t.rawQueryString}getCookies(t,e){Array.isArray(t.cookies)&&e.set("Cookie",t.cookies.join("; "))}setCookiesToResult(t,e){t.cookies=e}getHeaders(t){let e=new Headers;if(this.getCookies(t,e),t.headers)for(let[r,n]of Object.entries(t.headers))n&&e.set(r,n);return e}},Lu=new qu,Bu=class extends qo{getPath(t){return t.path}getMethod(t){return t.httpMethod}getQueryString(t){return t.multiValueQueryStringParameters?Object.entries(t.multiValueQueryStringParameters||{}).filter(([,e])=>e).map(([e,r])=>`${e}=${r.join(`&${e}=`)}`).join("&"):Object.entries(t.queryStringParameters||{}).filter(([,e])=>e).map(([e,r])=>`${e}=${r}`).join("&")}getCookies(t,e){}getHeaders(t){let e=new Headers;if(this.getCookies(t,e),t.headers)for(let[r,n]of Object.entries(t.headers))n&&e.set(r,n);if(t.multiValueHeaders){for(let[r,n]of Object.entries(t.multiValueHeaders))if(n){let s=e.get(r);n.forEach(o=>(!s||!s.includes(o))&&e.append(r,o))}}return e}setCookiesToResult(t,e){t.multiValueHeaders={"set-cookie":e}}},Fu=new Bu,Mu=class extends qo{getHeaders(t){let e=new Headers;if(t.multiValueHeaders)for(let[r,n]of Object.entries(t.multiValueHeaders))n&&Array.isArray(n)&&e.set(r,n.join("; "));else for(let[r,n]of Object.entries(t.headers??{}))n&&e.set(r,n);return e}getPath(t){return t.path}getMethod(t){return t.httpMethod}getQueryString(t){return t.multiValueQueryStringParameters?Object.entries(t.multiValueQueryStringParameters||{}).filter(([,e])=>e).map(([e,r])=>`${e}=${r.join(`&${e}=`)}`).join("&"):Object.entries(t.queryStringParameters||{}).filter(([,e])=>e).map(([e,r])=>`${e}=${r}`).join("&")}getCookies(t,e){let r;t.multiValueHeaders?r=t.multiValueHeaders.cookie?.join("; "):r=t.headers?t.headers.cookie:void 0,r&&e.append("Cookie",r)}setCookiesToResult(t,e){t.multiValueHeaders?t.multiValueHeaders["set-cookie"]=e:t.headers["set-cookie"]=e.join(", ")}},Uu=new Mu,zu=t=>Ku(t)?Uu:Gu(t)?Lu:Fu,Ku=t=>t.requestContext?Object.hasOwn(t.requestContext,"elb"):!1,Gu=t=>Object.hasOwn(t,"rawPath"),Wu=t=>!/^(text\/(plain|html|css|javascript|csv).*|application\/(.*json|.*xml).*|image\/svg\+xml.*)$/.test(t),Hu=t=>t===null?!1:/^(gzip|deflate|compress|br)/.test(t);var yt=new jo;yt.use("*",ap({origin:"*",allowMethods:["GET","POST","OPTIONS"],allowHeaders:["Content-Type","Authorization"]}));yt.options("*",t=>t.json({message:"CORS enabled"},200));yt.get("/leaderboard/context/:userId",async t=>{try{let e=t.req.param("userId"),r=t.req.query("userTime"),n=await Zu({userId:e,userTime:r});return t.json(n,200)}catch(e){return console.error("Error in leaderboard context:",e),t.json({message:"Internal server error",error:e instanceof Error?e.message:String(e)},500)}});yt.get("/leaderboard",async t=>{try{let e=t.req.query("limit"),r=await Yu({limit:e});return t.json(r,200)}catch(e){return console.error("Error in leaderboard:",e),t.json({message:"Internal server error",error:e instanceof Error?e.message:String(e)},500)}});yt.get("/stats/:userId",async t=>{try{let e=t.req.param("userId"),r=await _u({userId:e});return t.json(r,200)}catch(e){return console.error("Error in user stats:",e),t.json({message:"Internal server error",error:e instanceof Error?e.message:String(e)},500)}});yt.get("/bestgames/:userId",async t=>{try{let e=t.req.param("userId"),r=t.req.query("limit")?parseInt(t.req.query("limit")||"5"):5,n=await tc({userId:e,limit:r});return t.json(n,200)}catch(e){return console.error("Error in best games:",e),t.json({message:"Internal server error",error:e instanceof Error?e.message:String(e)},500)}});yt.get("/games",async t=>{try{let e=t.req.query("userId"),r=t.req.query("limit"),n=await Xu({userId:e,limit:r});return t.json(n,200)}catch(e){return console.error("Error in get games:",e),t.json({message:"Internal server error",error:e instanceof Error?e.message:String(e)},500)}});yt.post("/games",async t=>{try{let e=await t.req.json(),r=await Qu(e);return t.json(r,200)}catch(e){return console.error("Error in save game:",e),t.json({message:"Internal server error",error:e instanceof Error?e.message:String(e)},500)}});yt.get("/recent-games",async t=>{try{let e=t.req.query("limit"),r=await ec({limit:e});return t.json(r,200)}catch(e){return console.error("Error in recent games:",e),t.json({message:"Internal server error",error:e instanceof Error?e.message:String(e)},500)}});yt.all("*",t=>t.json({message:"Endpoint not found"},404));var Ju=Ro(yt),je=(t,e)=>({statusCode:t,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type,Authorization"},body:JSON.stringify(e)});async function Qu(t){if(console.log("Received game data:",JSON.stringify(t,null,2)),!t)return console.error("No game data provided"),je(400,{message:"Request body is required"});let e=new Date().toISOString(),r=t.rawUserId||t.userId;if(console.log("Extracted rawUserId:",r),!r)return console.error("No userId or rawUserId found in payload"),je(400,{message:"userId or rawUserId is required"});try{let n={userId:`GAME#${r}`,timestamp:`DATE#${e}`,bombsExploded:t.bombsExploded||0,cellsRevealed:t.cellsRevealed||0,date:t.date||e,gameRestarts:t.gameRestarts||0,lastUpdated:e,noFlagWin:t.noFlagWin||!1,rawUserId:r,time:t.time||t.successTime||0,timePlayed:t.timePlayed||0,usedFlags:t.usedFlags||0,userName:t.userName||"",userImage:t.userImage||null,status:t.status||"completed",ttl:Math.floor(Date.now()/1e3)+7776e3};console.log("Prepared game item:",JSON.stringify(n,null,2)),await Cm.build(mt).item(n).send(),console.log("Game saved successfully to DynamoDB");let s={...t,rawUserId:r,time:n.time};return console.log("Updating user stats with:",JSON.stringify(s,null,2)),await rc(s),console.log("User stats updated successfully"),je(200,{message:"Game saved successfully",game:n})}catch(n){return console.error("Error saving game:",n),je(500,{message:"Error saving game",error:n instanceof Error?n.message:String(n)})}}async function Xu(t){let{userId:e,limit:r=50}=t||{};if(!e)return je(400,{message:"userId is required"});let n=await rt.build(pe).query({partition:`GAME#${e}`}).options({limit:parseInt(r),reverse:!0}).send();return je(200,{games:n.Items||[]})}async function Yu(t){let{limit:e=10}=t||{},r=await rt.build(pe).query({index:"status-time-index",partition:"COMPLETED"}).options({limit:parseInt(e),reverse:!1}).send();return je(200,{leaderboard:r.Items||[]})}async function Zu(t){let{userId:e,userTime:r}=t||{};if(!e||!r)return je(400,{message:"userId and userTime are required"});let n=parseInt(r),s=await rt.build(pe).query({index:"status-time-index",partition:"COMPLETED"}).options({limit:5,reverse:!1,filter:{attr:"time",lt:n}}).send(),o=await rt.build(pe).query({index:"status-time-index",partition:"COMPLETED"}).options({limit:5,reverse:!0,filter:{attr:"time",gt:n}}).send();return je(200,{faster:s.Items||[],slower:o.Items||[]})}async function _u(t){let{userId:e}=t||{};if(console.log("getUserStats called with userId:",e),!e)return console.error("No userId provided to getUserStats"),je(400,{message:"User ID is required"});try{console.log("Querying user stats for:",`STAT#${e}`);let r=await Ns.build(at).key({userId:`STAT#${e}`,timestamp:"TYPE#GLOBAL_STATS"}).send();console.log("Stats response:",r.Item?"Found":"Not found"),console.log("Querying recent games for:",`GAME#${e}`);let n=await rt.build(pe).query({partition:`GAME#${e}`}).options({limit:10,reverse:!0}).send();console.log("Recent games found:",n.Items?.length||0);let s=n.Items||[];if(!r.Item){console.log("No existing stats found, returning defaults");let i={userId:`STAT#${e}`,timestamp:"TYPE#GLOBAL_STATS",gamesPlayed:0,gamesWon:0,gamesLost:0,gamesAbandoned:0,fastestWin:void 0,recentGames:s};return je(200,{stats:i})}console.log("Returning existing stats with recent games");let o={...r.Item,recentGames:s};return je(200,{stats:o})}catch(r){return console.error("Error in getUserStats:",r),je(500,{message:"Error fetching user stats",error:r instanceof Error?r.message:String(r)})}}async function ec(t){let{limit:e=10}=t||{},n=((await rt.build(Et).options({limit:parseInt(e),filter:{attr:"userId",exists:!0}}).send()).Items||[]).sort((s,o)=>new Date(o.lastUpdated||o.timestamp).getTime()-new Date(s.lastUpdated||s.timestamp).getTime());return je(200,{games:n})}async function tc(t){let{userId:e,limit:r=5}=t||{};if(!e)return je(400,{message:"User ID is required"});let o=((await rt.build(pe).query({partition:`GAME#${e}`}).options({limit:100,reverse:!0}).send()).Items||[]).filter(i=>i.time&&i.time>0).sort((i,a)=>i.time-a.time).slice(0,parseInt(r));return je(200,{games:o})}async function rc(t){let e=`STAT#${t.rawUserId}`,r="TYPE#GLOBAL_STATS";try{let s=(await Ns.build(at).key({userId:e,timestamp:r}).send()).Item||{userId:e,timestamp:r,gamesPlayed:0,gamesWon:0,gamesLost:0,gamesAbandoned:0,gamesRestarted:0,noFlagWins:0,fastestWin:void 0,totalBombsExploded:0,totalCellsRevealed:0,totalFlagsPlaced:0,totalGameRestarts:0,totalTimePlayed:0,totalWinTime:0,status:"ACTIVE",time:t.time,ttl:Math.floor(Date.now()/1e3)+365*24*60*60};s.gamesPlayed=(s.gamesPlayed||0)+1,s.totalBombsExploded=(s.totalBombsExploded||0)+(t.bombsExploded||0),s.totalCellsRevealed=(s.totalCellsRevealed||0)+(t.cellsRevealed||0),s.totalGameRestarts=(s.totalGameRestarts||0)+(t.gameRestarts||0),s.totalTimePlayed=(s.totalTimePlayed||0)+(t.timePlayed||0),s.totalFlagsPlaced=(s.totalFlagsPlaced||0)+(t.usedFlags||0),t.bombsExploded>0?s.gamesLost=(s.gamesLost||0)+1:t.time>0&&(s.gamesWon=(s.gamesWon||0)+1,s.totalWinTime=(s.totalWinTime||0)+t.time,t.noFlagWin&&(s.noFlagWins=(s.noFlagWins||0)+1),(!s.fastestWin||t.time<s.fastestWin)&&(s.fastestWin=t.time)),await Ns.build(mt).item(s).send()}catch(n){console.error("Error updating user stats:",n)}}0&&(module.exports={handler});
