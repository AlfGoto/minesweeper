"use strict";var ts=Object.defineProperty;var up=Object.getOwnPropertyDescriptor;var cp=Object.getOwnPropertyNames;var dp=Object.prototype.hasOwnProperty;var qo=t=>{throw TypeError(t)};var lp=(t,e,r)=>e in t?ts(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var fp=(t,e)=>{for(var r in e)ts(t,r,{get:e[r],enumerable:!0})},hp=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of cp(e))!dp.call(t,s)&&s!==r&&ts(t,s,{get:()=>e[s],enumerable:!(n=up(e,s))||n.enumerable});return t};var yp=t=>hp(ts({},"__esModule",{value:!0}),t);var A=(t,e,r)=>lp(t,typeof e!="symbol"?e+"":e,r),zs=(t,e,r)=>e.has(t)||qo("Cannot "+r);var h=(t,e,r)=>(zs(t,e,"read from private field"),r?r.call(t):e.get(t)),k=(t,e,r)=>e.has(t)?qo("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),g=(t,e,r,n)=>(zs(t,e,"write to private field"),n?n.call(t,r):e.set(t,r),r),T=(t,e,r)=>(zs(t,e,"access private method"),r);var Lo=(t,e,r,n)=>({set _(s){g(t,e,s,r)},get _(){return h(t,e,n)}});var rc={};fp(rc,{handler:()=>Hu});module.exports=yp(rc);var d=class extends Error{constructor(e,{message:r,path:n,payload:s}){super(r),this.code=e,this.path=n,this.payload=s}};d.match=(t,e="")=>t instanceof d&&t.code.startsWith(e);var Se=t=>typeof t=="boolean";var M=t=>typeof t=="string";var Ks=new Set(["never","atLeastOnce","always"]),We=(t,e)=>{let{required:r,hidden:n,key:s,savedAs:o}=t;if(r!==void 0&&!Ks.has(r))throw new d("schema.invalidProp",{message:`Invalid prop type${e!==void 0?` at path '${e}'`:""}. Property: 'required'. Expected: ${[...Ks].join(", ")}. Received: ${String(r)}.`,path:e,payload:{propName:"required",expected:[...Ks].join(", "),received:r}});if(n!==void 0&&!Se(n))throw new d("schema.invalidProp",{message:`Invalid prop type${e!==void 0?` at path '${e}'`:""}. Property: 'hidden'. Expected: boolean. Received: ${String(n)}.`,path:e,payload:{propName:"hidden",received:n}});if(s!==void 0&&!Se(s))throw new d("schema.invalidProp",{message:`Invalid prop type${e!==void 0?` at path '${e}'`:""}. Property: 'key'. Expected: boolean. Received: ${String(s)}.`,path:e,payload:{propName:"key",received:s}});if(o!==void 0&&!M(o))throw new d("schema.invalidProp",{message:`Invalid prop type${e!==void 0?` at path '${e}'`:""}. Property: 'savedAs'. Expected: string. Received: ${String(o)}.`,path:e,payload:{propName:"savedAs",received:o}})};var nt=class{constructor(e){this.type="any",this.props=e}get checked(){return Object.isFrozen(this.props)}check(e){this.checked||(We(this.props,e),Object.freeze(this.props))}};var re=(t,e,r)=>t?e:r;var w=(t,e)=>({...t,...e});var X=t=>Array.isArray(t);var wn=t=>["keyDefault","putDefault","updateDefault","keyLink","putLink","updateLink"].some(e=>t.props[e]!==void 0);var rs=Symbol("$discriminators_"),Vr=Symbol("$discriminators"),jr=Symbol("$discriminations_");var En=class{constructor(e,r){this.type="anyOf",this.elements=e,this.props=r}get checked(){return Object.isFrozen(this.props)}check(e){if(this.checked)return;if(We(this.props,e),!X(this.elements))throw new d("schema.anyOf.invalidElements",{message:`Invalid anyOf elements${e!==void 0?` at path '${e}'`:""}: AnyOf elements must be an array.`,path:e});if(this.elements.length===0)throw new d("schema.anyOf.missingElements",{message:`Invalid anyOf elements${e!==void 0?` at path '${e}'`:""}: AnyOf attributes must have at least one element.`,path:e});for(let n of this.elements){let{required:s,hidden:o,savedAs:i}=n.props;if(s!==void 0&&s!=="atLeastOnce"&&s!=="always")throw new d("schema.anyOf.optionalElements",{message:`Invalid anyOf elements${e!==void 0?` at path '${e}'`:""}: AnyOf elements must be required.`,path:e});if(o!==void 0&&o!==!1)throw new d("schema.anyOf.hiddenElements",{message:`Invalid anyOf elements${e!==void 0?` at path '${e}'`:""}: AnyOf elements cannot be hidden.`,path:e});if(i!==void 0)throw new d("schema.anyOf.savedAsElements",{message:`Invalid anyOf elements${e!==void 0?` at path '${e}'`:""}: AnyOf elements cannot be renamed (have savedAs prop).`,path:e});if(wn(n))throw new d("schema.anyOf.defaultedElements",{message:`Invalid anyOf elements${e!==void 0?` at path '${e}'`:""}: AnyOf elements cannot have default or linked values.`,path:e})}let{discriminator:r}=this.props;if(r!==void 0&&!(r in this[Vr]))throw new d("schema.anyOf.invalidDiscriminator",{message:`Invalid discriminator${e!==void 0?` at path '${e}'`:""}: All elements must be map or anyOf schemas and discriminator must be the key of a string enum schema.`,path:e,payload:{discriminator:r}});this.elements.forEach((n,s)=>{n.check(`${e??""}[${s}]`)}),Object.freeze(this.props),Object.freeze(this.elements)}get[Vr](){var e;return this[rs]===void 0&&(this[rs]=(e=this.elements.map(xp).reduce(wp,void 0))!==null&&e!==void 0?e:{}),this[rs]}match(e){if(this[jr]===void 0){this[jr]={};let{discriminator:r}=this.props;if(r===void 0)return;for(let n of this.elements)this[jr]={...this[jr],...Bo(n,r)}}return this[jr][e]}},xp=t=>{var e;switch(t.type){case"anyOf":return t[Vr];case"map":{let r={};for(let[n,s]of Object.entries(t.attributes))s.type==="string"&&s.props.enum!==void 0&&(s.props.required===void 0||s.props.required!=="never")&&s.props.transform===void 0&&(r[n]=(e=s.props.savedAs)!==null&&e!==void 0?e:n);return r}default:return{}}},wp=(t,e)=>{if(t===void 0)return e;if(e===void 0)return t;let[r,n]=[t,e].sort((o,i)=>Object.keys(o).length>Object.keys(i).length?1:-1),s={};for(let[o,i]of Object.entries(r))o in n&&n[o]===i&&(s[o]=i);return s},Bo=(t,e)=>{var r;switch(t.type){case"anyOf":{let n={};for(let s of t.elements)n={...n,...Bo(s,e)};return n}case"map":{let n={},s=t.attributes[e];if(s?.type==="string")for(let o of(r=s.props.enum)!==null&&r!==void 0?r:[])n[o]=t;return n}default:return{}}};var Ws=t=>t;var pr=t=>typeof t=="function";var Fo=t=>pr(t);var Uo=t=>!Fo(t);var ns=t=>typeof t=="bigint";var ss=t=>t instanceof Uint8Array;var Mo=t=>t===null;var He=t=>typeof t=="number"&&!Number.isNaN(t);var bt=(t,e)=>{switch(t.type){case"null":return Mo(e);case"boolean":return Se(e);case"number":return He(e)||!!(t.props.big&&ns(e));case"string":return M(e);case"binary":return ss(e)}};var kt=(t,e)=>{We(t.props,e);let{type:r,props:n}=t,{enum:s}=n;s?.forEach(o=>{if(!bt(t,o))throw new d("schema.primitive.invalidEnumValueType",{message:`Invalid enum value type${e!==void 0?` at path '${e}'`:""}. Expected: ${r}. Received: ${String(o)}.`,path:e,payload:{expectedType:r,enumValue:o}})});for(let o of[n.keyDefault,n.putDefault,n.updateDefault])if(o!==void 0&&Uo(o)){if(!bt(t,o))throw new d("schema.primitive.invalidDefaultValueType",{message:`Invalid default value type${e!==void 0?` at path '${e}'`:""}: Expected: ${r}. Received: ${String(o)}.`,path:e,payload:{expectedType:r,defaultValue:o}});if(s!==void 0&&!s.some(i=>i===o))throw new d("schema.primitive.invalidDefaultValueRange",{message:`Invalid default value${e!==void 0?` at path '${e}'`:""}: Expected one of: ${s.join(", ")}. Received: ${String(o)}.`,path:e,payload:{enumValues:s,defaultValue:o}})}};var $t=class{constructor(e){this.type="binary",this.props=e}get checked(){return Object.isFrozen(this.props)}check(e){this.checked||(kt(this,e),Object.freeze(this.props))}};var Gt=t=>t;var Rr=class{constructor(e){this.type="boolean",this.props=e}get checked(){return Object.isFrozen(this.props)}check(e){this.checked||(kt(this,e),Object.freeze(this.props))}};var qr=(t={})=>new gn(t),gn=class t extends Rr{required(e="atLeastOnce"){return new t(w(this.props,{required:e}))}optional(){return this.required("never")}hidden(e=!0){return new t(w(this.props,{hidden:e}))}key(e=!0){return new t(w(this.props,{key:e,required:"always"}))}savedAs(e){return new t(w(this.props,{savedAs:e}))}enum(...e){return new t(w(this.props,{enum:Gt(e)}))}const(e){return re(this.props.key,new t(w(this.props,{enum:[e],keyDefault:e})),new t(w(this.props,{enum:[e],putDefault:e})))}transform(e){return new t(w(this.props,{transform:e}))}keyDefault(e){return new t(w(this.props,{keyDefault:e}))}putDefault(e){return new t(w(this.props,{putDefault:e}))}updateDefault(e){return new t(w(this.props,{updateDefault:e}))}default(e){return re(this.props.key,new t(w(this.props,{keyDefault:e})),new t(w(this.props,{putDefault:e})))}keyLink(e){return new t(w(this.props,{keyLink:e}))}putLink(e){return new t(w(this.props,{putLink:e}))}updateLink(e){return new t(w(this.props,{updateLink:e}))}link(e){return re(this.props.key,new t(w(this.props,{keyLink:e})),new t(w(this.props,{putLink:e})))}keyValidate(e){return new t(w(this.props,{keyValidator:e}))}putValidate(e){return new t(w(this.props,{putValidator:e}))}updateValidate(e){return new t(w(this.props,{updateValidator:e}))}validate(e){return re(this.props.key,new t(w(this.props,{keyValidator:e})),new t(w(this.props,{putValidator:e})))}clone(e={}){return new t(w(this.props,e))}build(e){return new e(this)}};var Je=class{constructor(e){this.type="item",this.attributes=e,this.props={},this.savedAttributeNames=new Set,this.keyAttributeNames=new Set,this.requiredAttributeNames={always:new Set,atLeastOnce:new Set,never:new Set};for(let[r,n]of Object.entries(e)){let{key:s=!1,required:o="atLeastOnce",savedAs:i=r}=n.props;this.savedAttributeNames.add(i),s&&this.keyAttributeNames.add(r),this.requiredAttributeNames[o].add(r)}}get checked(){return Object.isFrozen(this.props)}check(e){if(this.checked)return;We(this.props,e);let r=new Set,n=new Set,s={always:new Set,atLeastOnce:new Set,never:new Set};for(let[o,i]of Object.entries(this.attributes)){let{savedAs:a=o,key:m,required:p="atLeastOnce"}=i.props;if(r.has(a))throw new d("schema.item.duplicateSavedAs",{message:`Invalid item attributes${e!==void 0?` at path '${e}'`:""}: More than two attributes are saved as '${a}'.`,path:e,payload:{savedAs:a}});r.add(a),m!==void 0&&m&&n.add(o),s[p].add(o)}for(let[o,i]of Object.entries(this.attributes))i.check([e,o].filter(Boolean).join("."));Object.freeze(this.props),Object.freeze(this.attributes),Object.freeze(this.savedAttributeNames),Object.freeze(this.keyAttributeNames),Object.freeze(this.requiredAttributeNames)}};var os=t=>t.clone({keyLink:void 0,putLink:void 0,updateLink:void 0});var Pt=t=>new Sn(Ws(t)),Sn=class t extends Je{pick(...e){let r={};for(let n of e)n in this.attributes&&(r[n]=os(this.attributes[n]));return new t(r)}omit(...e){let r={},n=new Set(e);for(let s of Object.keys(this.attributes)){if(n.has(s))continue;let o=s;r[o]=os(this.attributes[o])}return new t(r)}and(e){let r=typeof e=="function"?e(this):e,n={...this.attributes};for(let[s,o]of Object.entries(r))n[s]=o;return new t(n)}build(e){return new e(this)}};var K=class{constructor(e){this.type="number",this.props=e}get checked(){return Object.isFrozen(this.props)}check(e){if(this.checked)return;kt(this,e);let{big:r}=this.props;if(r!==void 0&&!Se(r))throw new d("schema.invalidProp",{message:`Invalid property type${e!==void 0?` at path '${e}'`:""}. Property: 'big'. Expected: boolean. Received: ${String(r)}.`,path:e,payload:{propName:"big",received:r}});Object.freeze(this.props)}};var G=(t={})=>new On(t),On=class t extends K{required(e="atLeastOnce"){return new t(w(this.props,{required:e}))}optional(){return this.required("never")}hidden(e=!0){return new t(w(this.props,{hidden:e}))}key(e=!0){return new t(w(this.props,{key:e,required:"always"}))}savedAs(e){return new t(w(this.props,{savedAs:e}))}enum(...e){return new t(w(this.props,{enum:Gt(e)}))}const(e){return re(this.props.key,new t(w(this.props,{enum:[e],keyDefault:e})),new t(w(this.props,{enum:[e],putDefault:e})))}transform(e){return new t(w(this.props,{transform:e}))}big(e=!0){return new t(w(this.props,{big:e}))}keyDefault(e){return new t(w(this.props,{keyDefault:e}))}putDefault(e){return new t(w(this.props,{putDefault:e}))}updateDefault(e){return new t(w(this.props,{updateDefault:e}))}default(e){return re(this.props.key,new t(w(this.props,{keyDefault:e})),new t(w(this.props,{putDefault:e})))}keyLink(e){return new t(w(this.props,{keyLink:e}))}putLink(e){return new t(w(this.props,{putLink:e}))}updateLink(e){return new t(w(this.props,{updateLink:e}))}link(e){return re(this.props.key,new t(w(this.props,{keyLink:e})),new t(w(this.props,{putLink:e})))}keyValidate(e){return new t(w(this.props,{keyValidator:e}))}putValidate(e){return new t(w(this.props,{putValidator:e}))}updateValidate(e){return new t(w(this.props,{updateValidator:e}))}validate(e){return re(this.props.key,new t(w(this.props,{keyValidator:e})),new t(w(this.props,{putValidator:e})))}clone(e={}){return new t(w(this.props,e))}build(e){return new e(this)}};var Ee=class{constructor(e){this.type="string",this.props=e}get checked(){return Object.isFrozen(this.props)}check(e){this.checked||(kt(this,e),Object.freeze(this.props))}};var he=(t={})=>new vn(t),vn=class t extends Ee{required(e="atLeastOnce"){return new t(w(this.props,{required:e}))}optional(){return this.required("never")}hidden(e=!0){return new t(w(this.props,{hidden:e}))}key(e=!0){return new t(w(this.props,{key:e,required:"always"}))}savedAs(e){return new t(w(this.props,{savedAs:e}))}enum(...e){return new t(w(this.props,{enum:Gt(e)}))}const(e){return re(this.props.key,new t(w(this.props,{enum:[e],keyDefault:e})),new t(w(this.props,{enum:[e],putDefault:e})))}transform(e){return new t(w(this.props,{transform:e}))}keyDefault(e){return new t(w(this.props,{keyDefault:e}))}putDefault(e){return new t(w(this.props,{putDefault:e}))}updateDefault(e){return new t(w(this.props,{updateDefault:e}))}default(e){return re(this.props.key,new t(w(this.props,{keyDefault:e})),new t(w(this.props,{putDefault:e})))}keyLink(e){return new t(w(this.props,{keyLink:e}))}putLink(e){return new t(w(this.props,{putLink:e}))}updateLink(e){return new t(w(this.props,{updateLink:e}))}link(e){return re(this.props.key,new t(w(this.props,{keyLink:e})),new t(w(this.props,{putLink:e})))}keyValidate(e){return new t(w(this.props,{keyValidator:e}))}putValidate(e){return new t(w(this.props,{putValidator:e}))}updateValidate(e){return new t(w(this.props,{updateValidator:e}))}validate(e){return re(this.props.key,new t(w(this.props,{keyValidator:e})),new t(w(this.props,{putValidator:e})))}clone(e={}){return new t(w(this.props,e))}build(e){return new e(this)}};var ce=class{constructor(e){this.schema=e}};var W=t=>{if(typeof t!="object"||t===null)return t;if(t instanceof Date)return new Date(t.getTime());if(t instanceof Array)return t.map(W);if(t instanceof Set)return new Set([...t.values()].map(W));if(t instanceof Uint8Array)return Uint8Array.from(t);if(t instanceof Object)return Object.fromEntries([...Object.entries(t).map(([e,r])=>[e,W(r)]),...Object.getOwnPropertySymbols(t).map(e=>[e,W(t[e])])]);throw new Error("Unable to clone object")};var Lr=t=>t instanceof Set;var S=t=>typeof t=="object"&&t!==null&&!X(t)&&!Lr(t)&&!ss(t);var $p=["[","]","."],$=t=>{let e="",r=!0;for(let n of t)M(n)&&($p.some(o=>n.includes(o))?e+=`['${n}']`:e+=`${r?"":"."}${n}`),He(n)&&(e+=`[${n}]`),r=!1;return e};var Qo=(t,e)=>({isExtension:!1,unextendedInput:e}),Xo=(t,e)=>{var r,n;switch(e){case"put":return((r=t.props)===null||r===void 0?void 0:r.required)!=="never";case"key":case"update":return((n=t.props)===null||n===void 0?void 0:n.required)==="always"}},Pp=(t,e)=>{if(t.props.key)return t.props.keyValidator;switch(e){case"key":return t.props.keyValidator;case"put":return t.props.putValidator;case"update":return t.props.updateValidator}},qe=(t,e,r={})=>{let{mode:n="put",valuePath:s}=r,o=Pp(t,n);if(o!==void 0){let i=o(e,t);if(i!==!0){let a=s!==void 0?$(s):void 0;throw new d("parsing.customValidationFailed",{message:`Custom validation${a!==void 0?` for attribute '${a}'`:""} failed${M(i)?` with message: ${i}`:""}.`,path:a,payload:{received:e,validationResult:i}})}}};function*Yo(t,e,r={}){let{fill:n=!0,transform:s=!0}=r,o;if(n){let m=W(e);yield m,o=m,yield o}let i=o??W(e);if(i!==void 0&&qe(t,i,r),s)yield i;else return i;return t.props.transform!==void 0?t.props.transform.encode(i):i}function*Zo(t,e,r={}){let{discriminator:n}=t.props,{fill:s=!0,transform:o=!0,valuePath:i}=r,a,m,p,c;if(n!==void 0&&S(e)&&n in e){let l=e[n],y=M(l)?t.match(l):void 0;y!==void 0&&(a=ge(y,e,r),s&&(m=a.next().value,p=a.next().value),c=a.next().value)}if(a===void 0)for(let l of t.elements)try{a=ge(l,e,r),s&&(m=a.next().value,p=a.next().value),c=a.next().value;break}catch{a=void 0,m=void 0,p=void 0,c=void 0;continue}if(s){let l=m??W(e);yield l,yield p??l}let u=c;if(a===void 0||u===void 0){let l=i!==void 0?$(i):void 0;throw new d("parsing.invalidAttributeInput",{message:`Attribute${l!==void 0?` '${l}'`:""} does not match any of the possible sub-types.`,path:l,payload:{received:e}})}if(u!==void 0&&qe(t,u,r),o)yield u;else return u;return a.next().value}function*_o(t,e,r={}){let{valuePath:n,...s}=r,{fill:o=!0,transform:i=!0}=s,a=[],m=X(e);if(m&&(a=e.map((u,f)=>ge(t.elements,u,{...s,valuePath:[...n??[],f],defined:!1}))),o)if(m){let f=yield a.map(y=>y.next().value);yield a.map(y=>y.next(f).value)}else{let u=W(e);yield u,yield u}if(!m){let{type:u}=t,f=n!==void 0?$(n):void 0;throw new d("parsing.invalidAttributeInput",{message:`Attribute${f!==void 0?` '${f}'`:""} should be a ${u}.`,path:f,payload:{received:e,expected:u}})}let p=a.map(u=>u.next().value);if(p!==void 0&&qe(t,p,r),i)yield p;else return p;return a.map(u=>u.next().value)}function*ei(t,e,r={}){let{valuePath:n,...s}=r,{mode:o="put",fill:i=!0,transform:a=!0}=s,m={},p=[],c=S(e);if(c){let l=new Set(Object.keys(e));Object.entries(t.attributes).filter(([,y])=>o!=="key"||y.props.key).forEach(([y,x])=>{m[y]=ge(x,e[y],{...s,valuePath:[...n??[],y],defined:!1}),l.delete(y)}),p=[...l.values()].map(y=>[y,W(e[y])])}if(i)if(c){let y=yield Object.fromEntries([...Object.entries(m).map(([b,O])=>[b,O.next().value]).filter(([,b])=>b!==void 0),...p]);yield Object.fromEntries([...Object.entries(m).map(([b,O])=>[b,O.next(y).value]).filter(([,b])=>b!==void 0),...p])}else{let l=W(e);yield l,yield l}if(!c){let{type:l}=t,y=n!==void 0?$(n):void 0;throw new d("parsing.invalidAttributeInput",{message:`Attribute${y!==void 0?` '${y}'`:""} should be a ${l}.`,path:y,payload:{received:e,expected:l}})}let u=Object.fromEntries(Object.entries(m).map(([l,y])=>[l,y.next().value]).filter(([,l])=>l!==void 0));if(u!==void 0&&qe(t,u,r),a)yield u;else return u;return Object.fromEntries(Object.entries(m).map(([l,y])=>{var x;return[(x=t.attributes[l].props.savedAs)!==null&&x!==void 0?x:l,y.next().value]}).filter(([,l])=>l!==void 0))}function*ti(t,e,r={}){let{fill:n=!0,transform:s=!0,valuePath:o}=r,i=e;if(n){let c=W(e);yield c,yield c}if(!bt(t,i)){let{type:c}=t,u=o!==void 0?$(o):void 0;throw new d("parsing.invalidAttributeInput",{message:`Attribute${u!==void 0?` '${u}'`:""} should be a ${c}.`,path:u,payload:{received:i,expected:c}})}let{props:a}=t;if(a.enum!==void 0&&!a.enum.includes(i)){let c=o!==void 0?$(o):void 0;throw new d("parsing.invalidAttributeInput",{message:`Attribute${c!==void 0?` '${c}'`:""} should be one of: ${a.enum.map(String).join(", ")}.`,path:c,payload:{received:i,expected:a.enum}})}let m=i;if(qe(t,m,r),s)yield m;else return m;return a.transform!==void 0?a.transform.encode(m):m}function*ri(t,e,r={}){let{valuePath:n,...s}=r,{fill:o=!0,transform:i=!0}=s,a=[],m=[],p=new Set(t.keys.props.enum),c=S(e);if(c)for(let[l,y]of Object.entries(e)){if(y===void 0){m.push([l,void 0]);continue}p.delete(l);let x=[...n??[],l];a.push([ge(t.keys,l,{...s,valuePath:x}),ge(t.elements,y,{...s,defined:!1,valuePath:x})])}if(!t.props.partial&&r.mode!=="update")for(let l of p){let y=[...n??[],l];a.push([ge(t.keys,l,{...s,valuePath:y}),ge(t.elements,void 0,{...s,defined:!1,valuePath:y})])}if(o)if(c){let y=yield Object.fromEntries([...a.map(([b,O])=>[b.next().value,O.next().value]).filter(([,b])=>b!==void 0),...m]);yield Object.fromEntries([...a.map(([b,O])=>[b.next().value,O.next(y).value]).filter(([,b])=>b!==void 0),...m])}else{let l=W(e);yield l,yield l}if(!c){let{type:l}=t,y=n!==void 0?$(n):void 0;throw new d("parsing.invalidAttributeInput",{message:`Attribute${y!==void 0?` '${y}'`:""} should be a ${l}.`,path:y,payload:{received:e,expected:l}})}let u=Object.fromEntries(a.map(([l,y])=>[l.next().value,y.next().value]).filter(([,l])=>l!==void 0));if(u!==void 0&&qe(t,u,r),i)yield u;else return u;return Object.fromEntries(a.map(([l,y])=>[l.next().value,y.next().value]).filter(([,l])=>l!==void 0))}function*ni(t,e,r={}){let{valuePath:n,...s}=r,{fill:o=!0,transform:i=!0}=s,a=[],m=Lr(e);if(m&&(a=[...e.values()].map((u,f)=>ge(t.elements,u,{...s,valuePath:[...n??[],f],defined:!1}))),o)if(m)yield new Set(a.map(l=>l.next().value)),yield new Set(a.map(l=>l.next().value));else{let u=W(e);yield u,yield u}if(!m){let{type:u}=t,f=n!==void 0?$(n):void 0;throw new d("parsing.invalidAttributeInput",{message:`Attribute${f!==void 0?` '${f}'`:""} should be a ${u}.`,path:f,payload:{received:e,expected:u}})}let p=new Set(a.map(u=>u.next().value));if(p!==void 0&&qe(t,p,r),i)yield p;else return p;return new Set(a.map(u=>u.next().value))}function*ge(t,e,r={}){let{mode:n="put",fill:s=!0,transform:o=!0,defined:i=!1,parseExtension:a=Qo,valuePath:m}=r,p=e,c=s;if(c&&p===void 0){let x,b=Dp(t,n);x=pr(b)?b():W(b);let O=yield x,v=x;if(v===void 0&&O!==void 0){let D=Cp(t,n);v=pr(D)?D(O):v}yield v,p=v,c=!1}let u={...r,fill:c},{isExtension:f,extensionParser:l,unextendedInput:y}=a(t,p,{transform:o,valuePath:m});if(f){if(c){let x=p;yield x,yield x}return yield*l()}if(y===void 0){let x=m!==void 0?$(m):void 0;if(Xo(t,n)||i)throw new d("parsing.attributeRequired",{message:`Attribute${x!==void 0?` '${x}'`:""} is required.`,path:x});let b=y;if(o)yield b;else return b;return b}switch(t.type){case"any":return yield*Yo(t,y,u);case"null":case"boolean":case"number":case"string":case"binary":return yield*ti(t,y,u);case"set":return yield*ni(t,y,u);case"list":return yield*_o(t,y,u);case"map":return yield*ei(t,y,u);case"record":return yield*ri(t,y,u);case"anyOf":return yield*Zo(t,y,u)}}var Dp=(t,e)=>{let{props:r}=t;if(r.key)return r.keyDefault;switch(e){case"key":return r.keyDefault;case"put":return r.putDefault;case"update":return r.updateDefault}},Cp=(t,e)=>{let{props:r}=t;if(r.key)return r.keyLink;switch(e){case"key":return r.keyLink;case"put":return r.putLink;case"update":return r.updateLink}};function*si(t,e,r={}){let{mode:n="put",fill:s=!0,transform:o=!0}=r,i={},a=[],m=S(e);if(m){let u=new Set(Object.keys(e));Object.entries(t.attributes).filter(([,f])=>n!=="key"||f.props.key).forEach(([f,l])=>{i[f]=ge(l,e[f],{...r,valuePath:[f],defined:!1}),u.delete(f)}),a=[...u.values()].map(f=>[f,W(e[f])])}if(s)if(m){let u=Object.fromEntries([...Object.entries(i).map(([l,y])=>[l,y.next().value]).filter(([,l])=>l!==void 0),...a]);yield u,yield Object.fromEntries([...Object.entries(i).map(([l,y])=>[l,y.next(u).value]).filter(([,l])=>l!==void 0),...a])}else{let u=W(e);yield u,yield u}if(!m)throw new d("parsing.invalidItem",{message:"Items should be objects",payload:{received:e,expected:"object"}});let p=Object.fromEntries(Object.entries(i).map(([u,f])=>[u,f.next().value]).filter(([,u])=>u!==void 0));if(o)yield p;else return p;return Object.fromEntries(Object.entries(i).map(([u,f])=>{var l;return[(l=t.attributes[u].props.savedAs)!==null&&l!==void 0?l:u,f.next().value]}).filter(([,u])=>u!==void 0))}var E=class extends ce{start(e,r={}){return this.schema.type==="item"?si(this.schema,e,r):ge(this.schema,e,r)}parse(e,r={}){let n=this.start(e,r),s=!1,o;do{let i=n.next();s=!!i.done,o=i.value}while(!s);return o}reparse(e,r={}){return this.parse(e,r)}validate(e,r={}){try{this.parse(e,{...r,fill:!1,transform:!1})}catch(n){if(n instanceof d&&d.match(n,"parsing."))return!1;throw n}return!0}};E.actionName="parse";function*oi(t,e,r={}){let{format:n=!0,transform:s=!0}=r,o;if(s){let a=t.props.transform;if(o=a!==void 0?a.decode(e):W(e),n)yield o;else return o}return o??W(e)}function*ii(t,e,r={}){let{discriminator:n}=t.props,{format:s=!0,transform:o=!0,valuePath:i}=r,a,m,p,c=n&&o?t[Vr][n]:n;if(c!==void 0&&S(e)&&c in e){let l=e[c],y=M(l)?t.match(l):void 0;y!==void 0&&(a=De(y,e,r),o&&(m=a.next().value),s&&(p=a.next().value))}if(a===void 0)for(let l of t.elements)try{a=De(l,e,r),o&&(m=a.next().value),s&&(p=a.next().value);break}catch{continue}let u=m,f=p;if(o&&u===void 0||s&&f===void 0){let l=i!==void 0?$(i):void 0;throw new d("formatter.invalidAttribute",{message:`Invalid attribute detected while formatting. Attribute does not match any of the possible sub-types${l!==void 0?`: '${l}'`:""}.`,path:l,payload:{received:e}})}if(o)if(s)yield u;else return u;return f}var ur=t=>t.replace(/\\/g,"\\\\").replace(/[-[\]/{}()*+?.^$|]/g,"\\$&"),Dt=(t,e)=>{if(e===void 0)return{isProjected:!0};let r=[];for(let n of e){let s=n.match(t);if(s!==null){let o=s[0];r.push(n.slice(o.length))}}return r.length===0?{isProjected:!1}:r.some(n=>n==="")?{isProjected:!0}:{isProjected:!0,childrenAttributes:r}};function*ai(t,e,{attributes:r,valuePath:n,...s}={}){let{format:o=!0,transform:i=!0}=s;if(!X(e)){let{type:c}=t,u=n!==void 0?$(n):void 0;throw new d("formatter.invalidAttribute",{message:`Invalid attribute detected while formatting${u!==void 0?`: '${u}'`:""}. Should be a ${c}.`,path:u,payload:{received:e,expected:c}})}let{childrenAttributes:a}=Dt(/\[\d+\]/,r),m=e.map((c,u)=>De(t.elements,c,{attributes:a,valuePath:[...n??[],u],...s}));if(i){let c=m.map(u=>u.next().value);if(o)yield c;else return c}return m.map(c=>c.next().value)}function*mi(t,e,{attributes:r,valuePath:n,...s}={}){let{format:o=!0,transform:i=!0}=s;if(!S(e)){let{type:p}=t,c=n!==void 0?$(n):void 0;throw new d("formatter.invalidAttribute",{message:`Invalid attribute detected while formatting${c!==void 0?`: '${c}'`:""}. Should be a ${p}.`,path:c,payload:{received:e,expected:p}})}let a={};for(let[p,c]of Object.entries(t.attributes)){let{props:u}=c,{savedAs:f}=u,l=ur(p),{isProjected:y,childrenAttributes:x}=Dt(new RegExp(`^\\.${l}|^\\['${l}']`),r);if(!y)continue;let b=i?f??p:p;a[p]=De(c,e[b],{attributes:x,valuePath:[...n??[],b],...s})}if(i){let p=Object.fromEntries(Object.entries(a).map(([c,u])=>[c,u.next().value]).filter(([,c])=>c!==void 0));if(o)yield p;else return p}return Object.fromEntries(Object.entries(a).map(([p,c])=>[p,c.next().value]).filter(([p,c])=>{var u;return((u=t.attributes[p])===null||u===void 0?void 0:u.props.hidden)!==!0&&c!==void 0}))}function*pi(t,e,{format:r=!0,transform:n=!0,valuePath:s}={}){let{props:o}=t;if(!bt(t,e)){let{type:m}=t,p=s!==void 0?$(s):void 0;throw new d("formatter.invalidAttribute",{message:`Invalid attribute detected while formatting${p!==void 0?`: '${p}'`:""}. Should be a ${m}.`,path:p,payload:{received:e,expected:m}})}let i;if(n){let m=o.transform;i=m!==void 0?m.decode(e):e}else i=e;if(o.enum!==void 0&&!o.enum.includes(i)){let m=s!==void 0?$(s):void 0;throw new d("formatter.invalidAttribute",{message:`Invalid attribute detected while formatting${m!==void 0?`: '${m}'`:""}. Should be one of: ${o.enum.map(String).join(", ")}.`,path:m,payload:{received:i,expected:o.enum}})}if(n)if(r)yield i;else return i;return i}function*ui(t,e,{attributes:r,valuePath:n,...s}={}){let{format:o=!0,transform:i=!0,partial:a=!1}=s;if(!S(e)){let{type:u}=t,f=n!==void 0?$(n):void 0;throw new d("formatter.invalidAttribute",{message:`Invalid attribute detected while formatting${f!==void 0?`: '${f}'`:""}. Should be a ${u}.`,path:f,payload:{received:e,expected:u}})}let m=[],p=new Set(t.keys.props.enum);for(let[u,f]of Object.entries(e)){if(f===void 0)continue;let l=[...n??[],u],y=new Ct(t.keys).format(u,{transform:i,valuePath:l});p.delete(y);let x=ur(y),{isProjected:b,childrenAttributes:O}=Dt(new RegExp(`^\\.${x}|^\\['${x}']`),r);b&&m.push([y,De(t.elements,f,{attributes:O,valuePath:l,...s})])}if(!t.props.partial&&!a)for(let u of p){let f=ur(u),{isProjected:l,childrenAttributes:y}=Dt(new RegExp(`^\\.${f}|^\\['${f}']`),r);if(!l)continue;let x=i&&t.keys.props.transform!==void 0?[...n??[],t.keys.props.transform.encode(u)]:[...n??[],u];m.push([u,De(t.elements,void 0,{attributes:y,valuePath:x,...s})])}if(i){let u=Object.fromEntries(m.map(([f,l])=>[f,l.next().value]).filter(([,f])=>f!==void 0));if(o)yield u;else return u}return Object.fromEntries(m.map(([u,f])=>[u,f.next().value]).filter(([,u])=>u!==void 0))}function*ci(t,e,{valuePath:r,...n}={}){let{format:s=!0,transform:o=!0}=n;if(!Lr(e)){let{type:m}=t,p=r!==void 0?$(r):void 0;throw new d("formatter.invalidAttribute",{message:`Invalid attribute detected while formatting${p!==void 0?`: '${p}'`:""}. Should be a ${m}.`,path:p,payload:{received:e,expected:m}})}let i=[...e.values()].map((m,p)=>De(t.elements,m,{...n,valuePath:[...r??[],p],attributes:void 0}));if(o){let m=new Set(i.map(p=>p.next().value).filter(p=>p!==void 0));if(s)yield m;else return m}return new Set(i.map(m=>m.next().value).filter(m=>m!==void 0))}var Tp=new Set(["always","atLeastOnce"]),Np=({props:t})=>{var e;return Tp.has((e=t.required)!==null&&e!==void 0?e:"atLeastOnce")};function*De(t,e,r={}){let{format:n=!0,transform:s=!0,valuePath:o}=r;if(e===void 0){if(Np(t)&&r.partial!==!0){let i=o!==void 0?$(o):void 0;throw new d("formatter.missingAttribute",{message:`Missing required attribute for formatting${i!==void 0?`: '${i}'`:""}.`,path:i,payload:{}})}if(s)if(n)yield void 0;else return;return}switch(t.type){case"any":return yield*oi(t,e,r);case"null":case"boolean":case"number":case"string":case"binary":return yield*pi(t,e,{...r,attributes:void 0});case"set":return yield*ci(t,e,{...r,attributes:void 0});case"list":return yield*ai(t,e,r);case"map":return yield*mi(t,e,r);case"record":return yield*ui(t,e,r);case"anyOf":return yield*ii(t,e,r)}}function*di(t,e,{attributes:r,...n}={}){let{format:s=!0,transform:o=!0}=n;if(!S(e))throw new d("formatter.invalidItem",{message:"Invalid item detected while formatting. Should be an object.",payload:{received:e,expected:"Object"}});let i={};for(let[m,p]of Object.entries(t.attributes)){let{savedAs:c}=p.props,u=ur(m),{isProjected:f,childrenAttributes:l}=Dt(new RegExp(`^${u}|^\\['${u}']`),r);if(!f)continue;let y=o?c??m:m;i[m]=De(p,e[y],{attributes:l,valuePath:[y],...n})}if(o){let m=Object.fromEntries(Object.entries(i).map(([p,c])=>[p,c.next().value]).filter(([,p])=>p!==void 0));if(s)yield m;else return m}return Object.fromEntries(Object.entries(i).map(([m,p])=>[m,p.next().value]).filter(([m,p])=>{var c;return((c=t.attributes[m])===null||c===void 0?void 0:c.props.hidden)!==!0&&p!==void 0}))}var Ct=class extends ce{start(e,r={}){return this.schema.type==="item"?di(this.schema,e,r):De(this.schema,e,r)}format(e,r={}){let n=this.start(e,r),s=!1,o;do{let i=n.next();s=!!i.done,o=i.value}while(!s);return o}validate(e){try{this.format(e,{format:!1})}catch(r){if(r instanceof d&&d.match(r,"formatter."))return!1;throw r}return!0}};Ct.actionName="format";var li=(...t)=>{let e=t.map(n=>n.source).join("|"),r=new Set(t.flatMap(n=>[...n.flags]));return new RegExp(e,[...r].join(""))};var Ip=/\[(\d+)\]/g,Vp=/\['(.+?)'\]/g,jp=/[\w#@-]+(?=(\.|\[|$))/g,Rp=li(Ip,Vp,jp),is=t=>{var e;if(t==="")return[];let r=[],n;for(let s of t.matchAll(Rp)){let[o,i,a,m]=s;n=m;let p=(e=a??i)!==null&&e!==void 0?e:o;switch(a!==void 0?"escapedStr":i!==void 0?"listIndex":"regularStr"){case"listIndex":r.push(parseInt(p));break;default:r.push(p)}}if(r.length===0||n!==void 0&&n.length>0)throw new d("actions.invalidExpressionAttributePath",{message:`Unable to match expression attribute path with schema: ${t}`,payload:{attributePath:t}});return r};var Me=class t{static fromArray(e){return new t($(e),e)}constructor(e="",r=is(e)){this.arrayPath=r,this.strPath=$(this.arrayPath)}prepend(...e){return this.prependPath(t.fromArray(e))}prependPath(e){return new t([e.strPath,this.strPath].filter(Boolean).join(this.strPath[0]!=="["?".":""),e.arrayPath.concat(this.arrayPath))}append(...e){return this.appendPath(t.fromArray(e))}appendPath(e){return new t([this.strPath,e.strPath].filter(Boolean).join(e.strPath[0]!=="["?".":""),this.arrayPath.concat(e.arrayPath))}};var fi=t=>{let e="",r={},n={},s=1;return t.forEach((o,i)=>{i>0&&(e+=", "),new Me(o).arrayPath.forEach((a,m)=>{if(He(a)){e+=`[${a}]`;return}let p=n[a];p===void 0&&(p=`#p_${s}`,n[a]=p,r[p]=a,s++),m>0&&(e+="."),e+=p})}),{ProjectionExpression:e,ExpressionAttributeNames:r}};var ze=t=>He(t)&&Number.isInteger(t);var xt=class extends ce{constructor({schema:e,formattedPath:r,transformedPath:n}){super(e),this.formattedPath=r,this.transformedPath=n}};var z=class extends ce{search(e){return An(this.schema,is(e))}};z.actionName="finder";var An=(t,e)=>{var r;let[n,...s]=e;if(n===void 0)return[new xt({schema:t,formattedPath:new Me,transformedPath:new Me})];switch(t.type){case"any":return[new xt({schema:new nt({}),formattedPath:Me.fromArray(e),transformedPath:Me.fromArray(e)})];case"null":case"boolean":case"number":case"string":case"binary":case"set":return[];case"record":{let o=t.keys,i;try{i=new E(o).parse(n)}catch{return[]}return An(t.elements,s).map(({schema:a,formattedPath:m,transformedPath:p})=>new xt({schema:a,formattedPath:m.prepend(n),transformedPath:p.prepend(i)}))}case"item":case"map":{let o=t.attributes[n];if(!o)return[];let i=(r=o.props.savedAs)!==null&&r!==void 0?r:n;return An(o,s).map(({schema:a,formattedPath:m,transformedPath:p})=>new xt({schema:a,formattedPath:m.prepend(n),transformedPath:p.prepend(i)}))}case"list":return ze(n)?An(t.elements,s).map(({schema:o,formattedPath:i,transformedPath:a})=>new xt({schema:o,formattedPath:i.prepend(n),transformedPath:a.prepend(n)})):[];case"anyOf":return t.elements.map(o=>An(o,e)).flat()}};var L=class{constructor({serializer:e=JSON.stringify}={}){this.values=[],this.serializedValues=new Set,this.serializer=e}push(e){let r=this.serializer(e),n=this.serializedValues.has(r);return n||(this.values.push(e),this.serializedValues.add(r)),n}};var hi=(t,e,{strict:r=!0}={})=>{let n=new L({serializer:o=>o}),s=new z(t);for(let o of e){let i=s.search(o);if(i.length===0&&r)throw new d("actions.invalidExpressionAttributePath",{message:`Unable to match expression attribute path with schema: ${o}`,payload:{attributePath:o}});for(let a of i)n.push(a.transformedPath.strPath)}return n.values};var Wt=class t extends ce{static express(e){return fi(e)}transform(e,r){return hi(this.schema,e,r)}parse(e,r){return t.express(this.transform(e,r))}};Wt.actionName="parsePath";var me=(t,e="",r,n=!1)=>{let s="";return new Me(t).arrayPath.forEach((o,i)=>{if(He(o)){s+=`[${o}]`;return}let a=r.tokens[o];a===void 0&&(a=`#c${e}_${r.namesCursor}`,r.tokens[o]=a,r.ExpressionAttributeNames[a]=o,r.namesCursor++),i>0&&(s+="."),s+=a}),n&&(s=["size(",s,")"].join("")),s},eo=(t,e="",r)=>{let n=`:c${e}_${r.valuesCursor}`;return r.ExpressionAttributeValues[n]=t,r.valuesCursor++,n},qp=t=>S(t),Oe=(t,e="",r)=>qp(t)?me(t.attr,e,r):eo(t,e,r);var yi=(t,e="",r)=>{let n="",{attr:s,beginsWith:o}=t;return n+="begins_with(",n+=me(s,e,r),n+=", ",n+=Oe(o,e,r),n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var bi=(t,e="",r)=>{let n="",{between:s}=t,[o,i]=s,a="size"in t,m=a?t.size:t.attr;return n+=me(m,e,r,a),n+=" BETWEEN ",n+=Oe(o,e,r),n+=" AND ",n+=Oe(i,e,r),{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var xi=(t,e="",r)=>{let n="",{attr:s,contains:o}=t;return n+="contains(",n+=me(s,e,r),n+=", ",n+=Oe(o,e,r),n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var wi=(t,e="",r)=>{let n="",{eq:s}=t,o="size"in t,i=o?t.size:t.attr;return n+=me(i,e,r,o),n+=" = ",n+=Oe(s,e,r),{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}},Ei=(t,e="",r)=>{let n="",{ne:s}=t,o="size"in t,i=o?t.size:t.attr;return n+=me(i,e,r,o),n+=" <> ",n+=Oe(s,e,r),{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var gi=(t,e="",r)=>{let n="",{attr:s,exists:o}=t;return n+=o?"attribute_exists(":"attribute_not_exists(",n+=me(s,e,r),n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var Si=(t,e="",r)=>{let n="",{in:s}=t,o="size"in t,i=o?t.size:t.attr;return n+=me(i,e,r,o),n+=" IN (",n+=s.map(a=>Oe(a,e,r)).join(", "),n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var Oi=(t,e="",r)=>{let n="",{or:s}=t,[o,...i]=s;return i.length===0?Qe(o,e,r):(n+="(",n+=s.map(a=>Qe(a,e,r).ConditionExpression).join(") OR ("),n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues})},vi=(t,e="",r)=>{let n="",{and:s}=t,[o,...i]=s;return i.length===0?Qe(o,e,r):(n+="(",n+=s.map(a=>Qe(a,e,r).ConditionExpression).join(") AND ("),n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues})},Ai=(t,e="",r)=>{let n="",{not:s}=t;return n+="NOT (",n+=Qe(s,e,r).ConditionExpression,n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var ki=(t,e="",r)=>{let n="",{gte:s}=t,o="size"in t,i=o?t.size:t.attr;return n+=me(i,e,r,o),n+=" >= ",n+=Oe(s,e,r),{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}},$i=(t,e="",r)=>{let n="",{gt:s}=t,o="size"in t,i=o?t.size:t.attr;return n+=me(i,e,r,o),n+=" > ",n+=Oe(s,e,r),{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}},Pi=(t,e="",r)=>{let n="",{lte:s}=t,o="size"in t,i=o?t.size:t.attr;return n+=me(i,e,r,o),n+=" <= ",n+=Oe(s,e,r),{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}},Di=(t,e="",r)=>{let n="",{lt:s}=t,o="size"in t,i=o?t.size:t.attr;return n+=me(i,e,r,o),n+=" < ",n+=Oe(s,e,r),{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var Ci=(t,e="",r)=>{let n="",{attr:s,type:o}=t;return n+="attribute_type(",n+=me(s,e,r),n+=", ",n+=eo(o,e,r),n+=")",{ConditionExpression:n,ExpressionAttributeNames:r.ExpressionAttributeNames,ExpressionAttributeValues:r.ExpressionAttributeValues}};var Qe=(t,e="",r={namesCursor:1,valuesCursor:1,tokens:{},ExpressionAttributeNames:{},ExpressionAttributeValues:{}})=>{if("or"in t)return Oi(t,e,r);if("and"in t)return vi(t,e,r);if("not"in t)return Ai(t,e,r);if("eq"in t)return wi(t,e,r);if("ne"in t)return Ei(t,e,r);if("gte"in t)return ki(t,e,r);if("gt"in t)return $i(t,e,r);if("lte"in t)return Pi(t,e,r);if("lt"in t)return Di(t,e,r);if("between"in t)return bi(t,e,r);if("beginsWith"in t)return yi(t,e,r);if("in"in t)return Si(t,e,r);if("contains"in t)return xi(t,e,r);if("exists"in t)return gi(t,e,r);if("type"in t)return Ci(t,e,r);throw new d("actions.invalidCondition",{message:"Invalid condition: Unable to detect valid condition type."})};var ve=(t,e,r)=>S(e)&&"attr"in e&&M(e.attr)&&r!==!0?t.search(e.attr):void 0,de=(t,e)=>{let[r,...n]=t.values;if(r===void 0)throw new d("actions.invalidExpressionAttributePath",{message:`Unable to match expression attribute path with schema: ${e}`,payload:{attributePath:e}});return n.length>0?{or:[r,...n]}:r};var Ti=(t,e)=>{let r=new L,n=new z(t),{beginsWith:s,transform:o}=e,i=e.attr,a=n.search(i),m=ve(n,s,o);for(let p of a){let c=p.transformedPath.strPath;if(m!==void 0)for(let u of m){let f={attr:u.transformedPath.strPath};r.push({attr:c,beginsWith:f})}else{let u=p.schema,f=new E(u);try{let l=f.parse(s,{fill:!1,transform:o});r.push({attr:c,beginsWith:l})}catch{}}}return de(r,i)};var Ni=(t,e)=>{let r=new L,n=new z(t),{between:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i),[p,c]=s,u=ve(n,p,a),f=ve(n,c,a);for(let l of m){let y=l.transformedPath.strPath,x=o?new K({}):l.schema,b=new E(x),O=new L;if(u!==void 0)for(let v of u){let D={attr:v.transformedPath.strPath};if(f!==void 0)for(let V of f){let J={attr:V.transformedPath.strPath};O.push([D,J])}else try{let V=b.parse(c,{fill:!1,transform:a});O.push([D,V])}catch{}}else{let v;try{v=b.parse(p,{fill:!1,transform:a})}catch{continue}if(f!==void 0)for(let D of f){let V={attr:D.transformedPath.strPath};O.push([v,V])}else try{let D=b.parse(c,{fill:!1,transform:a});O.push([v,D])}catch{}}if(O.values.length!==0)for(let v of O.values)r.push(o?{size:y,between:v}:{attr:y,between:v})}return de(r,i)};var Ii=(t,e)=>{let r=new L,n=new z(t),{contains:s,transform:o}=e,i=e.attr,a=n.search(i),m=ve(n,s,o);for(let p of a){let c=p.transformedPath.strPath;if(m!==void 0)for(let u of m){let f={attr:u.transformedPath.strPath};r.push({attr:c,contains:f})}else try{let u=p.schema;switch(p.schema.type){case"set":case"list":u=p.schema.elements;break;case"string":u=new Ee({});break;default:}let l=new E(u).parse(s,{fill:!1,transform:o});r.push({attr:c,contains:l})}catch{}}return de(r,i)};var Vi=(t,e)=>{let r=new L,n=new z(t),{eq:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i),p=ve(n,s,a);for(let c of m){let u=c.transformedPath.strPath;if(p!==void 0)for(let f of p){let l={attr:f.transformedPath.strPath};r.push(o?{size:u,eq:l}:{attr:u,eq:l})}else{let f=o?new K({}):c.schema,l=new E(f);try{let y=l.parse(s,{fill:!1,transform:a});r.push(o?{size:u,eq:y}:{attr:u,eq:y})}catch{}}}return de(r,i)},ji=(t,e)=>{let r=new L,n=new z(t),{ne:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i),p=ve(n,s,a);for(let c of m){let u=c.transformedPath.strPath;if(p!==void 0)for(let f of p){let l={attr:f.transformedPath.strPath};r.push(o?{size:u,ne:l}:{attr:u,ne:l})}else{let f=o?new K({}):c.schema,l=new E(f);try{let y=l.parse(s,{fill:!1,transform:a});r.push(o?{size:u,ne:y}:{attr:u,ne:y})}catch{}}}return de(r,i)};var Ri=(t,e)=>{let r=new L,n=new z(t),{exists:s}=e,o=e.attr,i=n.search(o);for(let a of i){let m=a.transformedPath.strPath;r.push({attr:m,exists:s})}return de(r,o)};var qi=(t,e)=>{let r=new L,n=new z(t),{in:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i);for(let p of m){let c=p.transformedPath.strPath,u=o?new K({}):p.schema,f=new E(u),l=new L({serializer:x=>JSON.stringify({_:x})});for(let x of s){let b=ve(n,x,a);if(b!==void 0)for(let O of b)l.push({attr:O.transformedPath.strPath});else try{l.push(f.parse(x,{fill:!1,transform:a}))}catch{}}let y=l.values;y.length!==0&&r.push(o?{size:c,in:y}:{attr:c,in:y})}return de(r,i)};var Li=(t,e)=>({or:e.or.map(r=>cr(t,r))}),Bi=(t,e)=>({and:e.and.map(r=>cr(t,r))}),Fi=(t,e)=>({not:cr(t,e.not)});var Ui=(t,e)=>{let r=new L,n=new z(t),{gte:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i),p=ve(n,s,a);for(let c of m){let u=c.transformedPath.strPath;if(p!==void 0)for(let f of p){let l={attr:f.transformedPath.strPath};r.push(o?{size:u,gte:l}:{attr:u,gte:l})}else{let f=o?new K({}):c.schema,l=new E(f);try{let y=l.parse(s,{fill:!1,transform:a});r.push(o?{size:u,gte:y}:{attr:u,gte:y})}catch{}}}return de(r,i)},Mi=(t,e)=>{let r=new L,n=new z(t),{gt:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i),p=ve(n,s,a);for(let c of m){let u=c.transformedPath.strPath;if(p!==void 0)for(let f of p){let l={attr:f.transformedPath.strPath};r.push(o?{size:u,gt:l}:{attr:u,gt:l})}else{let f=o?new K({}):c.schema,l=new E(f);try{let y=l.parse(s,{fill:!1,transform:a});r.push(o?{size:u,gt:y}:{attr:u,gt:y})}catch{}}}return de(r,i)},zi=(t,e)=>{let r=new L,n=new z(t),{lte:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i),p=ve(n,s,a);for(let c of m){let u=c.transformedPath.strPath;if(p!==void 0)for(let f of p){let l={attr:f.transformedPath.strPath};r.push(o?{size:u,lte:l}:{attr:u,lte:l})}else{let f=o?new K({}):c.schema,l=new E(f);try{let y=l.parse(s,{fill:!1,transform:a});r.push(o?{size:u,lte:y}:{attr:u,lte:y})}catch{}}}return de(r,i)},Ki=(t,e)=>{let r=new L,n=new z(t),{lt:s}=e,o="size"in e,i=o?e.size:e.attr,a=o?void 0:e.transform,m=n.search(i),p=ve(n,s,a);for(let c of m){let u=c.transformedPath.strPath;if(p!==void 0)for(let f of p){let l={attr:f.transformedPath.strPath};r.push(o?{size:u,lt:l}:{attr:u,lt:l})}else{let f=o?new K({}):c.schema,l=new E(f);try{let y=l.parse(s,{fill:!1,transform:a});r.push(o?{size:u,lt:y}:{attr:u,lt:y})}catch{}}}return de(r,i)};var Lp=new Ee({enum:["S","SS","N","NS","B","BS","BOOL","NULL","L","M"]}),Bp=new E(Lp),Gi=(t,e)=>{let r=new L,n=new z(t),{type:s}=e,o=e.attr,i=n.search(o);for(let a of i){let m=a.transformedPath.strPath,p=Bp.parse(s,{fill:!1,transform:!1});r.push({attr:m,type:p})}return de(r,o)};var cr=(t,e)=>{if("or"in e)return Li(t,e);if("and"in e)return Bi(t,e);if("not"in e)return Fi(t,e);if("eq"in e)return Vi(t,e);if("ne"in e)return ji(t,e);if("gte"in e)return Ui(t,e);if("gt"in e)return Mi(t,e);if("lte"in e)return zi(t,e);if("lt"in e)return Ki(t,e);if("between"in e)return Ni(t,e);if("beginsWith"in e)return Ti(t,e);if("in"in e)return qi(t,e);if("contains"in e)return Ii(t,e);if("exists"in e)return Ri(t,e);if("type"in e)return Gi(t,e);throw new d("actions.invalidCondition",{message:"Invalid condition: Unable to detect valid condition type."})};var Le=class t extends ce{static express(e,r=""){return Qe(e,r)}transform(e){return cr(this.schema,e)}parse(e,{expressionId:r}={}){return t.express(this.transform(e),r)}};Le.actionName="parseCondition";var Wi=t=>({anyOf:t.elements.map(e=>Ce(e))});var Hi=t=>{let e=Object.entries(t.attributes).filter(([,n])=>!n.props.hidden),r=e.filter(([,{props:n}])=>n.required!=="never").map(([n])=>n);return{type:"object",properties:Object.fromEntries(e.map(([n,s])=>[n,Ce(s)])),...r.length>0?{required:r}:{}}};var Ji=t=>({type:"array",items:Ce(t.elements)});var Qi=t=>{let e=Object.entries(t.attributes).filter(([,n])=>!n.props.hidden),r=e.filter(([,{props:n}])=>n.required!=="never").map(([n])=>n);return{type:"object",properties:Object.fromEntries(e.map(([n,s])=>[n,Ce(s)])),...r.length>0?{required:r}:{}}};var Xi=t=>t.type==="binary"?{type:"string"}:{type:t.type};var Yi=t=>({type:"object",propertyNames:Ce(t.keys),additionalProperties:Ce(t.elements)});var Zi=t=>({type:"array",items:Ce(t.elements),uniqueItems:!0});var Ce=t=>{switch(t.type){case"any":return{};case"null":case"boolean":case"number":case"string":case"binary":return Xi(t);case"set":return Zi(t);case"list":return Ji(t);case"map":return Qi(t);case"record":return Yi(t);case"anyOf":return Wi(t);case"item":return Hi(t)}};var kn=class extends ce{formattedValueSchema(){return Ce(this.schema)}};kn.actionName="jsonSchemer";var Be=t=>{let e={};for(let r of["keyDefault","putDefault","updateDefault"]){let n=t.props[r];n!==void 0&&(e[r]=pr(n)?{defaulterId:"custom"}:{defaulterId:"value",value:n})}return e},as=t=>S(t)&&"transformerId"in t&&"toJSON"in t;var _i=t=>{let e=Be(t),{required:r,hidden:n,key:s,savedAs:o,transform:i}=t.props;return{type:"any",...r!==void 0&&r!=="atLeastOnce"?{required:r}:{},...n!==void 0&&n?{hidden:n}:{},...s!==void 0&&s?{key:s}:{},...o!==void 0?{savedAs:o}:{},...i!==void 0?{transform:as(i)?i.toJSON():{transformerId:"custom"}}:{},...e}};var ea=t=>{let e=Be(t),{required:r,hidden:n,key:s,savedAs:o,discriminator:i}=t.props;return{type:"anyOf",elements:t.elements.map(Ae),...r!==void 0&&r!=="atLeastOnce"?{required:r}:{},...n!==void 0&&n?{hidden:n}:{},...s!==void 0&&s?{key:s}:{},...o!==void 0?{savedAs:o}:{},...i!==void 0?{discriminator:i}:{},...e}};var ta=t=>({type:"item",attributes:Object.fromEntries(Object.entries(t.attributes).map(([e,r])=>[e,Ae(r)]))});var ra=t=>{let e=Be(t),{required:r,hidden:n,key:s,savedAs:o}=t.props;return{type:"list",elements:Ae(t.elements),...r!==void 0&&r!=="atLeastOnce"?{required:r}:{},...n!==void 0&&n?{hidden:n}:{},...s!==void 0&&s?{key:s}:{},...o!==void 0?{savedAs:o}:{},...e}};var na=t=>{let e=Be(t),{required:r,hidden:n,key:s,savedAs:o}=t.props;return{type:"map",attributes:Object.fromEntries(Object.entries(t.attributes).map(([i,a])=>[i,Ae(a)])),...r!==void 0&&r!=="atLeastOnce"?{required:r}:{},...n!==void 0&&n?{hidden:n}:{},...s!==void 0&&s?{key:s}:{},...o!==void 0?{savedAs:o}:{},...e}};var sa=t=>{let e=Be(t),{props:r}=t,{required:n,hidden:s,key:o,savedAs:i,transform:a}=r,m={type:t.type,...n!==void 0&&n!=="atLeastOnce"?{required:n}:{},...s!==void 0&&s!==!1?{hidden:s}:{},...o!==void 0&&o!==!1?{key:o}:{},...i!==void 0?{savedAs:i}:{},...a!==void 0?{transform:as(a)?a.toJSON():{transformerId:"custom"}}:{},...e};if(r.enum)switch(t.type){case"binary":{let p=new TextDecoder("utf8");m.enum=r.enum.map(c=>btoa(p.decode(c)));break}case"number":{m.enum=r.enum.map(p=>ns(p)?p.toString():p);break}default:m.enum=r.enum}return m};var oa=t=>{let e=Be(t),{required:r,hidden:n,key:s,savedAs:o}=t.props;return{type:"record",keys:Ae(t.keys),elements:Ae(t.elements),...r!==void 0&&r!=="atLeastOnce"?{required:r}:{},...n!==void 0&&n?{hidden:n}:{},...s!==void 0&&s?{key:s}:{},...o!==void 0?{savedAs:o}:{},...e}};var ia=t=>{let e=Be(t),{required:r,hidden:n,key:s,savedAs:o}=t.props;return{type:t.type,elements:Ae(t.elements),...r!==void 0&&r!=="atLeastOnce"?{required:r}:{},...n!==void 0&&n?{hidden:n}:{},...s!==void 0&&s?{key:s}:{},...o!==void 0?{savedAs:o}:{},...e}};var Ae=t=>{switch(t.type){case"any":return _i(t);case"null":case"boolean":case"number":case"string":case"binary":return sa(t);case"set":return ia(t);case"list":return ra(t);case"map":return na(t);case"record":return oa(t);case"anyOf":return ea(t);case"item":return ta(t)}};var Ht=class extends ce{constructor(e){super(e),this.type="item",this.attributes=Object.fromEntries(Object.entries(this.schema.attributes).map(([r,n])=>[r,Ae(n)]))}toJSON(){return{type:this.type,attributes:this.attributes}}};Ht.actionName="dto";var C=Symbol("$entities"),ro=Symbol("$interceptor"),Tt=Symbol("$sentArgs");var lr=class{constructor({documentClient:e,name:r,partitionKey:n,sortKey:s,indexes:o={},entityAttributeSavedAs:i="_et",meta:a={}}){this.getDocumentClient=()=>{if(this.documentClient===void 0)throw new d("actions.missingDocumentClient",{message:"You need to set a document client on your table to send a command"});return this.documentClient},this.documentClient=e,this.tableName=r,this.partitionKey=n,s&&(this.sortKey=s),this.indexes=o,this.entityAttributeSavedAs=i,this[C]=[],this.meta=a}getName(){if(this.tableName===void 0)throw new d("table.missingTableName",{message:"Please specify a table name in your Table constructor or in your command options."});return M(this.tableName)?this.tableName:this.tableName()}build(e){return new e(this,this[C])}},Y=class{constructor(e,r=[]){this.table=e,this[C]=r}};var Nt=class extends Y{constructor(e){super(e)}parse(e){let r=this.table,{partitionKey:n,sortKey:s}=r,o={},i=e[n.name];if(!bt(aa(n),i))throw new d("actions.parsePrimaryKey.invalidKeyPart",{message:`Invalid partition key: ${n.name}`,path:n.name,payload:{expected:n.type,received:i,keyPart:"partitionKey"}});if(o[n.name]=i,s===void 0)return o;let a=e[s.name];if(!bt(aa(s),a))throw new d("actions.parsePrimaryKey.invalidKeyPart",{message:`Invalid sort key: ${s.name}`,path:s.name,payload:{expected:s.type,received:a,keyPart:"sortKey"}});return o[s.name]=a,o}};Nt.actionName="parsePrimaryKey";var aa=t=>{switch(t.type){case"number":return new K({big:!0});case"string":return new Ee({});case"binary":return new $t({})}};var ha=require("@aws-sdk/lib-dynamodb");var no=Symbol("$interceptor"),Te=Symbol("$sentArgs");var Xe=Symbol("$IS_EXTENSION");var Ke=Symbol("$GET"),Br=(t,e)=>({[Xe]:!0,[Ke]:e===void 0?[t]:[t,e]}),Ye=t=>S(t)&&Ke in t;var $n=(t,e)=>{if(t===!0)return!0;if(S(t)){let r=t[e];if(r===!0||typeof r=="object")return!0}return!1},Fp={created:{name:"created",savedAs:"_ct",hidden:!1},modified:{name:"modified",savedAs:"_md",hidden:!1}},It=(t,e,r)=>{var n;let s=Fp[e][r];if(S(t)){let o=t[e];return S(o)&&(n=o[r])!==null&&n!==void 0?n:s}return s},Ne=t=>!!t,Up={name:"entity",hidden:!0},ke=(t,e)=>{var r;let n=Up[e];return S(t)&&(r=t[e])!==null&&r!==void 0?r:n};var ms=({schema:t,table:e,entityName:r,entityAttribute:n,timestamps:s})=>{let o={};if(Ne(n)){let i=ke(n,"name"),a=new Ee({hidden:ke(n,"hidden"),enum:[r],putDefault:r,updateDefault:()=>Br(i,r),savedAs:e.entityAttributeSavedAs});o[i]=a}if($n(s,"created")){let i=It(s,"created","name"),a=new Ee({hidden:It(s,"created","hidden"),savedAs:It(s,"created","savedAs"),putDefault:()=>new Date().toISOString(),updateDefault:()=>Br(i,new Date().toISOString())});o[i]=a}if($n(s,"modified")){let i=It(s,"modified","name"),a=new Ee({hidden:It(s,"modified","hidden"),savedAs:It(s,"modified","savedAs"),putDefault:()=>new Date().toISOString(),updateDefault:()=>new Date().toISOString()});o[i]=a}for(let[i,a]of Object.entries(o)){if(i in t.attributes)throw new d("entity.reservedAttributeName",{message:`'${i}' is a reserved attribute name.`,path:i});let{savedAs:m}=a.props;if(m!==void 0&&t.savedAttributeNames.has(m))throw new d("entity.reservedAttributeSavedAs",{message:`'${m}' is a reserved attribute alias (savedAs).`,path:i})}return new Je({...t.attributes,...o})};var ma=(t,e)=>{if(e===void 0)return!0;let r=[...t.keyAttributeNames.values()].map(s=>[s,t.attributes[s]]).find(([s,{props:o}])=>o.savedAs===e.name||o.savedAs===void 0&&s===e.name);if(r===void 0)return!1;let[,n]=r;return n!==void 0&&n.type===e.type&&n.props.key===!0&&(n.props.required==="always"||n.props.keyDefault!==void 0)},so=(t,e)=>{let{partitionKey:r,sortKey:n}=e;return ma(t,r)&&ma(t,n)};var Vt=class{constructor({name:e,table:r,schema:n,computeKey:s,entityAttribute:o=!0,timestamps:i=!0,meta:a={}}){if(this.type="entity",this.entityName=e,this.table=r,this.entityAttribute=o,this.timestamps=i,s===void 0&&!so(n,r))throw new d("entity.invalidSchema",{message:`Entity ${e} schema does not follow its table primary key schema`});this.attributes=n.attributes,this.schema=ms({...this,schema:n}),this.schema.check(),this.computeKey=s,this.meta=a}build(e){return new e(this)}},I=class{constructor(e){this.entity=e}};var oo=Symbol("$formatter");var _=class extends I{constructor(e){super(e),this[oo]=new Ct(e.schema)}format(e,r={}){let{transform:n=!0}=r,{table:s,entityAttribute:o,entityName:i}=this.entity,{entityAttributeSavedAs:a}=s,m=n?a:ke(o,"name"),p=Ne(o)&&e[m]===void 0;try{let c=this[oo].start({...e,...p?{[m]:i}:{}},{...r,format:!0});return n&&c.next(),c.next().value}catch(c){if(!d.match(c,"formatter."))throw c;let u=e[this.entity.table.partitionKey.name],f=this.entity.table.sortKey&&e[this.entity.table.sortKey.name];if(u===void 0&&f===void 0)throw c;let l=u&&[u&&`Partition key: ${String(u)}`,f&&`Sort key: ${String(f)}`].filter(Boolean).join(" / ");throw c.message+=` ${l}`,c.payload.partitionKey=u,c.payload.sortKey=f,c}}};var Fr=()=>(t,e,r)=>{let n=r.value;r.value=async function(...s){let o=this,i=o.table[ro];if(i!==void 0){let a=await i(o);if(a!==void 0)return a}return n.apply(this,s)}};var Ur=Symbol("$query"),Mr=Symbol("$options"),zr=Symbol("$entity");var ps=Symbol("$conditionParser");var Q=class extends I{static express(e,r=""){return Le.express(e,r)}constructor(e){super(e),this[ps]=new Le(e.schema)}transform(e){return this[ps].transform(e)}parse(e,r={}){return this[ps].parse(e,r)}};var us=Symbol("$pathParser");var ye=class extends I{static express(e){return Wt.express(e)}constructor(e){super(e),this[us]=new Wt(e.schema)}transform(e,r){return this[us].transform(e,r)}parse(e,r){return this[us].parse(e,r)}};var Mp=["NONE","TOTAL","INDEXES"],pa=new Set(Mp),oe=t=>{if(!pa.has(t))throw new d("options.invalidCapacityOption",{message:`Invalid capacity option: '${String(t)}'. 'capacity' must be one of: ${[...pa].join(", ")}.`,payload:{capacity:t}});return t};var Jt=(t,e)=>{if(!Se(t))throw new d("options.invalidConsistentOption",{message:`Invalid consistent option: '${String(t)}'. 'consistent' must be boolean.`,payload:{consistent:t}});if(t&&e!==void 0&&e.type!=="local")throw new d("options.invalidConsistentOption",{message:`Invalid consistent option: '${String(t)}'. Queries on global secondary indexes cannot be consistent.`,payload:{consistent:t}});return t};var cs=(t,e,r)=>{if(!Se(t))throw new d("options.invalidEntityAttrFilterOption",{message:`Invalid 'entityAttrFilter' option: '${String(t)}'. 'entityAttrFilter' must be a boolean.`,payload:{entityAttrFilter:t}});let n=e.find(o=>!o.entityAttribute);if(t&&n!==void 0)throw new d("options.invalidEntityAttrFilterOption",{message:`Invalid 'entityAttrFilter' option: '${String(t)}'. 'entityAttrFilter' cannot be true as ${n.entityName} entity has no entity attribute.`,payload:{entityAttrFilter:t}});let s=e.filter(o=>r[o.entityName]!==void 0);if(!t&&s.length>1)throw new d("options.invalidEntityAttrFilterOption",{message:`Invalid 'entityAttrFilter' option: '${String(t)}'. 'entityAttrFilter' must be true when applying multiple filters.`,payload:{entityAttrFilter:t}});return t};var ds=(t,e)=>{if(!M(e))throw new d("options.invalidIndexOption",{message:`Invalid index option: '${String(e)}'. 'index' must be a string.`,payload:{index:e}});if(t.indexes[e]===void 0)throw new d("options.invalidIndexOption",{message:`Invalid index option: '${String(e)}'. Index is not defined on Table, please provide an 'indexes' option to its constructor.`,payload:{index:e}});return e};var ls=t=>{if(!ze(t)||t<=0)throw new d("options.invalidLimitOption",{message:`Invalid limit option: '${String(t)}'. 'limit' must be an integer > 0.`,payload:{limit:t}});return t};var fs=t=>{if(t===1/0)return t;if(!ze(t)||t<=0)throw new d("options.invalidMaxPagesOption",{message:`Invalid limit option: '${String(t)}'. 'limit' must be Infinity or an integer > 0.`,payload:{maxPages:t}});return t};var ua=new Set(["DISCARD","THROW"]),hs=t=>{if(!ua.has(t))throw new d("options.invalidNoEntityMatchBehaviorOption",{message:`Invalid noEntityMatchBehavior option: '${String(t)}'. 'noEntityMatchBehavior' must be one of: ${[...ua].join(", ")}.`,payload:{noEntityMatchBehavior:t}});return t};var B=t=>{let[e]=Object.keys(t);if(e!==void 0)throw new d("options.unknownOption",{message:`Unknown option: ${e}.`,payload:{option:e}})};var zp=["ALL_ATTRIBUTES","ALL_PROJECTED_ATTRIBUTES","COUNT","SPECIFIC_ATTRIBUTES"],ca=new Set(zp),ys=(t,{index:e,attributes:r}={})=>{if(!ca.has(t))throw new d("options.invalidSelectOption",{message:`Invalid select option: '${String(t)}'. 'select' must be one of: ${[...ca].join(", ")}.`,payload:{select:t}});if(t==="ALL_PROJECTED_ATTRIBUTES"&&e===void 0)throw new d("options.invalidSelectOption",{message:`Invalid select option: '${String(t)}'. Please provide an 'index' option.`,payload:{select:t}});if(r!==void 0&&t!=="SPECIFIC_ATTRIBUTES")throw new d("options.invalidSelectOption",{message:`Invalid select option: '${String(t)}'. Select must be 'SPECIFIC_ATTRIBUTES' if a filter expression has been provided.`,payload:{select:t}});return t};var bs=t=>{if(!Se(t))throw new d("options.invalidShowEntityAttrOption",{message:`Invalid 'showEntityAttr' option: '${String(t)}'. 'showEntityAttr' must be a boolean.`,payload:{showEntityAttr:t}});return t};var H=t=>{if(!M(t))throw new d("options.invalidTableNameOption",{message:`Invalid tableName option: '${String(t)}'. 'tableName' must be a string.`,payload:{tableName:t}});return t};var N=t=>Object.keys(t).length===0;var da=(t,...e)=>{let r=new Set(e);return Object.fromEntries(Object.entries(t).filter(([n])=>r.has(n)))};var Kp=new Set(["eq","gt","gte","lt","lte","between","beginsWith"]),la=t=>{switch(t.type){case"number":return new K({required:"never"});case"string":return new Ee({required:"never"});case"binary":return new $t({required:"never"})}},fa=(t,e)=>{let{index:r,partition:n,range:s}=e,o;if(r!==void 0){let y=t.indexes[r];if(y===void 0){let x=Object.keys(t.indexes),b=x.length>0;throw new d("queryCommand.invalidIndex",{message:`Unknown index: ${r}. ${b?` Expected one of: ${x.join(", ")}.`:""}`,payload:{received:r,...b?{expected:Object.keys(t.indexes)}:{}}})}o=y}else o=t;let{partitionKey:i=t.partitionKey,sortKey:a}=o;if(n===void 0)throw new d("queryCommand.invalidPartition",{message:`Missing query partition. Expected: ${i.type}.`,path:i.name,payload:{partition:n}});let m=new Je({[i.name]:la(i),...a!==void 0&&s!==void 0?{[a.name]:la(a)}:{}}),p={attr:i.name,eq:n};if(a!==void 0&&s!==void 0){let y={attr:a.name,...da(s,...Kp)};p={and:[p,y]}}let c=new Le(m),{ConditionExpression:u,ExpressionAttributeNames:f,ExpressionAttributeValues:l}=c.parse(p,{expressionId:"0"});return{KeyConditionExpression:u,ExpressionAttributeNames:f,ExpressionAttributeValues:l}};var Gp=new nt({required:"never"}),io=(t,e=[],r,n={})=>{var s;let{entityAttributeSavedAs:o,indexes:i}=t,{index:a}=r,{capacity:m,consistent:p,exclusiveStartKey:c,limit:u,maxPages:f,reverse:l,select:y,filter:x,filters:b,attributes:O,tableName:v,entityAttrFilter:D=e.every(le=>Ne(le.entityAttribute))&&!Wp(a!==void 0&&(s=i[a])!==null&&s!==void 0?s:t,o),showEntityAttr:V,tagEntities:J,noEntityMatchBehavior:R,...q}=n;B(q);let te=b??{},j=O;v!==void 0&&H(v);let P={TableName:v??t.getName()};if(m!==void 0&&(P.ReturnConsumedCapacity=oe(m)),a!==void 0&&(P.IndexName=ds(t,a)),p!==void 0&&(P.ConsistentRead=Jt(p,a!==void 0?t.indexes[a]:void 0)),c!==void 0&&(P.ExclusiveStartKey=c),u!==void 0&&(P.Limit=ls(u)),f!==void 0&&fs(f),l!==void 0){if(!Se(l))throw new d("queryCommand.invalidReverseOption",{message:'Invalid "reverse" options: Must be a boolean',payload:{reverse:l}});P.ScanIndexForward=!l}if(y!==void 0&&(P.Select=ys(y,{index:a,attributes:j})),cs(D,e,te),V!==void 0&&bs(V),J!==void 0&&!Se(J))throw new d("queryCommand.invalidTagEntitiesOption",{message:`Invalid 'tagEntities' option: '${String(J)}'. 'tagEntities' must be a boolean.`,payload:{tagEntities:J}});R!==void 0&&hs(R);let Z={},ae={};if(j!==void 0&&j.length>0&&e.length!==0){let le=new L({serializer:Ue=>Ue});for(let Ue of e){let At=Ue.build(ye).transform(j,{strict:!1});if(At.length===0)throw new d("queryCommand.invalidProjectionExpression",{message:`Unable to match any expression attribute path with entity: ${Ue.entityName}`,payload:{entity:Ue.entityName}});for(let xn of At)le.push(xn)}let fe=ye.express(le.values);Object.assign(Z,fe.ExpressionAttributeNames);let{entityAttributeSavedAs:yt}=t;Object.values(fe.ExpressionAttributeNames).includes(yt)?P.ProjectionExpression=fe.ProjectionExpression:(P.ProjectionExpression=[fe.ProjectionExpression,"#_et"].join(", "),Z["#_et"]=yt)}let{KeyConditionExpression:Re,ExpressionAttributeNames:vt,ExpressionAttributeValues:Kt}=fa(t,r);if(P.KeyConditionExpression=Re,Object.assign(Z,vt),Object.assign(ae,Kt),e.length===0&&x!==void 0){let le=new Le(Gp).parse(x,{expressionId:"1"});Object.assign(Z,le.ExpressionAttributeNames),Object.assign(ae,le.ExpressionAttributeValues),P.FilterExpression=le.ConditionExpression}if(e.length>0){let le=[];for(let fe of e){let yt=te[fe.entityName],Ue=D?{attr:ke(fe.entityAttribute,"name"),eq:fe.entityName}:void 0;if(yt===void 0&&Ue===void 0)continue;let At=fe.build(Q).transform({and:[Ue,yt].filter(Boolean)});le.push(At)}if(le.length>0){let fe=Qe({or:le},"1");Object.assign(Z,fe.ExpressionAttributeNames),Object.assign(ae,fe.ExpressionAttributeValues),P.FilterExpression=fe.ConditionExpression}}return N(Z)||(P.ExpressionAttributeNames=Z),N(ae)||(P.ExpressionAttributeValues=ae),P},Wp=({partitionKey:t,sortKey:e},r)=>t?.name===r||e?.name===r;var Hp=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},fr=class extends Y{constructor(e,r=[],n,s={}){super(e,r),this.params=()=>io(this.table,...this[Tt]()),this[Ur]=n,this[Mr]=s}[Tt](){if(!this[Ur])throw new d("actions.incompleteAction",{message:'QueryCommand incomplete: Missing "query" property'});return[this[C],this[Ur],this[Mr]]}async send(e){let r=this.table.entityAttributeSavedAs,n=this.params(),s={};this[C].forEach(O=>{s[O.entityName]=O.build(_)});let o=[],i,a=0,m=0,p,c,{attributes:u,maxPages:f=1,showEntityAttr:l=!1,tagEntities:y=!1,noEntityMatchBehavior:x="THROW"}=this[Mr],b=0;do{b+=1;let O={...n,...i!==void 0?{ExclusiveStartKey:i}:{}},{Items:v=[],LastEvaluatedKey:D,Count:V,ScannedCount:J,ConsumedCapacity:R,$metadata:q}=await this.table.getDocumentClient().send(new ha.QueryCommand(O),e);for(let te of v){if(this[C].length===0){o.push(te);continue}let j=te[r],P=s[String(j)];if(!M(j)||P===void 0){let le=!1;for(let[fe,yt]of Object.entries(s))try{let Ue=yt.format(te,{attributes:u}),{entityAttribute:At}=yt.entity,xn=ke(At,"name"),pp=l&&Ne(At);o.push({...Ue,...pp?{[xn]:fe}:{},...y?{[zr]:fe}:{}}),le=!0;break}catch{continue}if(!le&&x==="THROW")throw new d("queryCommand.noEntityMatched",{message:"Unable to match item of unidentified entity to the QueryCommand entities",payload:{item:te}});continue}let Z=P.format(te,{attributes:u}),{entityAttribute:ae,entityName:Re}=P.entity,vt=ke(ae,"name"),Kt=l&&Ne(ae);o.push({...Z,...Kt?{[vt]:Re}:{},...y?{[zr]:Re}:{}})}i=D,a!==void 0&&(a=V!==void 0?a+V:void 0),m!==void 0&&(m=J!==void 0?m+J:void 0),p=R,c=q}while(b<f&&i!==void 0);return{Items:o,...i!==void 0?{LastEvaluatedKey:i}:{},...a!==void 0?{Count:a}:{},...m!==void 0?{ScannedCount:m}:{},...b===1?{...p!==void 0?{ConsumedCapacity:p}:{},...c!==void 0?{$metadata:c}:{}}:{}}}};fr.actionName="query";Hp([Fr()],fr.prototype,"send",null);var pe=class t extends fr{constructor(e,r=[],n,s={}){super(e,r,n,s)}entities(...e){return new t(this.table,e,this[Ur],this[Mr])}query(e){return new t(this.table,this[C],e,this[Mr])}options(e){return new t(this.table,this[C],this[Ur],e)}};var ya=require("@aws-sdk/lib-dynamodb");var Pn=Symbol("$options");var Jp=new nt({required:"never"}),ao=(t,e=[],r={})=>{let{capacity:n,consistent:s,exclusiveStartKey:o,index:i,limit:a,maxPages:m,select:p,totalSegments:c,segment:u,filter:f,filters:l,attributes:y,tableName:x,entityAttrFilter:b=e.every(j=>Ne(j.entityAttribute)),showEntityAttr:O,noEntityMatchBehavior:v,...D}=r;B(D);let V=l??{},J=y;x!==void 0&&H(x);let R={TableName:x??t.getName()};if(n!==void 0&&(R.ReturnConsumedCapacity=oe(n)),s!==void 0&&(R.ConsistentRead=Jt(s,i!==void 0?t.indexes[i]:void 0)),o!==void 0&&(R.ExclusiveStartKey=o),i!==void 0&&(R.IndexName=ds(t,i)),a!==void 0&&(R.Limit=ls(a)),m!==void 0&&fs(m),p!==void 0&&(R.Select=ys(p,{index:i,attributes:J})),cs(b,e,V),O!==void 0&&bs(O),v!==void 0&&hs(v),u!==void 0){if(c===void 0)throw new d("scanCommand.invalidSegmentOption",{message:"If a segment option has been provided, totalSegments must also be defined",payload:{}});if(!ze(c)||c<1)throw new d("scanCommand.invalidSegmentOption",{message:`Invalid totalSegments option: '${String(c)}'. 'totalSegments' must be a strictly positive integer.`,payload:{totalSegments:c}});if(!ze(u)||u<0||u>=c)throw new d("scanCommand.invalidSegmentOption",{message:`Invalid segment option: '${String(u)}'. 'segment' must be a positive integer strictly lower than 'totalSegments'.`,payload:{segment:u,totalSegments:c}});R.TotalSegments=c,R.Segment=u}let q={},te={};if(J!==void 0&&J.length>0&&e.length!==0){let j=new L({serializer:ae=>ae});for(let ae of e){let Re=ae.build(ye).transform(J,{strict:!1});if(Re.length===0)throw new d("scanCommand.invalidProjectionExpression",{message:`Unable to match any expression attribute path with entity: ${ae.entityName}`,payload:{entity:ae.entityName}});for(let vt of Re)j.push(vt)}let P=ye.express(j.values);Object.assign(q,P.ExpressionAttributeNames);let{entityAttributeSavedAs:Z}=t;Object.values(P.ExpressionAttributeNames).includes(Z)?R.ProjectionExpression=P.ProjectionExpression:(R.ProjectionExpression=[P.ProjectionExpression,"#_et"].join(", "),q["#_et"]=Z)}if(e.length===0&&f!==void 0){let{ExpressionAttributeNames:j,ExpressionAttributeValues:P,ConditionExpression:Z}=new Le(Jp).parse(f);Object.assign(q,j),Object.assign(te,P),R.FilterExpression=Z}if(e.length>0){let j=[];for(let P of e){let Z=V[P.entityName],ae=b?{attr:ke(P.entityAttribute,"name"),eq:P.entityName}:void 0;if(Z===void 0&&ae===void 0)continue;let Re=P.build(Q).transform({and:[ae,Z].filter(Boolean)});j.push(Re)}if(j.length>0){let P=Qe({or:j});Object.assign(q,P.ExpressionAttributeNames),Object.assign(te,P.ExpressionAttributeValues),R.FilterExpression=P.ConditionExpression}}return N(q)||(R.ExpressionAttributeNames=q),N(te)||(R.ExpressionAttributeValues=te),R};var Qp=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},hr=class extends Y{constructor(e,r=[],n={}){super(e,r),this[Pn]=n}[Tt](){return[this[C],this[Pn]]}params(){return ao(this.table,...this[Tt]())}async send(e){let r=this.table.entityAttributeSavedAs,n=this.params(),s={};this[C].forEach(b=>{s[b.entityName]=b.build(_)});let o=[],i,a=0,m=0,p,c,{attributes:u,maxPages:f=1,showEntityAttr:l=!1,noEntityMatchBehavior:y="THROW"}=this[Pn],x=0;do{x+=1;let b={...n,...i!==void 0?{ExclusiveStartKey:i}:{}},{Items:O=[],LastEvaluatedKey:v,Count:D,ScannedCount:V,ConsumedCapacity:J,$metadata:R}=await this.table.getDocumentClient().send(new ya.ScanCommand(b),e);for(let q of O){if(this[C].length===0){o.push(q);continue}let te=q[r],j=s[String(te)];if(!M(te)||j===void 0){let Kt=!1;for(let[le,fe]of Object.entries(s))try{let yt=fe.format(q,{attributes:u}),{entityAttribute:Ue}=fe.entity,At=ke(Ue,"name"),xn=l&&Ne(Ue);o.push({...yt,...xn?{[At]:le}:{}}),Kt=!0;break}catch{continue}if(!Kt&&y==="THROW")throw new d("scanCommand.noEntityMatched",{message:"Unable to match item of unidentified entity to the ScanCommand entities",payload:{item:q}});continue}let P=j.format(q,{attributes:u}),{entityAttribute:Z,entityName:ae}=j.entity,Re=ke(Z,"name"),vt=l&&Ne(Z);o.push({...P,...vt?{[Re]:ae}:{}})}i=v,a!==void 0&&(a=D!==void 0?a+D:void 0),m!==void 0&&(m=V!==void 0?m+V:void 0),p=J,c=R}while(x<f&&i!==void 0);return{Items:o,...i!==void 0?{LastEvaluatedKey:i}:{},...a!==void 0?{Count:a}:{},...m!==void 0?{ScannedCount:m}:{},...x===1?{...p!==void 0?{ConsumedCapacity:p}:{},...c!==void 0?{$metadata:c}:{}}:{}}}};hr.actionName="scan";Qp([Fr()],hr.prototype,"send",null);var wt=class t extends hr{constructor(e,r=[],n={}){super(e,r,n)}entities(...e){return new t(this.table,e,this[Pn])}options(e){return new t(this.table,this[C],e)}};var mo=Symbol("$parser");var F=class extends I{constructor(e){super(e),this[mo]=new E(e.schema)}parse(e,r={}){let{fill:n=!0}=r,s=this[mo].start(e,{...r,transform:!0});n&&(s.next(),s.next());let o=s.next().value,i=s.next().value,a=this.entity.computeKey?this.entity.computeKey(o):i,m=new Nt(this.entity.table).parse(a);return{parsedItem:o,item:{...i,...m},key:m}}reparse(e,r={}){return this.parse(e,r)}};var xs=Symbol("$key");var st=class t extends I{constructor(e,r){super(e),this[xs]=r}key(e){return new t(this.entity,e)}params(){if(!this[xs])throw new d("actions.incompleteAction",{message:'DeleteItemCommand incomplete: Missing "key" property'});let{key:e}=this.entity.build(F).parse(this[xs],{mode:"key"});return{DeleteRequest:{Key:e}}}};st.actionName="batchDelete";var Kr=Symbol("$requests"),po=Symbol("$options");var ot=class t extends Y{constructor(e,r=[],n,s={}){super(e,r),this[Kr]=n,this[po]=s}requests(...e){let r=[],n=new Set;for(let s of e)n.has(s.entity.entityName)||(r.push(s.entity),n.add(s.entity.entityName));return new t(this.table,r,e)}options(e){return new t(this.table,this[C],this[Kr],e)}params(){var e;if(this[Kr]===void 0||this[Kr].length===0)throw new d("actions.incompleteAction",{message:"BatchWriteCommand incomplete: No BatchWriteRequest supplied"});let{tableName:r,...n}=(e=this[po])!==null&&e!==void 0?e:{};return B(n),r&&H(r),{[r??this.table.getName()]:this[Kr].map(s=>s.params())}}};ot.actionName="batchWrite";var xa=require("@aws-sdk/lib-dynamodb");var Xp=["NONE","SIZE"],ba=new Set(Xp),Ze=t=>{if(!ba.has(t))throw new d("options.invalidMetricsOption",{message:`Invalid metrics option: '${String(t)}'. 'metrics' must be one of: ${[...ba].join(", ")}.`,payload:{metrics:t}});return t};var Gr=async(...t)=>{let[e={},...r]=t,n=r,s={};e instanceof ot?n.unshift(e):s=e;let o=n[0];if(o===void 0)throw new d("actions.incompleteAction",{message:"Cannot execute BatchWriteCommands: No BatchWriteCommand supplied"});let{maxAttempts:i=1,metrics:a,capacity:m,documentClient:p,...c}=s,u=p??o.table.getDocumentClient(),{RequestItems:f,...l}=Yp(n,{metrics:a,capacity:m}),y=0,x=f,b={},O,v,D={};do{y+=1;let{UnprocessedItems:V={},ConsumedCapacity:J,ItemCollectionMetrics:R,$metadata:q}=await u.send(new xa.BatchWriteCommand({RequestItems:x,...l}),c);x=V,b=V,O=J,v=R,D=q}while(y<i&&!N(b));return{...b!==void 0?{UnprocessedItems:b}:{},$metadata:{},...y===1?{...O!==void 0?{ConsumedCapacity:O}:{},...v!==void 0?{ItemCollectionMetrics:v}:{},...D!==void 0?{$metadata:D}:{}}:{}}},Yp=(t,e={})=>{let r={};if(t.length===0)throw new d("actions.incompleteAction",{message:"batchWrite arguments incomplete: No BatchWriteCommand supplied"});for(let o of t){let i=o.params();for(let a of Object.keys(i))if(a in r)throw new d("actions.invalidAction",{message:`Two BatchWriteCommands detected for table: ${a}. Please provide only one BatchWriteCommand per table`});Object.assign(r,i)}let{capacity:n,metrics:s}=e;return{RequestItems:r,...n!==void 0?{ReturnConsumedCapacity:oe(n)}:{},...s!==void 0?{ReturnItemCollectionMetrics:Ze(s)}:{}}};var wa=(t,e)=>{let r=[...t],n=[];for(;r.length>0;)n.push(r.splice(0,e));return n};var yr=Symbol("$query"),br=Symbol("$options");var Zp=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},Qt=class t extends Y{constructor(e,r=[],n,s={}){super(e,r),this[yr]=n,this[br]=s}entities(...e){return new t(this.table,e,this[yr],this[br])}query(e){return new t(this.table,this[C],e,this[br])}options(e){return new t(this.table,this[C],this[yr],e)}[Tt](){if(this[C].length===0)throw new d("actions.incompleteAction",{message:'DeletePartitionCommand incomplete: Missing "entities" property'});if(!this[yr])throw new d("actions.incompleteAction",{message:'DeletePartitionCommand incomplete: Missing "query" property'});return[this[C],this[yr],this[br]]}queryCommand({exclusiveStartKey:e}={}){return new pe(this.table,this[C],this[yr],{...this[br],attributes:void 0,tagEntities:!0,...e!==void 0?{ExclusiveStartKey:e}:{},maxPages:16})}params(){return this.queryCommand().params()}async send(e){let r={};this[C].forEach(u=>{r[u.entityName]=u});let{capacity:n,tableName:s}=this[br],o,i=0,a=0,m,p=[],c=0;do{c+=1;let{Items:u=[],Count:f,ScannedCount:l,ConsumedCapacity:y,...x}=await this.queryCommand({exclusiveStartKey:o}).send(e);for(let b of wa(u,25)){if(b.length===0)continue;let O=[];for(let D of b){let V=r[D[zr]];V!==void 0&&O.push(new st(V,D))}let{ConsumedCapacity:v}=await Gr({maxAttempts:1/0,capacity:n,...e},this.table.build(ot).options({tableName:s}).requests(...O));v!==void 0?p?.push(...v):p=void 0}o=x.LastEvaluatedKey,i!==void 0&&(i=f!==void 0?i+f:void 0),a!==void 0&&(a=l!==void 0?a+l:void 0),m=y}while(o!==void 0);return{...o!==void 0?{LastEvaluatedKey:o}:{},...i!==void 0?{Count:i}:{},...a!==void 0?{ScannedCount:a}:{},...p!==void 0?{BatchWriteConsumedCapacity:p}:{},...c===1?{...m!==void 0?{QueryConsumedCapacity:m}:{}}:{}}}};Qt.actionName="deletePartition";Zp([Fr()],Qt.prototype,"send",null);var Wr=Symbol("$requests"),Hr=Symbol("$options");var jt=class t extends Y{constructor(e,r=[],n,s={}){super(e,r),this[Wr]=n,this[Hr]=s}requests(...e){let r=[],n=new Set;for(let s of e)n.has(s.entity.entityName)||(r.push(s.entity),n.add(s.entity.entityName));return new t(this.table,r,e,this[Hr])}options(e){return new t(this.table,this[C],this[Wr],e)}params(){var e;let r=this[Wr];if(r===void 0||r.length===0)throw new d("actions.incompleteAction",{message:"BatchGetCommand incomplete: No BatchGetRequest supplied"});let{consistent:n,attributes:s,tableName:o,...i}=(e=this[Hr])!==null&&e!==void 0?e:{};B(i),o&&H(o);let a=s,m,p={};if(a!==void 0&&a.length>0){let u=new L({serializer:v=>v});for(let v of this[C]){let D=v.build(ye).transform(a,{strict:!1});if(D.length===0)throw new d("batchGetCommand.invalidProjectionExpression",{message:`Unable to match any expression attribute path with entity: ${v.entityName}`,payload:{entity:v.entityName}});for(let V of D)u.push(V)}let{ExpressionAttributeNames:f,ProjectionExpression:l}=ye.express(u.values);Object.assign(p,f),m=l;let{partitionKey:y,sortKey:x,entityAttributeSavedAs:b}=this.table,O=new Set(Object.values(p));O.has(y.name)||(m+=", #_pk",p["#_pk"]=y.name),x!==void 0&&!O.has(x.name)&&(m+=", #_sk",p["#_sk"]=x.name),O.has(b)||(m+=", #_et",p["#_et"]=b)}let c=[];for(let u of r){let f=u.params();c.push(f)}return{[o??this.table.getName()]:{Keys:c,...n!==void 0?{ConsistentRead:Jt(n)}:{},...m!==void 0?{ProjectionExpression:m}:{},...N(p)?{}:{ExpressionAttributeNames:p}}}}};jt.actionName="batchGet";var Ea=require("@aws-sdk/lib-dynamodb");var ws=async(...t)=>{let[e={},...r]=t,n=r,s={};e instanceof jt?n.unshift(e):s=e;let o=n[0];if(o===void 0)throw new d("actions.incompleteAction",{message:"batchGet incomplete: No BatchGetCommand supplied"});let{maxAttempts:i=1,documentClient:a,capacity:m,...p}=s,c=a??o.table.getDocumentClient(),{RequestItems:u,...f}=_p(n,{capacity:m}),l=0,y=u,x,b={},O,v={};do{l+=1;let{Responses:V,UnprocessedKeys:J={},ConsumedCapacity:R,$metadata:q}=await c.send(new Ea.BatchGetCommand({RequestItems:y,...f}),p);if(V!==void 0){x===void 0&&(x={});for(let[te,j]of Object.entries(V)){let P=x[te];P===void 0?x[te]=j:P.push(...j)}}y=J,b=J,O=R,v=q}while(l<i&&!N(b));let D;return x!==void 0&&(D=n.map(V=>{let J=V.table.getName(),R=V[Wr],{attributes:q}=V[Hr];return R?.map((te,j)=>{let P=te.entity,Z=x[J];if(Z===void 0)return;let ae=u[J].Keys[j],Re=Z.find(vt=>Object.entries(ae).every(([Kt,le])=>vt[Kt]===le));if(Re!==void 0)return P.build(_).format(Re,{attributes:q})})})),{...D!==void 0?{Responses:D}:{},...b!==void 0?{UnprocessedKeys:b}:{},...l===1?{...O!==void 0?{ConsumedCapacity:O}:{},...v!==void 0?{$metadata:v}:{}}:{}}},_p=(t,e={})=>{let r={};if(t.length===0)throw new d("actions.incompleteAction",{message:"Unable to execute BatchGetCommands: No BatchGetCommand supplied"});for(let s of t){let o=s.params();for(let i of Object.keys(o))if(i in r)throw new d("actions.invalidAction",{message:`Two BatchGetCommands detected for table: ${i}. Please provide only one BatchGetCommand per table`});Object.assign(r,o)}let{capacity:n}=e;return{RequestItems:r,...n!==void 0?{ReturnConsumedCapacity:oe(n)}:{}}};var xr=Symbol("$schema"),wr=Symbol("$pattern"),Er=Symbol("$options"),ga=Symbol("$meta");var Jr=class extends Y{constructor(e,r=[],n,s,o={},i={}){super(e,r),this[xr]=n,this[wr]=s,this[Er]=o,this[ga]=i}query(e){let r=this[xr];if(r===void 0)throw new d("actions.incompleteAction",{message:'AccessPattern incomplete: Missing "schema" property'});let n=this[wr];if(n===void 0)throw new d("actions.incompleteAction",{message:'AccessPattern incomplete: Missing "pattern" property'});let o=new E(r).parse(e),i=n(o),a=this[Er];return new pe(this.table,this[C],i,a)}};Jr.actionName="access-pattern";var Qr=class t extends Jr{constructor(e,r=[],n,s,o={},i={}){super(e,r,n,s,o,i)}entities(...e){return new t(this.table,e,this[xr],this[wr],this[Er])}schema(e){return new t(this.table,this[C],e,this[wr],this[Er])}pattern(e){return new t(this.table,this[C],this[xr],e,this[Er])}options(e){return new t(this.table,this[C],this[xr],this[wr],e)}meta(e){return new t(this.table,this[C],this[xr],this[wr],this[Er],e)}};var Sa=Symbol("$actionName"),Oa=Symbol("$sentActions"),va=Symbol("$spy"),Aa=Symbol("$mocks");var Xt=class extends Y{constructor(e){super(e),this.tableName=this.table.tableName!==void 0?this.table.getName():void 0,this.partitionKey=this.table.partitionKey,this.sortKey=this.table.sortKey,this.indexes=this.table.indexes,this.entityAttributeSavedAs=this.table.entityAttributeSavedAs}toJSON(){return{...this.tableName!==void 0?{tableName:this.tableName}:{},partitionKey:this.partitionKey,...this.sortKey!==void 0?{sortKey:this.sortKey}:{},...this.indexes!==void 0&&Object.entries(this.indexes).length>0?{indexes:this.indexes}:{},entityAttributeSavedAs:this.entityAttributeSavedAs}}};Xt.actionName="dto";var Es=Symbol("$key");var Rt=class t extends I{constructor(e,r){super(e),this[Es]=r}key(e){return new t(this.entity,e)}params(){if(!this[Es])throw new d("actions.incompleteAction",{message:'BatchGetRequest incomplete: Missing "key" property'});let{key:e}=this.entity.build(F).parse(this[Es],{mode:"key"});return e}};Rt.actionName="batchGet";var gs=Symbol("$item");var qt=class t extends I{constructor(e,r){super(e),this[gs]=r}item(e){return new t(this.entity,e)}params(){if(!this[gs])throw new d("actions.incompleteAction",{message:'BatchPutRequest incomplete: Missing "item" property'});let{item:e}=this.entity.build(F).parse(this[gs]);return{PutRequest:{Item:e}}}};qt.actionName="batchPut";var Dn=class t extends Y{constructor(e,r=[]){super(e,r)}entities(...e){return new t(this.table,e)}parsePrimaryKey(e){return new Nt(this.table).parse(e)}async scan(e={}){return new wt(this.table,this[C],e).send()}async query(e,r={}){return new pe(this.table,this[C],e,r).send()}async deletePartition(e,r={}){return new Qt(this.table,this[C],e,r).send()}static executeBatchGet(...e){return ws(...e)}batchGet(...e){let[r={},...n]=e,s=n,o={};if(tu(r)?s.unshift(r):o=r,s[0]===void 0)throw new d("actions.incompleteAction",{message:"batchGet incomplete: No BatchGetRequest supplied"});let a=[],m=new Set;for(let p of s)m.has(p.entity.entityName)||(a.push(p.entity),m.add(p.entity.entityName));return new jt(this.table,a,s,o)}static executeBatchWrite(...e){return Gr(...e)}batchWrite(...e){let[r={},...n]=e,s=n,o={};if(ru(r)?s.unshift(r):o=r,s[0]===void 0)throw new d("actions.incompleteAction",{message:"batchGet incomplete: No BatchWriteRequest supplied"});let a=[],m=new Set;for(let p of s)m.has(p.entity.entityName)||(a.push(p.entity),m.add(p.entity.entityName));return new ot(this.table,a,s,o)}accessPattern(e,r,n={}){return new Qr(this.table,this[C],e,r,n)}};Dn.actionName="repository";var tu=t=>t instanceof Rt,ru=t=>t instanceof qt||t instanceof st;var Cn=class t extends Y{constructor(e,r=[],n={},{entities:s=$a(r),query:o=ka(n)}={}){super(e,r),this.entities=s,this.accessPatterns=n,this.query=o}registerEntities(...e){return new t(this.table,e,this.accessPatterns,{entities:$a(e),query:this.query})}registerAccessPatterns(e){return new t(this.table,this[C],e,{entities:this.entities,query:ka(e)})}build(e){return new e(this.table,this[C])}};Cn.actionName="registry";var ka=t=>Object.fromEntries(Object.entries(t).map(([e,r])=>[e,n=>r.query(n)])),$a=t=>Object.fromEntries(t.map(e=>[e.entityName,e]));var Da=require("@aws-sdk/lib-dynamodb");var Et=()=>(t,e,r)=>{let n=r.value;r.value=async function(...s){let o=this,i=o.entity[no];if(i!==void 0){let a=await i(o);if(a!==void 0)return a}return n.apply(this,s)}};var Tn=Symbol("$key"),Nn=Symbol("$options");var Pa=(t,e)=>{let r={},{capacity:n,consistent:s,attributes:o,tableName:i,...a}=e;if(B(a),n!==void 0&&(r.ReturnConsumedCapacity=oe(n)),s!==void 0&&(r.ConsistentRead=Jt(s)),o!==void 0){let{ExpressionAttributeNames:m,ProjectionExpression:p}=t.build(ye).parse(o);N(m)||(r.ExpressionAttributeNames=m),r.ProjectionExpression=p}return i!==void 0&&H(i),r};var co=(t,e,r={})=>{var n;let{key:s}=t.build(F).parse(e,{mode:"key"}),o=Pa(t,r);return{TableName:(n=r.tableName)!==null&&n!==void 0?n:t.table.getName(),Key:s,...o}};var nu=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},it=class t extends I{constructor(e,r,n={}){super(e),this[Tn]=r,this[Nn]=n}key(e){return new t(this.entity,e,this[Nn])}options(e){return new t(this.entity,this[Tn],e)}[Te](){if(!this[Tn])throw new d("actions.incompleteAction",{message:'GetItemCommand incomplete: Missing "key" property'});return[this[Tn],this[Nn]]}params(){return co(this.entity,...this[Te]())}async send(e){let r=this.params(),n=await this.entity.table.getDocumentClient().send(new Da.GetCommand(r),e),{Item:s,...o}=n;if(s===void 0)return o;let{attributes:i}=this[Nn];return{Item:new _(this.entity).format(s,{attributes:i}),...o}}};it.actionName="get";nu([Et()],it.prototype,"send",null);var Ia=require("@aws-sdk/lib-dynamodb");var In=Symbol("$item"),Ss=Symbol("$options");var Yt=(t,e)=>{if(!t.has(e))throw new d("options.invalidReturnValuesOption",{message:`Invalid returnValues option: '${String(e)}'. 'returnValues' must be one of: ${[...t].join(", ")}.`,payload:{returnValues:e}});return e};var Ca=new Set(["NONE","ALL_OLD"]),Ie=t=>{if(!Ca.has(t))throw new d("options.invalidReturnValuesOnConditionFalseOption",{message:`Invalid returnValues option: '${String(t)}'. 'returnValuesOnConditionFalse' must be one of: ${[...Ca].join(", ")}.`,payload:{returnValues:t}});return t};var su=["NONE","ALL_OLD"],Ta=new Set(su);var Na=(t,e)=>{let r={},{capacity:n,metrics:s,returnValues:o,returnValuesOnConditionFalse:i,condition:a,tableName:m,...p}=e;if(B(p),n!==void 0&&(r.ReturnConsumedCapacity=oe(n)),s!==void 0&&(r.ReturnItemCollectionMetrics=Ze(s)),o!==void 0&&(r.ReturnValues=Yt(Ta,o)),i!==void 0&&(r.ReturnValuesOnConditionCheckFailure=Ie(i)),a!==void 0){let{ExpressionAttributeNames:c,ExpressionAttributeValues:u,ConditionExpression:f}=t.build(Q).parse(a);N(c)||(r.ExpressionAttributeNames=c),N(u)||(r.ExpressionAttributeValues=u),r.ConditionExpression=f}return m!==void 0&&H(m),r};var lo=(t,e,r={})=>{var n;let{parsedItem:s,item:o}=t.build(F).parse(e),i=Na(t,r);return{TableName:(n=r.tableName)!==null&&n!==void 0?n:t.table.getName(),Item:o,ToolboxItem:s,...i}};var ou=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},at=class t extends I{constructor(e,r,n={}){super(e),this[In]=r,this[Ss]=n}item(e){return new t(this.entity,e,this[Ss])}options(e){return new t(this.entity,this[In],e)}[Te](){if(!this[In])throw new d("actions.incompleteAction",{message:'PutItemCommand incomplete: Missing "item" property'});return[this[In],this[Ss]]}params(){let[e,r]=this[Te]();return lo(this.entity,e,r)}async send(e){let{ToolboxItem:r,...n}=this.params(),s=await this.entity.table.getDocumentClient().send(new Ia.PutCommand(n),e),{Attributes:o,...i}=s;if(o===void 0)return{ToolboxItem:r,...i};let a=new _(this.entity).format(o);return{ToolboxItem:r,Attributes:a,...i}}};at.actionName="put";ou([Et()],at.prototype,"send",null);var Ra=require("@aws-sdk/lib-dynamodb");var Vn=Symbol("$key"),Os=Symbol("$options");var iu=["NONE","ALL_OLD"],Va=new Set(iu);var ja=(t,e)=>{let r={},{capacity:n,metrics:s,returnValues:o,returnValuesOnConditionFalse:i,condition:a,tableName:m,...p}=e;if(B(p),n!==void 0&&(r.ReturnConsumedCapacity=oe(n)),s!==void 0&&(r.ReturnItemCollectionMetrics=Ze(s)),o!==void 0&&(r.ReturnValues=Yt(Va,o)),i!==void 0&&(r.ReturnValuesOnConditionCheckFailure=Ie(i)),a!==void 0){let{ExpressionAttributeNames:c,ExpressionAttributeValues:u,ConditionExpression:f}=t.build(Q).parse(a);N(c)||(r.ExpressionAttributeNames=c),N(u)||(r.ExpressionAttributeValues=u),r.ConditionExpression=f}return m!==void 0&&H(m),r};var fo=(t,e,r={})=>{var n;let{key:s}=t.build(F).parse(e,{mode:"key"}),o=ja(t,r);return{TableName:(n=r.tableName)!==null&&n!==void 0?n:t.table.getName(),Key:s,...o}};var au=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},Zt=class t extends I{constructor(e,r,n={}){super(e),this[Vn]=r,this[Os]=n}key(e){return new t(this.entity,e,this[Os])}options(e){return new t(this.entity,this[Vn],e)}[Te](){if(!this[Vn])throw new d("actions.incompleteAction",{message:'DeleteItemCommand incomplete: Missing "key" property'});return[this[Vn],this[Os]]}params(){return fo(this.entity,...this[Te]())}async send(e){let r=this.params(),n=await this.entity.table.getDocumentClient().send(new Ra.DeleteCommand(r),e),{Attributes:s,...o}=n;return s===void 0?o:{Attributes:new _(this.entity).format(s),...o}}};Zt.actionName="delete";au([Et()],Zt.prototype,"send",null);var om=require("@aws-sdk/lib-dynamodb");var jn=Symbol("$item"),Rn=Symbol("$options");var Xr=(t,...e)=>{let r=new Set(e);return Object.fromEntries(Object.entries(t).filter(([n])=>!r.has(n)))};var je=Symbol("$ADD");var _t=t=>S(t)&&je in t;var be=Symbol("$APPEND");var er=t=>S(t)&&be in t;var gt=Symbol("$DELETE");var Yr=t=>S(t)&&gt in t;var xe=Symbol("$PREPEND");var tr=t=>S(t)&&xe in t;var ho=Symbol("$REMOVE");var _e=t=>S(t)&&ho in t;var U=Symbol("$SET");var St=t=>S(t)&&U in t;var mt=Symbol("$SUBTRACT");var Zr=t=>S(t)&&mt in t;var pt=Symbol("$SUM");var _r=t=>S(t)&&pt in t;var ee=(t,e,r)=>{let n="";return t.arrayPath.forEach((s,o)=>{if(He(s)){n+=`[${s}]`;return}let i=r.tokens[e][s];i===void 0&&(i=`#${e}_${r.nameCursors[e]}`,r.tokens[e][s]=i,r.ExpressionAttributeNames[i]=s,r.nameCursors[e]++),o>0&&(n+="."),n+=i}),n},pu=(t,e,r)=>{let n=`:${e}_${r.valueCursors[e]}`;return r.ExpressionAttributeValues[n]=t,r.valueCursors[e]++,n},ne=(t,e,r)=>{if(Ye(t)){let[n,s]=t[Ke],[o]=new z(r.rootSchema).search(n);if(o===void 0)throw new d("actions.invalidExpressionAttributePath",{message:`Unable to match update reference with schema: ${n}`,payload:{attributePath:n}});if(s===void 0)return ee(o.transformedPath,e,r);{let i="if_not_exists(";return i+=ee(o.transformedPath,e,r),i+=", ",i+=ne(s,e,r),i+=")",i}}return pu(t,e,r)};var Ga=(t,e,r)=>{let n=ee(e,"a",r);return n+=" ",n+=ne(t[je],"a",r),r.addExpressions.push(n),r};var Wa=(t,e,r)=>{let n=ee(e,"s",r);return n+=" = list_append(if_not_exists(",n+=ee(e,"s",r),n+=", ",n+=ne([],"s",r),n+="), ",n+=ne(t[be],"s",r),n+=")",r.setExpressions.push(n),r};var Ha=(t,e,r)=>{let n=ee(e,"d",r);return n+=" ",n+=ne(t[gt],"d",r),r.deleteExpressions.push(n),r};var Ja=(t,e,r)=>{let n=ee(e,"s",r);return n+=" = ",n+=ne(t,"s",r),r.setExpressions.push(n),r};var Qa=(t,e,r)=>{let n=ee(e,"s",r);return n+=" = list_append(",n+=ne(t[xe],"s",r),n+=", if_not_exists(",n+=ee(e,"s",r),n+=", ",n+=ne([],"s",r),n+="))",r.setExpressions.push(n),r};var Xa=(t,e,r)=>(r.removeExpressions.push(ee(e,"r",r)),r);var Ya=(t,e,r)=>{let n=ee(e,"s",r);return n+=" = ",n+=ne(t[U],"s",r),r.setExpressions.push(n),r};var Za=(t,e,r)=>{let[n,s]=t[mt],o=ee(e,"s",r);return o+=" = ",o+=ne(n,"s",r),o+=" - ",o+=ne(s,"s",r),r.setExpressions.push(o),r};var _a=(t,e,r)=>{let[n,s]=t[pt],o=ee(e,"s",r);return o+=" = ",o+=ne(n,"s",r),o+=" + ",o+=ne(s,"s",r),r.setExpressions.push(o),r};var gr=(t,e)=>{let{setExpressions:r,removeExpressions:n,addExpressions:s,deleteExpressions:o,ExpressionAttributeNames:i,ExpressionAttributeValues:a}=yo(e,new Me,{rootSchema:t.schema,setExpressions:[],removeExpressions:[],addExpressions:[],deleteExpressions:[],nameCursors:{s:1,r:1,a:1,d:1},valueCursors:{s:1,r:1,a:1,d:1},tokens:{s:{},r:{},a:{},d:{}},ExpressionAttributeNames:{},ExpressionAttributeValues:{}}),m=[];return r.length>0&&m.push(`SET ${r.join(", ")}`),n.length>0&&m.push(`REMOVE ${n.join(", ")}`),s.length>0&&m.push(`ADD ${s.join(", ")}`),o.length>0&&m.push(`DELETE ${o.join(", ")}`),{UpdateExpression:m.join(" "),ExpressionAttributeNames:i,ExpressionAttributeValues:a}},yo=(t,e,r)=>{if(t===void 0)return r;if(St(t))return Ya(t,e,r);if(Ye(t))return Ja(t,e,r);if(_r(t))return _a(t,e,r);if(Zr(t))return Za(t,e,r);if(er(t))return Wa(t,e,r);if(tr(t))return Qa(t,e,r);if(_e(t))return Xa(t,e,r);if(_t(t))return Ga(t,e,r);if(Yr(t))return Ha(t,e,r);if(S(t)){for(let[s,o]of Object.entries(t))yo(o,e.append(s),r);return r}if(X(t))return t.forEach((s,o)=>{s!==void 0&&yo(s,e.append(o),r)}),r;let n=ee(e,"s",r);return n+=" = ",n+=ne(t,"s",r),r.setExpressions.push(n),r};var $e=(t,e,{transform:r=!0,valuePath:n}={})=>!Ye(e)||e[Ke]===void 0?{isExtension:!1,unextendedInput:e}:{isExtension:!0,*extensionParser(){let s=e[Ke],o=[...n??[],"$GET"];if(!X(s)){let u=$(o);throw new d("parsing.invalidAttributeInput",{message:`References ${u!==void 0?`for attribute '${u}' `:""}should be a tuple of one or two elements`,path:u,payload:{received:s}})}let[i,a]=s;if(!M(i)){let u=$([...o,0]);throw new d("parsing.invalidAttributeInput",{message:`First elements of references ${u!==void 0?`for attribute '${u}' `:""}should be strings`,path:u,payload:{received:i}})}let m=a!==void 0?new E(t).start(a,{fill:!1,transform:r,parseExtension:$e,valuePath:[...o,1]}):void 0,p={[Ke]:[i,...m!==void 0?[m.next().value]:[]]};if(r)yield p;else return p;return{[Ke]:[i,...m!==void 0?[m.next().value]:[]]}}};function*uu(t,e,{transform:r=!0,valuePath:n}){if(_e(e)){let s=e;if(r)yield s;else return s;return s}if(e===void 0){if(r)yield void 0;else return;return void 0}return yield*new E(t.elements).start(e,{mode:"update",fill:!1,transform:r,parseExtension:et,valuePath:n})}var em=(t,e,{transform:r=!0,valuePath:n})=>{if(St(e)&&e[U]!==void 0)return{isExtension:!0,*extensionParser(){let s=new E(t).start(e[U],{fill:!1,transform:r,valuePath:[...n??[],"$SET"]}),o={[U]:s.next().value};if(r)yield o;else return o;return{[U]:s.next().value}}};if(S(e)||X(e)){if(er(e)&&e[be]!==void 0){let s=e[be],o=[...n??[],"$APPEND"];return X(s)?{isExtension:!0,*extensionParser(){let i=s.map((p,c)=>new E(t.elements).start(p,{fill:!1,transform:r,valuePath:[...o,c]})),a={[be]:i.map(p=>p.next().value)};if(r)yield a;else return a;return{[be]:i.map(p=>p.next().value)}}}:{isExtension:!0,*extensionParser(){let i=new E(t).start(s,{fill:!1,transform:r,parseExtension:$e,valuePath:o}),a={[be]:i.next().value};if(r)yield a;else return a;return{[be]:i.next().value}}}}if(tr(e)&&e[xe]!==void 0){let s=e[xe],o=[...n??[],"$PREPEND"];return X(s)?{isExtension:!0,*extensionParser(){let i=s.map((p,c)=>new E(t.elements).start(p,{fill:!1,transform:r,valuePath:[...o,c]})),a={[xe]:i.map(p=>p.next().value)};if(r)yield a;else return a;return{[xe]:i.map(p=>p.next().value)}}}:{isExtension:!0,*extensionParser(){let i=new E(t).start(s,{fill:!1,transform:r,parseExtension:$e,valuePath:o}),a={[xe]:i.next().value};if(r)yield a;else return a;return{[xe]:i.next().value}}}}return{isExtension:!0,*extensionParser(){let s=0,o=Object.fromEntries(Object.entries(e).map(([m,p])=>[m,uu(t,p,{transform:r,valuePath:[...n??[],m]})]));for(let m of Object.keys(o)){let p=parseFloat(m),c=n!==void 0?$(n):void 0;if(!ze(p))throw new d("parsing.invalidAttributeInput",{message:`Index of array attribute ${c!==void 0?`'${c}' `:""}is not a valid integer`,path:c,payload:{received:m}});s=Math.max(s,p)}let i=Object.fromEntries(Object.entries(o).map(([m,p])=>[m,p.next().value]).filter(([,m])=>m!==void 0));if(r)yield i;else return i;return[...Array(s+1).keys()].map(m=>{let p=o[m];return p===void 0?void 0:p.next().value})}}}return{isExtension:!1,unextendedInput:e}};var tm=(t,e,{transform:r=!0,valuePath:n}={})=>St(e)&&e[U]!==void 0?{isExtension:!0,*extensionParser(){let s=new E(t).start(e[U],{fill:!1,transform:r,valuePath:[...n??[],"$SET"]}),o={[U]:s.next().value};if(r)yield o;else return o;return{[U]:s.next().value}}}:{isExtension:!1,unextendedInput:e};var vs=(t,e,{transform:r=!0,valuePath:n}={})=>{let{props:s}=t;if(_r(e)&&e[pt]!==void 0)return{isExtension:!0,*extensionParser(){let o=e[pt],i=[...n??[],"$SUM"];if(!X(o)||o.length!==2){let f=$(i);throw new d("parsing.invalidAttributeInput",{message:`Sum for number attribute ${f!==void 0?`'${f}' `:""}should be a tuple of length 2`,path:f,payload:{received:e[pt]}})}let[a,m]=o,p=[new E(new K({big:s.big})).start(a,{fill:!1,transform:r,parseExtension:$e,valuePath:[...i,0]}),new E(new K({big:s.big})).start(m,{fill:!1,transform:r,parseExtension:$e,valuePath:[...i,1]})],c={[pt]:p.map(f=>f.next().value)};if(r)yield c;else return c;return{[pt]:p.map(f=>f.next().value)}}};if(Zr(e)&&e[mt]!==void 0)return{isExtension:!0,*extensionParser(){let o=e[mt],i=[...n??[],"$SUBTRACT"];if(!X(o)||o.length!==2){let f=$(i);throw new d("parsing.invalidAttributeInput",{message:`Subtraction for number attribute ${f!==void 0?`'${f}' `:""}should be a tuple of length 2`,path:f,payload:{received:e[mt]}})}let[a,m]=o,p=[new E(new K({big:s.big})).start(a,{fill:!1,transform:r,parseExtension:$e,valuePath:[...i,0]}),new E(new K({big:s.big})).start(m,{fill:!1,transform:r,parseExtension:$e,valuePath:[...i,1]})],c={[mt]:p.map(f=>f.next().value)};if(r)yield c;else return c;return{[mt]:p.map(f=>f.next().value)}}};if(_t(e)&&e[je]!==void 0){let o=new E(new K({big:s.big})).start(e[je],{fill:!1,transform:r,parseExtension:$e,valuePath:[...n??[],"$ADD"]});return{isExtension:!0,*extensionParser(){let i={[je]:o.next().value};if(r)yield i;else return i;return{[je]:o.next().value}}}}return{isExtension:!1,unextendedInput:e}};function*cu(t,e,{transform:r=!0,valuePath:n}={}){if(_e(e)){let s=e;if(r)yield s;else return s;return s}return yield*new E(t.elements).start(e,{mode:"update",fill:!1,transform:r,parseExtension:et,valuePath:n})}var rm=(t,e,{transform:r=!0,valuePath:n}={})=>St(e)&&e[U]!==void 0?{isExtension:!0,*extensionParser(){let s=new E(t).start(e[U],{fill:!1,transform:r,valuePath:[...n??[],"$SET"]}),o={[U]:s.next().value};if(r)yield o;else return o;return{[U]:s.next().value}}}:S(e)?{isExtension:!0,*extensionParser(){let s=Object.entries(e).filter(([,a])=>a!==void 0).map(([a,m])=>[new E(t.keys).start(a,{fill:!1,transform:r}),cu(t,m,{transform:r,valuePath:[...n??[],a]})]),o=Object.fromEntries(s.map(([a,m])=>[a.next().value,m.next().value]).filter(([,a])=>a!==void 0));if(r)yield o;else return o;return Object.fromEntries(s.map(([a,m])=>[a.next().value,m.next().value]).filter(([,a])=>a!==void 0))}}:{isExtension:!1,unextendedInput:e};var As=(t,e,{transform:r=!0,valuePath:n}={})=>_t(e)&&e[je]!==void 0?{isExtension:!0,*extensionParser(){let s=new E(t).start(e[je],{fill:!1,transform:r,valuePath:[...n??[],"$ADD"]}),o={[je]:s.next().value};if(r)yield o;else return o;return{[je]:s.next().value}}}:Yr(e)&&e[gt]!==void 0?{isExtension:!0,*extensionParser(){let s=new E(t).start(e[gt],{fill:!1,transform:r,valuePath:[...n??[],"$DELETE"]}),o={[gt]:s.next().value};if(r)yield o;else return o;return{[gt]:s.next().value}}}:{isExtension:!1,unextendedInput:e};var et=(t,e,r={})=>{let{transform:n=!0,valuePath:s}=r;if(_e(e))return{isExtension:!0,*extensionParser(){let{props:o}=t,{required:i}=o,a=s!==void 0?$(s):void 0;if(i!=="never")throw new d("parsing.attributeRequired",{message:`Attribute ${a!==void 0?`'${a}' `:""}is required and cannot be removed`,path:a});let m=e;if(n)yield m;else return m;return e}};if(Ye(e))return $e(t,e,r);switch(t.type){case"number":return vs(t,e,r);case"set":return As(t,e,r);case"list":return em(t,e,r);case"map":return tm(t,e,r);case"record":return rm(t,e,r);default:return{isExtension:!1,unextendedInput:e}}};var nm=new Set(["NONE","ALL_OLD","UPDATED_OLD","ALL_NEW","UPDATED_NEW"]);var sm=(t,e)=>{let r={},{capacity:n,metrics:s,returnValues:o,returnValuesOnConditionFalse:i,condition:a,tableName:m,...p}=e;if(B(p),n!==void 0&&(r.ReturnConsumedCapacity=oe(n)),s!==void 0&&(r.ReturnItemCollectionMetrics=Ze(s)),o!==void 0&&(r.ReturnValues=Yt(nm,o)),i!==void 0&&(r.ReturnValuesOnConditionCheckFailure=Ie(i)),a!==void 0){let{ExpressionAttributeNames:c,ExpressionAttributeValues:u,ConditionExpression:f}=t.build(Q).parse(a);r.ExpressionAttributeNames=c,r.ExpressionAttributeValues=u,r.ConditionExpression=f}return m!==void 0&&H(m),r};var bo=(t,e,r={})=>{var n;let{parsedItem:s,item:o,key:i}=t.build(F).parse(e,{mode:"update",parseExtension:et}),{ExpressionAttributeNames:a,ExpressionAttributeValues:m,...p}=gr(t,Xr(o,...Object.keys(i))),{ExpressionAttributeNames:c,ExpressionAttributeValues:u,...f}=sm(t,r),l={...c,...a},y={...u,...m};return{TableName:(n=r.tableName)!==null&&n!==void 0?n:t.table.getName(),ToolboxItem:s,Key:i,...p,...f,...N(l)?{}:{ExpressionAttributeNames:l},...N(y)?{}:{ExpressionAttributeValues:y}}};var du=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},rr=class t extends I{constructor(e,r,n={}){super(e),this[jn]=r,this[Rn]=n}item(e){return new t(this.entity,e,this[Rn])}options(e){return new t(this.entity,this[jn],e)}[Te](){if(!this[jn])throw new d("actions.incompleteAction",{message:'UpdateItemCommand incomplete: Missing "item" property'});return[this[jn],this[Rn]]}params(){let[e,r]=this[Te]();return bo(this.entity,e,r)}async send(e){let{ToolboxItem:r,...n}=this.params(),s=await this.entity.table.getDocumentClient().send(new om.UpdateCommand(n),e),{Attributes:o,...i}=s;if(o===void 0)return{ToolboxItem:r,...i};let{returnValues:a}=this[Rn],m=new _(this.entity).format(o,{partial:a==="UPDATED_NEW"||a==="UPDATED_OLD"});return{ToolboxItem:r,Attributes:m,...i}}};rr.actionName="updateItem";du([Et()],rr.prototype,"send",null);var dm=require("@aws-sdk/lib-dynamodb");var qn=Symbol("$item"),Ln=Symbol("$options");var im=(t,e,{transform:r=!0,valuePath:n}={})=>S(e)||X(e)?{isExtension:!0,*extensionParser(){let s=new E(t).start(e,{fill:!1,transform:r,valuePath:n}),o={[U]:s.next().value};if(r)yield o;else return o;return{[U]:s.next().value}}}:{isExtension:!1,unextendedInput:e};var am=(t,e,r)=>{let{transform:n=!0,valuePath:s}=r;if(S(e)){if(er(e)&&e[be]!==void 0){let o=e[be],i=[...s??[],"$APPEND"];return X(o)?{isExtension:!0,*extensionParser(){let a=o.map((c,u)=>new E(t.elements).start(c,{fill:!1,transform:n,valuePath:[...i,u]})),m={[be]:a.map(c=>c.next().value)};if(n)yield m;else return m;return{[be]:a.map(c=>c.next().value)}}}:{isExtension:!0,*extensionParser(){let a=new E(t).start(o,{fill:!1,transform:n,parseExtension:$e,valuePath:i}),m={[be]:a.next().value};if(n)yield m;else return m;return{[be]:a.next().value}}}}if(tr(e)&&e[xe]!==void 0){let o=e[xe],i=[...s??[],"$PREPEND"];return X(o)?{isExtension:!0,*extensionParser(){let a=o.map((c,u)=>new E(t.elements).start(c,{fill:!1,transform:n,valuePath:[...i,u]})),m={[xe]:a.map(c=>c.next().value)};if(n)yield m;else return m;return{[xe]:a.map(c=>c.next().value)}}}:{isExtension:!0,*extensionParser(){let a=new E(t).start(o,{fill:!1,transform:n,parseExtension:$e,valuePath:i}),m={[xe]:a.next().value};if(n)yield m;else return m;return{[xe]:a.next().value}}}}}return X(e)?{isExtension:!0,*extensionParser(){let o=new E(t).start(e,{fill:!1,transform:n,valuePath:s}),i={[U]:o.next().value};if(n)yield i;else return i;return{[U]:o.next().value}}}:{isExtension:!1,unextendedInput:e}};var mm=(t,e,{transform:r=!0,valuePath:n}={})=>S(e)?{isExtension:!0,*extensionParser(){let s=new E(t).start(e,{fill:!1,transform:r,valuePath:n}),o={[U]:s.next().value};if(r)yield o;else return o;return{[U]:s.next().value}}}:{isExtension:!1,unextendedInput:e};var pm=(t,e,{transform:r=!0,valuePath:n}={})=>S(e)?{isExtension:!0,*extensionParser(){let s=new E(t).start(e,{fill:!1,transform:r,valuePath:n}),o={[U]:s.next().value};if(r)yield o;else return o;return{[U]:s.next().value}}}:{isExtension:!1,unextendedInput:e};var en=(t,e,r={})=>{let{transform:n=!0,valuePath:s}=r;if(_e(e))return{isExtension:!0,*extensionParser(){let{props:o}=t,{required:i}=o,a=s!==void 0?$(s):void 0;if(i!=="never")throw new d("parsing.attributeRequired",{message:`Attribute ${a!==void 0?`'${a}' `:""}is required and cannot be removed`,path:a});let m=e;if(n)yield m;else return m;return e}};if(Ye(e)&&e[Ke]!==void 0)return $e(t,e,r);switch(t.type){case"any":return im(t,e,r);case"number":return vs(t,e,r);case"set":return As(t,e,r);case"list":return am(t,e,r);case"map":return mm(t,e,r);case"record":return pm(t,e,r);default:return{isExtension:!1,unextendedInput:e}}};var um=new Set(["NONE","ALL_OLD","UPDATED_OLD","ALL_NEW","UPDATED_NEW"]);var cm=(t,e)=>{let r={},{capacity:n,metrics:s,returnValues:o,returnValuesOnConditionFalse:i,condition:a,tableName:m,...p}=e;if(B(p),n!==void 0&&(r.ReturnConsumedCapacity=oe(n)),s!==void 0&&(r.ReturnItemCollectionMetrics=Ze(s)),o!==void 0&&(r.ReturnValues=Yt(um,o)),i!==void 0&&(r.ReturnValuesOnConditionCheckFailure=Ie(i)),a!==void 0){let{ExpressionAttributeNames:c,ExpressionAttributeValues:u,ConditionExpression:f}=t.build(Q).parse(a);r.ExpressionAttributeNames=c,r.ExpressionAttributeValues=u,r.ConditionExpression=f}return m!==void 0&&H(m),r};var xo=(t,e,r={})=>{var n;let{parsedItem:s,item:o,key:i}=t.build(F).parse(e,{mode:"update",parseExtension:en}),{ExpressionAttributeNames:a,ExpressionAttributeValues:m,...p}=gr(t,Xr(o,...Object.keys(i))),{ExpressionAttributeNames:c,ExpressionAttributeValues:u,...f}=cm(t,r),l={...c,...a},y={...u,...m};return{TableName:(n=r.tableName)!==null&&n!==void 0?n:t.table.getName(),ToolboxItem:s,Key:i,...p,...f,...N(l)?{}:{ExpressionAttributeNames:l},...N(y)?{}:{ExpressionAttributeValues:y}}};var lu=function(t,e,r,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(s<3?i(o):s>3?i(e,r,o):i(e,r))||o);return s>3&&o&&Object.defineProperty(e,r,o),o},nr=class t extends I{constructor(e,r,n={}){super(e),this[qn]=r,this[Ln]=n}item(e){return new t(this.entity,e,this[Ln])}options(e){return new t(this.entity,this[qn],e)}[Te](){if(!this[qn])throw new d("actions.incompleteAction",{message:'UpdateAttributesCommand incomplete: Missing "item" property'});return[this[qn],this[Ln]]}params(){let[e,r]=this[Te]();return xo(this.entity,e,r)}async send(e){let{ToolboxItem:r,...n}=this.params(),s=await this.entity.table.getDocumentClient().send(new dm.UpdateCommand(n),e),{Attributes:o,...i}=s;if(o===void 0)return{ToolboxItem:r,...i};let{returnValues:a}=this[Ln],m=new _(this.entity).format(o,{partial:a==="UPDATED_NEW"||a==="UPDATED_OLD"});return{ToolboxItem:r,Attributes:m,...i}}};nr.actionName="updateAttributes";lu([Et()],nr.prototype,"send",null);var fm=require("@aws-sdk/lib-dynamodb");var Bn=Symbol("$key"),tn=Symbol("$options");var lm=(t,e)=>{let r={},{attributes:n,tableName:s,...o}=e;if(B(o),n!==void 0){let{ExpressionAttributeNames:i,ProjectionExpression:a}=t.build(ye).parse(n);N(i)||(r.ExpressionAttributeNames=i),r.ProjectionExpression=a}return s!==void 0&&H(s),r};var Ot=class t extends I{constructor(e,r,n={}){super(e),this[Bn]=r,this[tn]=n}key(e){return new t(this.entity,e,this[tn])}options(e){return new t(this.entity,this[Bn],e)}params(){var e;if(!this[Bn])throw new d("actions.incompleteAction",{message:'GetTransaction incomplete: Missing "key" property'});let r=this[tn],{key:n}=this.entity.build(F).parse(this[Bn],{mode:"key"}),s=lm(this.entity,r);return{Get:{TableName:(e=r.tableName)!==null&&e!==void 0?e:this.entity.table.getName(),Key:n,...s}}}};Ot.actionName="transactGet";var fu=(t,...e)=>t.map(({Item:r},n)=>{let s=e[n],o=s.entity,{attributes:i}=s[tn];return{Item:r?new _(o).format(r,i?{attributes:i}:{}):void 0}}),ks=async(...t)=>{let[e={},...r]=t,n=r,s={};e instanceof Ot?n.unshift(e):s=e;let o=n[0];if(o===void 0)throw new d("actions.incompleteAction",{message:"transactGet incomplete: No GetTransaction supplied"});let{documentClient:i,capacity:a,...m}=s,p=i??o.entity.table.getDocumentClient(),{Responses:c,...u}=await p.send(new fm.TransactGetCommand(hu(n,{capacity:a})),m);return c===void 0?u:{...u,Responses:fu(c,...n)}},hu=(t,e={})=>{let{capacity:r,...n}=e;return B(n),{TransactItems:t.map(s=>s.params()),...r!==void 0?{ReturnConsumedCapacity:oe(r)}:{}}};var bm=require("@aws-sdk/lib-dynamodb");var hm=t=>{if(!M(t))throw new d("options.invalidClientRequestToken",{message:`Invalid client request token option: '${String(t)}'. 'clientRequestToken' must be a string.`,payload:{clientRequestToken:t}});return t};var ut=class extends I{},ym=t=>t instanceof ut;var $s=async(...t)=>{let[e={},...r]=t,n=r,s={};ym(e)?n.unshift(e):s=e;let o=n[0];if(o===void 0)throw new d("actions.incompleteAction",{message:"Cannot execute WriteTransactions: No transaction supplied"});let{documentClient:i,capacity:a,metrics:m,clientRequestToken:p,...c}=s,u=i??o.entity.table.getDocumentClient(),{TransactItems:f=[],...l}=bu(n,{capacity:a,metrics:m,clientRequestToken:p}),y=[];for(let b of f){let{ToolboxItem:O}=b;y.push(O),delete b.ToolboxItem}let x=await u.send(new bm.TransactWriteCommand({TransactItems:f,...l}),c);return{ToolboxItems:y,...x}},yu=t=>{let e={},{clientRequestToken:r,capacity:n,metrics:s,...o}=t;return B(o),r!==void 0&&(e.ClientRequestToken=hm(r)),n!==void 0&&(e.ReturnConsumedCapacity=oe(n)),s!==void 0&&(e.ReturnItemCollectionMetrics=Ze(s)),e},bu=(t,e={})=>({...yu(e),TransactItems:t.map(r=>r.params())});var Fn=Symbol("$item"),Ps=Symbol("$options");var xm=(t,e)=>{let r={},{condition:n,returnValuesOnConditionFalse:s,tableName:o,...i}=e;if(B(i),n!==void 0){let{ExpressionAttributeNames:a,ExpressionAttributeValues:m,ConditionExpression:p}=t.build(Q).parse(n);N(a)||(r.ExpressionAttributeNames=a),N(m)||(r.ExpressionAttributeValues=m),r.ConditionExpression=p}return s!==void 0&&(r.ReturnValuesOnConditionCheckFailure=Ie(s)),o!==void 0&&H(o),r};var Sr=class t extends ut{constructor(e,r,n={}){super(e),this[Fn]=r,this[Ps]=n}item(e){return new t(this.entity,e,this[Ps])}options(e){return new t(this.entity,this[Fn],e)}params(){var e;if(!this[Fn])throw new d("actions.incompleteAction",{message:'PutTransaction incomplete: Missing "item" property'});let r=this[Ps],{parsedItem:n,item:s}=this.entity.build(F).parse(this[Fn]),o=xm(this.entity,r);return{ToolboxItem:n,Put:{TableName:(e=r?.tableName)!==null&&e!==void 0?e:this.entity.table.getName(),Item:s,...o}}}};Sr.actionName="transactPut";var Un=Symbol("$item"),Ds=Symbol("$options");var wm=(t,e)=>{let r={},{condition:n,returnValuesOnConditionFalse:s,tableName:o,...i}=e;if(B(i),n!==void 0){let{ExpressionAttributeNames:a,ExpressionAttributeValues:m,ConditionExpression:p}=t.build(Q).parse(n);r.ExpressionAttributeNames=a,r.ExpressionAttributeValues=m,r.ConditionExpression=p}return s!==void 0&&(r.ReturnValuesOnConditionCheckFailure=Ie(s)),o!==void 0&&H(o),r};var Or=class t extends ut{constructor(e,r,n={}){super(e),this[Un]=r,this[Ds]=n}item(e){return new t(this.entity,e,this[Ds])}options(e){return new t(this.entity,this[Un],e)}params(){var e;if(!this[Un])throw new d("actions.incompleteAction",{message:'UpdateTransaction incomplete: Missing "item" property'});let{parsedItem:r,item:n,key:s}=this.entity.build(F).parse(this[Un],{mode:"update",parseExtension:et}),{ExpressionAttributeNames:o,ExpressionAttributeValues:i,UpdateExpression:a}=gr(this.entity,Xr(n,...Object.keys(s))),m=this[Ds],{ExpressionAttributeNames:p,ExpressionAttributeValues:c,...u}=wm(this.entity,m),f={...p,...o},l={...c,...i};return{ToolboxItem:r,Update:{TableName:(e=m.tableName)!==null&&e!==void 0?e:this.entity.table.getName(),Key:s,UpdateExpression:a,...u,...N(f)?{}:{ExpressionAttributeNames:f},...N(l)?{}:{ExpressionAttributeValues:l}}}}};Or.actionName="transactUpdate";var Mn=Symbol("$key"),Cs=Symbol("$options");var Em=(t,e)=>{let r={},{condition:n,returnValuesOnConditionFalse:s,tableName:o,...i}=e;if(B(i),n!==void 0){let{ExpressionAttributeNames:a,ExpressionAttributeValues:m,ConditionExpression:p}=t.build(Q).parse(n);N(a)||(r.ExpressionAttributeNames=a),N(m)||(r.ExpressionAttributeValues=m),r.ConditionExpression=p}return s!==void 0&&(r.ReturnValuesOnConditionCheckFailure=Ie(s)),o!==void 0&&H(o),r};var vr=class t extends ut{constructor(e,r,n={}){super(e),this[Mn]=r,this[Cs]=n}key(e){return new t(this.entity,e,this[Cs])}options(e){return new t(this.entity,this[Mn],e)}params(){var e;if(!this[Mn])throw new d("actions.incompleteAction",{message:'DeleteTransaction incomplete: Missing "key" property'});let r=this[Cs],{key:n}=this.entity.build(F).parse(this[Mn],{mode:"key"}),s=Em(this.entity,r);return{Delete:{TableName:(e=r.tableName)!==null&&e!==void 0?e:this.entity.table.getName(),Key:n,...s}}}};vr.actionName="transactDelete";var rn=Symbol("$key"),nn=Symbol("$condition"),zn=Symbol("$options");var gm=(t,e,r={})=>{let{returnValuesOnConditionFalse:n,tableName:s,...o}=r;B(o);let{ExpressionAttributeNames:i,ExpressionAttributeValues:a,ConditionExpression:m}=t.build(Q).parse(e),p={ConditionExpression:m};return N(i)||(p.ExpressionAttributeNames=i),N(a)||(p.ExpressionAttributeValues=a),n!==void 0&&(p.ReturnValuesOnConditionCheckFailure=Ie(n)),s!==void 0&&H(s),p};var Ar=class t extends ut{constructor(e,r,n,s={}){super(e),this[rn]=r,this[nn]=n,this[zn]=s}key(e){return new t(this.entity,e,this[nn],this[zn])}condition(e){return new t(this.entity,this[rn],e,this[zn])}options(e){return new t(this.entity,this[rn],this[nn],e)}params(){var e;if(!this[rn])throw new d("actions.incompleteAction",{message:'ConditionCheck incomplete: Missing "key" property'});if(!this[nn])throw new d("actions.incompleteAction",{message:'ConditionCheck incomplete: Missing "condition" property'});let r=this[zn],{key:n}=this.entity.build(F).parse(this[rn],{mode:"key"}),s=gm(this.entity,this[nn],r);return{ConditionCheck:{TableName:(e=r.tableName)!==null&&e!==void 0?e:this.entity.table.getName(),Key:n,...s}}}};Ar.actionName="conditionCheck";var sn=Symbol("$schema"),on=Symbol("$pattern"),an=Symbol("$options"),Kn=Symbol("$meta");var mn=class extends I{constructor(e,r,n,s={},o={}){super(e),this[sn]=r,this[on]=n,this[an]=s,this[Kn]=o}query(e){let r=this[sn];if(r===void 0)throw new d("actions.incompleteAction",{message:'AccessPattern incomplete: Missing "schema" property'});let n=this[on];if(n===void 0)throw new d("actions.incompleteAction",{message:'AccessPattern incomplete: Missing "pattern" property'});let o=new E(r).parse(e),i=n(o),a=this[an];return new pe(this.entity.table,[this.entity],i,a)}};mn.actionName="access-pattern";var pn=class t extends mn{constructor(e,r,n,s={},o={}){super(e,r,n,s,o)}schema(e){return new t(this.entity,e,this[on],this[an],this[Kn])}pattern(e){return new t(this.entity,this[sn],e,this[an],this[Kn])}options(e){return new t(this.entity,this[sn],this[on],e,this[Kn])}meta(e){return new t(this.entity,this[sn],this[on],this[an],e)}};var Sm=Symbol("$actionName"),Om=Symbol("$sentActions"),vm=Symbol("$spy"),Am=Symbol("$mocks");var Gn=class extends I{async put(e,r={}){return new at(this.entity,e,r).send()}async get(e,r={}){return new it(this.entity,e,r).send()}async update(e,r={}){return new rr(this.entity,e,r).send()}async updateAttributes(e,r={}){return new nr(this.entity,e,r).send()}async delete(e,r={}){return new Zt(this.entity,e,r).send()}async scan(e={}){return new wt(this.entity.table,[this.entity],e).send()}async query(e,r={}){return new pe(this.entity.table,[this.entity],e,r).send()}batchGet(e){return new Rt(this.entity,e)}batchPut(e){return new qt(this.entity,e)}batchDelete(e){return new st(this.entity,e)}static executeTransactGet(...e){return ks(...e)}transactGet(e,r={}){return new Ot(this.entity,e,r)}static executeTransactWrite(...e){return $s(...e)}transactPut(e,r={}){return new Sr(this.entity,e,r)}transactUpdate(e,r={}){return new Or(this.entity,e,r)}transactDelete(e,r={}){return new vr(this.entity,e,r)}transactCheck(e,r,n={}){return new Ar(this.entity,e,r,n)}accessPattern(e,r,n={}){return new pn(this.entity,e,r,n)}parse(e,r={}){return new F(this.entity).parse(e,r)}parseCondition(e,r={}){return new Q(this.entity).parse(e,r)}parsePaths(e,r={}){return new ye(this.entity).parse(e,r)}format(e,r={}){return new _(this.entity).format(e,r)}};Gn.actionName="repository";var un=class extends I{constructor(e){super(e);let r=new Ht(new Je(this.entity.attributes)),{partitionKey:n,sortKey:s}=this.entity.table;Object.entries(r.attributes).find(([i,a])=>{var m;return((m=a.savedAs)!==null&&m!==void 0?m:i)===n.name})===void 0&&(r.attributes[n.name]={type:n.type,key:!0,required:"always",hidden:!0}),s!==void 0&&Object.entries(r.attributes).find(([a,m])=>{var p;return((p=m.savedAs)!==null&&p!==void 0?p:a)===s.name})===void 0&&(r.attributes[s.name]={type:s.type,key:!0,required:"always",hidden:!0}),this.entityName=this.entity.entityName,this.schema=r,this.entityAttribute=this.entity.entityAttribute,this.timestamps=this.entity.timestamps,this.table=this.entity.table.build(Xt)}toJSON(){return{entityName:this.entityName,schema:this.schema.toJSON(),entityAttribute:this.entity.entityAttribute,timestamps:this.entity.timestamps,table:this.table.toJSON()}}};un.actionName="dto";var $m=require("@aws-sdk/client-dynamodb"),Pm=require("@aws-sdk/lib-dynamodb");var wu=Pm.DynamoDBDocumentClient.from(new $m.DynamoDBClient),tt=new lr({name:process.env.TABLE_NAME,partitionKey:{name:"userId",type:"string"},sortKey:{name:"timestamp",type:"string"},documentClient:wu,indexes:{"status-time-index":{type:"global",partitionKey:{name:"status",type:"string"},sortKey:{name:"time",type:"number"}}}});var Dm=new Vt({name:"Game",schema:Pt({userId:he().key(),timestamp:he().key(),bombsExploded:G().optional(),cellsRevealed:G().optional(),date:he().optional(),gameRestarts:G().optional(),lastUpdated:he().optional(),noFlagWin:qr().optional(),rawUserId:he().optional(),time:G().optional(),timePlayed:G().optional(),usedFlags:G().optional(),status:he().optional(),userName:he().optional(),userImage:he().optional(),ttl:G()}),timestamps:{created:!1,modified:!1},table:tt});var Ts=new Vt({name:"UserStats",schema:Pt({userId:he().key(),timestamp:he().key(),fastestWin:G().optional(),gamesAbandoned:G().optional(),gamesLost:G().optional(),gamesPlayed:G().optional(),gamesRestarted:G().optional(),gamesWon:G().optional(),noFlagWins:G().optional(),totalBombsExploded:G().optional(),totalCellsRevealed:G().optional(),totalFlagsPlaced:G().optional(),totalGameRestarts:G().optional(),totalTimePlayed:G().optional(),totalWinTime:G().optional(),userName:he().optional(),userImage:he().optional(),status:he().optional(),time:G().optional(),ttl:G()}),timestamps:{created:!1,modified:!1},table:tt});var wo=(t,e,r)=>(n,s)=>{let o=-1;return i(0);async function i(a){if(a<=o)throw new Error("next() called multiple times");o=a;let m,p=!1,c;if(t[a]?(c=t[a][0][0],n.req.routeIndex=a):c=a===t.length&&s||void 0,c)try{m=await c(n,()=>i(a+1))}catch(u){if(u instanceof Error&&e)n.error=u,m=await e(u,n),p=!0;else throw u}else n.finalized===!1&&r&&(m=await r(n));return m&&(n.finalized===!1||p)&&(n.res=m),n}};var Cm=async(t,e=Object.create(null))=>{let{all:r=!1,dot:n=!1}=e,o=(t instanceof Ns?t.raw.headers:t.headers).get("Content-Type");return o?.startsWith("multipart/form-data")||o?.startsWith("application/x-www-form-urlencoded")?Eu(t,{all:r,dot:n}):{}};async function Eu(t,e){let r=await t.formData();return r?gu(r,e):{}}function gu(t,e){let r=Object.create(null);return t.forEach((n,s)=>{e.all||s.endsWith("[]")?Su(r,s,n):r[s]=n}),e.dot&&Object.entries(r).forEach(([n,s])=>{n.includes(".")&&(Ou(r,n,s),delete r[n])}),r}var Su=(t,e,r)=>{t[e]!==void 0?Array.isArray(t[e])?t[e].push(r):t[e]=[t[e],r]:t[e]=r},Ou=(t,e,r)=>{let n=t,s=e.split(".");s.forEach((o,i)=>{i===s.length-1?n[o]=r:((!n[o]||typeof n[o]!="object"||Array.isArray(n[o])||n[o]instanceof File)&&(n[o]=Object.create(null)),n=n[o])})};var go=t=>{let e=t.split("/");return e[0]===""&&e.shift(),e},Tm=t=>{let{groups:e,path:r}=vu(t),n=go(r);return Au(n,e)},vu=t=>{let e=[];return t=t.replace(/\{[^}]+\}/g,(r,n)=>{let s=`@${n}`;return e.push([s,r]),s}),{groups:e,path:t}},Au=(t,e)=>{for(let r=e.length-1;r>=0;r--){let[n]=e[r];for(let s=t.length-1;s>=0;s--)if(t[s].includes(n)){t[s]=t[s].replace(n,e[r][1]);break}}return t},Is={},So=(t,e)=>{if(t==="*")return"*";let r=t.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){let n=`${t}#${e}`;return Is[n]||(r[2]?Is[n]=e&&e[0]!==":"&&e[0]!=="*"?[n,r[1],new RegExp(`^${r[2]}(?=/${e})`)]:[t,r[1],new RegExp(`^${r[2]}$`)]:Is[n]=[t,r[1],!0]),Is[n]}return null},Oo=(t,e)=>{try{return e(t)}catch{return t.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return e(r)}catch{return r}})}},ku=t=>Oo(t,decodeURI),vo=t=>{let e=t.url,r=e.indexOf("/",8),n=r;for(;n<e.length;n++){let s=e.charCodeAt(n);if(s===37){let o=e.indexOf("?",n),i=e.slice(r,o===-1?void 0:o);return ku(i.includes("%25")?i.replace(/%25/g,"%2525"):i)}else if(s===63)break}return e.slice(r,n)};var Nm=t=>{let e=vo(t);return e.length>1&&e.at(-1)==="/"?e.slice(0,-1):e},kr=(t,e,...r)=>(r.length&&(e=kr(e,...r)),`${t?.[0]==="/"?"":"/"}${t}${e==="/"?"":`${t?.at(-1)==="/"?"":"/"}${e?.[0]==="/"?e.slice(1):e}`}`),Vs=t=>{if(t.charCodeAt(t.length-1)!==63||!t.includes(":"))return null;let e=t.split("/"),r=[],n="";return e.forEach(s=>{if(s!==""&&!/\:/.test(s))n+="/"+s;else if(/\:/.test(s))if(/\?/.test(s)){r.length===0&&n===""?r.push("/"):r.push(n);let o=s.replace("?","");n+="/"+o,r.push(n)}else n+="/"+s}),r.filter((s,o,i)=>i.indexOf(s)===o)},Eo=t=>/[%+]/.test(t)?(t.indexOf("+")!==-1&&(t=t.replace(/\+/g," ")),t.indexOf("%")!==-1?Ao(t):t):t,Im=(t,e,r)=>{let n;if(!r&&e&&!/[%+]/.test(e)){let i=t.indexOf(`?${e}`,8);for(i===-1&&(i=t.indexOf(`&${e}`,8));i!==-1;){let a=t.charCodeAt(i+e.length+1);if(a===61){let m=i+e.length+2,p=t.indexOf("&",m);return Eo(t.slice(m,p===-1?void 0:p))}else if(a==38||isNaN(a))return"";i=t.indexOf(`&${e}`,i+1)}if(n=/[%+]/.test(t),!n)return}let s={};n??(n=/[%+]/.test(t));let o=t.indexOf("?",8);for(;o!==-1;){let i=t.indexOf("&",o+1),a=t.indexOf("=",o);a>i&&i!==-1&&(a=-1);let m=t.slice(o+1,a===-1?i===-1?void 0:i:a);if(n&&(m=Eo(m)),o=i,m==="")continue;let p;a===-1?p="":(p=t.slice(a+1,i===-1?void 0:i),n&&(p=Eo(p))),r?(s[m]&&Array.isArray(s[m])||(s[m]=[]),s[m].push(p)):s[m]??(s[m]=p)}return e?s[e]:s},Vm=Im,jm=(t,e)=>Im(t,e,!0),Ao=decodeURIComponent;var Rm=t=>Oo(t,Ao),cn,ct,Lt,Lm,Bm,ko,sr,qm,Ns=(qm=class{constructor(t,e="/",r=[[]]){k(this,Lt);A(this,"raw");k(this,cn);k(this,ct);A(this,"routeIndex",0);A(this,"path");A(this,"bodyCache",{});k(this,sr,t=>{let{bodyCache:e,raw:r}=this,n=e[t];if(n)return n;let s=Object.keys(e)[0];return s?e[s].then(o=>(s==="json"&&(o=JSON.stringify(o)),new Response(o)[t]())):e[t]=r[t]()});this.raw=t,this.path=e,g(this,ct,r),g(this,cn,{})}param(t){return t?T(this,Lt,Lm).call(this,t):T(this,Lt,Bm).call(this)}query(t){return Vm(this.url,t)}queries(t){return jm(this.url,t)}header(t){if(t)return this.raw.headers.get(t)??void 0;let e={};return this.raw.headers.forEach((r,n)=>{e[n]=r}),e}async parseBody(t){var e;return(e=this.bodyCache).parsedBody??(e.parsedBody=await Cm(this,t))}json(){return h(this,sr).call(this,"json")}text(){return h(this,sr).call(this,"text")}arrayBuffer(){return h(this,sr).call(this,"arrayBuffer")}blob(){return h(this,sr).call(this,"blob")}formData(){return h(this,sr).call(this,"formData")}addValidatedData(t,e){h(this,cn)[t]=e}valid(t){return h(this,cn)[t]}get url(){return this.raw.url}get method(){return this.raw.method}get matchedRoutes(){return h(this,ct)[0].map(([[,t]])=>t)}get routePath(){return h(this,ct)[0].map(([[,t]])=>t)[this.routeIndex].path}},cn=new WeakMap,ct=new WeakMap,Lt=new WeakSet,Lm=function(t){let e=h(this,ct)[0][this.routeIndex][1][t],r=T(this,Lt,ko).call(this,e);return r?/\%/.test(r)?Rm(r):r:void 0},Bm=function(){let t={},e=Object.keys(h(this,ct)[0][this.routeIndex][1]);for(let r of e){let n=T(this,Lt,ko).call(this,h(this,ct)[0][this.routeIndex][1][r]);n&&typeof n=="string"&&(t[r]=/\%/.test(n)?Rm(n):n)}return t},ko=function(t){return h(this,ct)[1]?h(this,ct)[1][t]:t},sr=new WeakMap,qm);var Fm={Stringify:1,BeforeStream:2,Stream:3},$u=(t,e)=>{let r=new String(t);return r.isEscaped=!0,r.callbacks=e,r};var $o=async(t,e,r,n,s)=>{typeof t=="object"&&!(t instanceof String)&&(t instanceof Promise||(t=t.toString()),t instanceof Promise&&(t=await t));let o=t.callbacks;if(!o?.length)return Promise.resolve(t);s?s[0]+=t:s=[t];let i=Promise.all(o.map(a=>a({phase:e,buffer:s,context:n}))).then(a=>Promise.all(a.filter(Boolean).map(m=>$o(m,e,!1,n,s))).then(()=>s[0]));return r?$u(await i,o):i};var Pu="text/plain; charset=UTF-8",Po=(t,e={})=>{for(let r of Object.keys(e))t.set(r,e[r]);return t},Wn,Hn,Bt,$r,Ft,se,ue,Ge,Ut,Jn,dn,ln,Qn,Xn,Fe,rt,Um,Mm=(Um=class{constructor(t,e){k(this,Fe);k(this,Wn);k(this,Hn);A(this,"env",{});k(this,Bt);A(this,"finalized",!1);A(this,"error");k(this,$r,200);k(this,Ft);k(this,se);k(this,ue);k(this,Ge);k(this,Ut,!0);k(this,Jn);k(this,dn);k(this,ln);k(this,Qn);k(this,Xn);A(this,"render",(...t)=>(h(this,dn)??g(this,dn,e=>this.html(e)),h(this,dn).call(this,...t)));A(this,"setLayout",t=>g(this,Jn,t));A(this,"getLayout",()=>h(this,Jn));A(this,"setRenderer",t=>{g(this,dn,t)});A(this,"header",(t,e,r)=>{if(this.finalized&&g(this,Ge,new Response(h(this,Ge).body,h(this,Ge))),e===void 0){h(this,se)?h(this,se).delete(t):h(this,ue)&&delete h(this,ue)[t.toLocaleLowerCase()],this.finalized&&this.res.headers.delete(t);return}r?.append?(h(this,se)||(g(this,Ut,!1),g(this,se,new Headers(h(this,ue))),g(this,ue,{})),h(this,se).append(t,e)):h(this,se)?h(this,se).set(t,e):(h(this,ue)??g(this,ue,{}),h(this,ue)[t.toLowerCase()]=e),this.finalized&&(r?.append?this.res.headers.append(t,e):this.res.headers.set(t,e))});A(this,"status",t=>{g(this,Ut,!1),g(this,$r,t)});A(this,"set",(t,e)=>{h(this,Bt)??g(this,Bt,new Map),h(this,Bt).set(t,e)});A(this,"get",t=>h(this,Bt)?h(this,Bt).get(t):void 0);A(this,"newResponse",(...t)=>T(this,Fe,rt).call(this,...t));A(this,"body",(t,e,r)=>typeof e=="number"?T(this,Fe,rt).call(this,t,e,r):T(this,Fe,rt).call(this,t,e));A(this,"text",(t,e,r)=>{if(!h(this,ue)){if(h(this,Ut)&&!r&&!e)return new Response(t);g(this,ue,{})}return h(this,ue)["content-type"]=Pu,typeof e=="number"?T(this,Fe,rt).call(this,t,e,r):T(this,Fe,rt).call(this,t,e)});A(this,"json",(t,e,r)=>{let n=JSON.stringify(t);return h(this,ue)??g(this,ue,{}),h(this,ue)["content-type"]="application/json",typeof e=="number"?T(this,Fe,rt).call(this,n,e,r):T(this,Fe,rt).call(this,n,e)});A(this,"html",(t,e,r)=>(h(this,ue)??g(this,ue,{}),h(this,ue)["content-type"]="text/html; charset=UTF-8",typeof t=="object"?$o(t,Fm.Stringify,!1,{}).then(n=>typeof e=="number"?T(this,Fe,rt).call(this,n,e,r):T(this,Fe,rt).call(this,n,e)):typeof e=="number"?T(this,Fe,rt).call(this,t,e,r):T(this,Fe,rt).call(this,t,e)));A(this,"redirect",(t,e)=>(h(this,se)??g(this,se,new Headers),h(this,se).set("Location",String(t)),this.newResponse(null,e??302)));A(this,"notFound",()=>(h(this,ln)??g(this,ln,()=>new Response),h(this,ln).call(this,this)));g(this,Wn,t),e&&(g(this,Ft,e.executionCtx),this.env=e.env,g(this,ln,e.notFoundHandler),g(this,Xn,e.path),g(this,Qn,e.matchResult))}get req(){return h(this,Hn)??g(this,Hn,new Ns(h(this,Wn),h(this,Xn),h(this,Qn))),h(this,Hn)}get event(){if(h(this,Ft)&&"respondWith"in h(this,Ft))return h(this,Ft);throw Error("This context has no FetchEvent")}get executionCtx(){if(h(this,Ft))return h(this,Ft);throw Error("This context has no ExecutionContext")}get res(){return g(this,Ut,!1),h(this,Ge)||g(this,Ge,new Response("404 Not Found",{status:404}))}set res(t){if(g(this,Ut,!1),h(this,Ge)&&t){t=new Response(t.body,t);for(let[e,r]of h(this,Ge).headers.entries())if(e!=="content-type")if(e==="set-cookie"){let n=h(this,Ge).headers.getSetCookie();t.headers.delete("set-cookie");for(let s of n)t.headers.append("set-cookie",s)}else t.headers.set(e,r)}g(this,Ge,t),this.finalized=!0}get var(){return h(this,Bt)?Object.fromEntries(h(this,Bt)):{}}},Wn=new WeakMap,Hn=new WeakMap,Bt=new WeakMap,$r=new WeakMap,Ft=new WeakMap,se=new WeakMap,ue=new WeakMap,Ge=new WeakMap,Ut=new WeakMap,Jn=new WeakMap,dn=new WeakMap,ln=new WeakMap,Qn=new WeakMap,Xn=new WeakMap,Fe=new WeakSet,rt=function(t,e,r){if(h(this,Ut)&&!r&&!e&&h(this,$r)===200)return new Response(t,{headers:h(this,ue)});if(e&&typeof e!="number"){let s=new Headers(e.headers);h(this,se)&&h(this,se).forEach((i,a)=>{a==="set-cookie"?s.append(a,i):s.set(a,i)});let o=Po(s,h(this,ue));return new Response(t,{headers:o,status:e.status??h(this,$r)})}let n=typeof e=="number"?e:h(this,$r);h(this,ue)??g(this,ue,{}),h(this,se)??g(this,se,new Headers),Po(h(this,se),h(this,ue)),h(this,Ge)&&(h(this,Ge).headers.forEach((s,o)=>{o==="set-cookie"?h(this,se)?.append(o,s):h(this,se)?.set(o,s)}),Po(h(this,se),h(this,ue))),r??(r={});for(let[s,o]of Object.entries(r))if(typeof o=="string")h(this,se).set(s,o);else{h(this,se).delete(s);for(let i of o)h(this,se).append(s,i)}return new Response(t,{status:n,headers:h(this,se)})},Um);var ie="ALL",zm="all",Km=["get","post","put","delete","options","patch"],js="Can not add a route since the matcher is already built.",Rs=class extends Error{};var Gm="__COMPOSED_HANDLER";var Du=t=>t.text("404 Not Found",404),Wm=(t,e)=>{if("getResponse"in t){let r=t.getResponse();return e.newResponse(r.body,r)}return console.error(t),e.text("Internal Server Error",500)},dt,we,Jm,lt,Pr,qs,Ls,Hm,Do=(Hm=class{constructor(t={}){k(this,we);A(this,"get");A(this,"post");A(this,"put");A(this,"delete");A(this,"options");A(this,"patch");A(this,"all");A(this,"on");A(this,"use");A(this,"router");A(this,"getPath");A(this,"_basePath","/");k(this,dt,"/");A(this,"routes",[]);k(this,lt,Du);A(this,"errorHandler",Wm);A(this,"onError",t=>(this.errorHandler=t,this));A(this,"notFound",t=>(g(this,lt,t),this));A(this,"fetch",(t,...e)=>T(this,we,Ls).call(this,t,e[1],e[0],t.method));A(this,"request",(t,e,r,n)=>t instanceof Request?this.fetch(e?new Request(t,e):t,r,n):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${kr("/",t)}`,e),r,n)));A(this,"fire",()=>{addEventListener("fetch",t=>{t.respondWith(T(this,we,Ls).call(this,t.request,t,void 0,t.request.method))})});[...Km,zm].forEach(s=>{this[s]=(o,...i)=>(typeof o=="string"?g(this,dt,o):T(this,we,Pr).call(this,s,h(this,dt),o),i.forEach(a=>{T(this,we,Pr).call(this,s,h(this,dt),a)}),this)}),this.on=(s,o,...i)=>{for(let a of[o].flat()){g(this,dt,a);for(let m of[s].flat())i.map(p=>{T(this,we,Pr).call(this,m.toUpperCase(),h(this,dt),p)})}return this},this.use=(s,...o)=>(typeof s=="string"?g(this,dt,s):(g(this,dt,"*"),o.unshift(s)),o.forEach(i=>{T(this,we,Pr).call(this,ie,h(this,dt),i)}),this);let{strict:r,...n}=t;Object.assign(this,n),this.getPath=r??!0?t.getPath??vo:Nm}route(t,e){let r=this.basePath(t);return e.routes.map(n=>{var o;let s;e.errorHandler===Wm?s=n.handler:(s=async(i,a)=>(await wo([],e.errorHandler)(i,()=>n.handler(i,a))).res,s[Gm]=n.handler),T(o=r,we,Pr).call(o,n.method,n.path,s)}),this}basePath(t){let e=T(this,we,Jm).call(this);return e._basePath=kr(this._basePath,t),e}mount(t,e,r){let n,s;r&&(typeof r=="function"?s=r:(s=r.optionHandler,r.replaceRequest===!1?n=a=>a:n=r.replaceRequest));let o=s?a=>{let m=s(a);return Array.isArray(m)?m:[m]}:a=>{let m;try{m=a.executionCtx}catch{}return[a.env,m]};n||(n=(()=>{let a=kr(this._basePath,t),m=a==="/"?0:a.length;return p=>{let c=new URL(p.url);return c.pathname=c.pathname.slice(m)||"/",new Request(c,p)}})());let i=async(a,m)=>{let p=await e(n(a.req.raw),...o(a));if(p)return p;await m()};return T(this,we,Pr).call(this,ie,kr(t,"*"),i),this}},dt=new WeakMap,we=new WeakSet,Jm=function(){let t=new Do({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,g(t,lt,h(this,lt)),t.routes=this.routes,t},lt=new WeakMap,Pr=function(t,e,r){t=t.toUpperCase(),e=kr(this._basePath,e);let n={path:e,method:t,handler:r};this.router.add(t,e,[r,n]),this.routes.push(n)},qs=function(t,e){if(t instanceof Error)return this.errorHandler(t,e);throw t},Ls=function(t,e,r,n){if(n==="HEAD")return(async()=>new Response(null,await T(this,we,Ls).call(this,t,e,r,"GET")))();let s=this.getPath(t,{env:r}),o=this.router.match(n,s),i=new Mm(t,{path:s,matchResult:o,env:r,executionCtx:e,notFoundHandler:h(this,lt)});if(o[0].length===1){let m;try{m=o[0][0][0][0](i,async()=>{i.res=await h(this,lt).call(this,i)})}catch(p){return T(this,we,qs).call(this,p,i)}return m instanceof Promise?m.then(p=>p||(i.finalized?i.res:h(this,lt).call(this,i))).catch(p=>T(this,we,qs).call(this,p,i)):m??h(this,lt).call(this,i)}let a=wo(o[0],this.errorHandler,h(this,lt));return(async()=>{try{let m=await a(i);if(!m.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return m.res}catch(m){return T(this,we,qs).call(this,m,i)}})()},Hm);var Bs="[^/]+",Yn=".*",Zn="(?:|/.*)",fn=Symbol(),Cu=new Set(".\\+*[^]$()");function Tu(t,e){return t.length===1?e.length===1?t<e?-1:1:-1:e.length===1||t===Yn||t===Zn?1:e===Yn||e===Zn?-1:t===Bs?1:e===Bs?-1:t.length===e.length?t<e?-1:1:e.length-t.length}var Dr,Cr,ft,Qm,Fs=(Qm=class{constructor(){k(this,Dr);k(this,Cr);k(this,ft,Object.create(null))}insert(t,e,r,n,s){if(t.length===0){if(h(this,Dr)!==void 0)throw fn;if(s)return;g(this,Dr,e);return}let[o,...i]=t,a=o==="*"?i.length===0?["","",Yn]:["","",Bs]:o==="/*"?["","",Zn]:o.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),m;if(a){let p=a[1],c=a[2]||Bs;if(p&&a[2]&&(c=c.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(c)))throw fn;if(m=h(this,ft)[c],!m){if(Object.keys(h(this,ft)).some(u=>u!==Yn&&u!==Zn))throw fn;if(s)return;m=h(this,ft)[c]=new Fs,p!==""&&g(m,Cr,n.varIndex++)}!s&&p!==""&&r.push([p,h(m,Cr)])}else if(m=h(this,ft)[o],!m){if(Object.keys(h(this,ft)).some(p=>p.length>1&&p!==Yn&&p!==Zn))throw fn;if(s)return;m=h(this,ft)[o]=new Fs}m.insert(i,e,r,n,s)}buildRegExpStr(){let e=Object.keys(h(this,ft)).sort(Tu).map(r=>{let n=h(this,ft)[r];return(typeof h(n,Cr)=="number"?`(${r})@${h(n,Cr)}`:Cu.has(r)?`\\${r}`:r)+n.buildRegExpStr()});return typeof h(this,Dr)=="number"&&e.unshift(`#${h(this,Dr)}`),e.length===0?"":e.length===1?e[0]:"(?:"+e.join("|")+")"}},Dr=new WeakMap,Cr=new WeakMap,ft=new WeakMap,Qm);var Us,_n,Xm,Ym=(Xm=class{constructor(){k(this,Us,{varIndex:0});k(this,_n,new Fs)}insert(t,e,r){let n=[],s=[];for(let i=0;;){let a=!1;if(t=t.replace(/\{[^}]+\}/g,m=>{let p=`@\\${i}`;return s[i]=[p,m],i++,a=!0,p}),!a)break}let o=t.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let i=s.length-1;i>=0;i--){let[a]=s[i];for(let m=o.length-1;m>=0;m--)if(o[m].indexOf(a)!==-1){o[m]=o[m].replace(a,s[i][1]);break}}return h(this,_n).insert(o,e,n,h(this,Us),r),n}buildRegExp(){let t=h(this,_n).buildRegExpStr();if(t==="")return[/^$/,[],[]];let e=0,r=[],n=[];return t=t.replace(/#(\d+)|@(\d+)|\.\*\$/g,(s,o,i)=>o!==void 0?(r[++e]=Number(o),"$()"):(i!==void 0&&(n[Number(i)]=++e),"")),[new RegExp(`^${t}`),r,n]}},Us=new WeakMap,_n=new WeakMap,Xm);var _m=[],Nu=[/^$/,[],Object.create(null)],Ms=Object.create(null);function ep(t){return Ms[t]??(Ms[t]=new RegExp(t==="*"?"":`^${t.replace(/\/\*$|([.\\+*[^\]$()])/g,(e,r)=>r?`\\${r}`:"(?:|/.*)")}$`))}function Iu(){Ms=Object.create(null)}function Vu(t){let e=new Ym,r=[];if(t.length===0)return Nu;let n=t.map(p=>[!/\*|\/:/.test(p[0]),...p]).sort(([p,c],[u,f])=>p?1:u?-1:c.length-f.length),s=Object.create(null);for(let p=0,c=-1,u=n.length;p<u;p++){let[f,l,y]=n[p];f?s[l]=[y.map(([b])=>[b,Object.create(null)]),_m]:c++;let x;try{x=e.insert(l,c,f)}catch(b){throw b===fn?new Rs(l):b}f||(r[c]=y.map(([b,O])=>{let v=Object.create(null);for(O-=1;O>=0;O--){let[D,V]=x[O];v[D]=V}return[b,v]}))}let[o,i,a]=e.buildRegExp();for(let p=0,c=r.length;p<c;p++)for(let u=0,f=r[p].length;u<f;u++){let l=r[p][u]?.[1];if(!l)continue;let y=Object.keys(l);for(let x=0,b=y.length;x<b;x++)l[y[x]]=a[l[y[x]]]}let m=[];for(let p in i)m[p]=r[i[p]];return[o,m,s]}function hn(t,e){if(t){for(let r of Object.keys(t).sort((n,s)=>s.length-n.length))if(ep(r).test(e))return[...t[r]]}}var or,ir,yn,tp,rp,Zm,Co=(Zm=class{constructor(){k(this,yn);A(this,"name","RegExpRouter");k(this,or);k(this,ir);g(this,or,{[ie]:Object.create(null)}),g(this,ir,{[ie]:Object.create(null)})}add(t,e,r){var a;let n=h(this,or),s=h(this,ir);if(!n||!s)throw new Error(js);n[t]||[n,s].forEach(m=>{m[t]=Object.create(null),Object.keys(m[ie]).forEach(p=>{m[t][p]=[...m[ie][p]]})}),e==="/*"&&(e="*");let o=(e.match(/\/:/g)||[]).length;if(/\*$/.test(e)){let m=ep(e);t===ie?Object.keys(n).forEach(p=>{var c;(c=n[p])[e]||(c[e]=hn(n[p],e)||hn(n[ie],e)||[])}):(a=n[t])[e]||(a[e]=hn(n[t],e)||hn(n[ie],e)||[]),Object.keys(n).forEach(p=>{(t===ie||t===p)&&Object.keys(n[p]).forEach(c=>{m.test(c)&&n[p][c].push([r,o])})}),Object.keys(s).forEach(p=>{(t===ie||t===p)&&Object.keys(s[p]).forEach(c=>m.test(c)&&s[p][c].push([r,o]))});return}let i=Vs(e)||[e];for(let m=0,p=i.length;m<p;m++){let c=i[m];Object.keys(s).forEach(u=>{var f;(t===ie||t===u)&&((f=s[u])[c]||(f[c]=[...hn(n[u],c)||hn(n[ie],c)||[]]),s[u][c].push([r,o-p+m+1]))})}}match(t,e){Iu();let r=T(this,yn,tp).call(this);return this.match=(n,s)=>{let o=r[n]||r[ie],i=o[2][s];if(i)return i;let a=s.match(o[0]);if(!a)return[[],_m];let m=a.indexOf("",1);return[o[1][m],a]},this.match(t,e)}},or=new WeakMap,ir=new WeakMap,yn=new WeakSet,tp=function(){let t=Object.create(null);return Object.keys(h(this,ir)).concat(Object.keys(h(this,or))).forEach(e=>{t[e]||(t[e]=T(this,yn,rp).call(this,e))}),g(this,or,g(this,ir,void 0)),t},rp=function(t){let e=[],r=t===ie;return[h(this,or),h(this,ir)].forEach(n=>{let s=n[t]?Object.keys(n[t]).map(o=>[o,n[t][o]]):[];s.length!==0?(r||(r=!0),e.push(...s)):t!==ie&&e.push(...Object.keys(n[ie]).map(o=>[o,n[ie][o]]))}),r?Vu(e):null},Zm);var ar,Mt,np,To=(np=class{constructor(t){A(this,"name","SmartRouter");k(this,ar,[]);k(this,Mt,[]);g(this,ar,t.routers)}add(t,e,r){if(!h(this,Mt))throw new Error(js);h(this,Mt).push([t,e,r])}match(t,e){if(!h(this,Mt))throw new Error("Fatal error");let r=h(this,ar),n=h(this,Mt),s=r.length,o=0,i;for(;o<s;o++){let a=r[o];try{for(let m=0,p=n.length;m<p;m++)a.add(...n[m]);i=a.match(t,e)}catch(m){if(m instanceof Rs)continue;throw m}this.match=a.match.bind(a),g(this,ar,[a]),g(this,Mt,void 0);break}if(o===s)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,i}get activeRouter(){if(h(this,Mt)||h(this,ar).length!==1)throw new Error("No active router has been determined yet.");return h(this,ar)[0]}},ar=new WeakMap,Mt=new WeakMap,np);var es=Object.create(null),mr,Ve,Nr,bn,Pe,zt,Tr,sp,No=(sp=class{constructor(t,e,r){k(this,zt);k(this,mr);k(this,Ve);k(this,Nr);k(this,bn,0);k(this,Pe,es);if(g(this,Ve,r||Object.create(null)),g(this,mr,[]),t&&e){let n=Object.create(null);n[t]={handler:e,possibleKeys:[],score:0},g(this,mr,[n])}g(this,Nr,[])}insert(t,e,r){g(this,bn,++Lo(this,bn)._);let n=this,s=Tm(e),o=[];for(let m=0,p=s.length;m<p;m++){let c=s[m],u=s[m+1],f=So(c,u),l=Array.isArray(f)?f[0]:c;if(Object.keys(h(n,Ve)).includes(l)){n=h(n,Ve)[l];let y=So(c,u);y&&o.push(y[1]);continue}h(n,Ve)[l]=new No,f&&(h(n,Nr).push(f),o.push(f[1])),n=h(n,Ve)[l]}let i=Object.create(null),a={handler:r,possibleKeys:o.filter((m,p,c)=>c.indexOf(m)===p),score:h(this,bn)};return i[t]=a,h(n,mr).push(i),n}search(t,e){let r=[];g(this,Pe,es);let s=[this],o=go(e),i=[];for(let a=0,m=o.length;a<m;a++){let p=o[a],c=a===m-1,u=[];for(let f=0,l=s.length;f<l;f++){let y=s[f],x=h(y,Ve)[p];x&&(g(x,Pe,h(y,Pe)),c?(h(x,Ve)["*"]&&r.push(...T(this,zt,Tr).call(this,h(x,Ve)["*"],t,h(y,Pe))),r.push(...T(this,zt,Tr).call(this,x,t,h(y,Pe)))):u.push(x));for(let b=0,O=h(y,Nr).length;b<O;b++){let v=h(y,Nr)[b],D=h(y,Pe)===es?{}:{...h(y,Pe)};if(v==="*"){let j=h(y,Ve)["*"];j&&(r.push(...T(this,zt,Tr).call(this,j,t,h(y,Pe))),g(j,Pe,D),u.push(j));continue}if(p==="")continue;let[V,J,R]=v,q=h(y,Ve)[V],te=o.slice(a).join("/");if(R instanceof RegExp){let j=R.exec(te);if(j){if(D[J]=j[0],r.push(...T(this,zt,Tr).call(this,q,t,h(y,Pe),D)),Object.keys(h(q,Ve)).length){g(q,Pe,D);let P=j[0].match(/\//)?.length??0;(i[P]||(i[P]=[])).push(q)}continue}}(R===!0||R.test(p))&&(D[J]=p,c?(r.push(...T(this,zt,Tr).call(this,q,t,D,h(y,Pe))),h(q,Ve)["*"]&&r.push(...T(this,zt,Tr).call(this,h(q,Ve)["*"],t,D,h(y,Pe)))):(g(q,Pe,D),u.push(q)))}}s=u.concat(i.shift()??[])}return r.length>1&&r.sort((a,m)=>a.score-m.score),[r.map(({handler:a,params:m})=>[a,m])]}},mr=new WeakMap,Ve=new WeakMap,Nr=new WeakMap,bn=new WeakMap,Pe=new WeakMap,zt=new WeakSet,Tr=function(t,e,r,n){let s=[];for(let o=0,i=h(t,mr).length;o<i;o++){let a=h(t,mr)[o],m=a[e]||a[ie],p={};if(m!==void 0&&(m.params=Object.create(null),s.push(m),r!==es||n&&n!==es))for(let c=0,u=m.possibleKeys.length;c<u;c++){let f=m.possibleKeys[c],l=p[m.score];m.params[f]=n?.[f]&&!l?n[f]:r[f]??n?.[f],p[m.score]=!0}}return s},sp);var Ir,op,Io=(op=class{constructor(){A(this,"name","TrieRouter");k(this,Ir);g(this,Ir,new No)}add(t,e,r){let n=Vs(e);if(n){for(let s=0,o=n.length;s<o;s++)h(this,Ir).insert(t,n[s],r);return}h(this,Ir).insert(t,e,r)}match(t,e){return h(this,Ir).search(t,e)}},Ir=new WeakMap,op);var Vo=class extends Do{constructor(t={}){super(t),this.router=t.router??new To({routers:[new Co,new Io]})}};var ip=t=>{let r={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...t},n=(s=>typeof s=="string"?s==="*"?()=>s:o=>s===o?o:null:typeof s=="function"?s:o=>s.includes(o)?o:null)(r.origin);return async function(o,i){function a(p,c){o.res.headers.set(p,c)}let m=n(o.req.header("origin")||"",o);if(m&&a("Access-Control-Allow-Origin",m),r.origin!=="*"){let p=o.req.header("Vary");p?a("Vary",p):a("Vary","Origin")}if(r.credentials&&a("Access-Control-Allow-Credentials","true"),r.exposeHeaders?.length&&a("Access-Control-Expose-Headers",r.exposeHeaders.join(",")),o.req.method==="OPTIONS"){r.maxAge!=null&&a("Access-Control-Max-Age",r.maxAge.toString()),r.allowMethods?.length&&a("Access-Control-Allow-Methods",r.allowMethods.join(","));let p=r.allowHeaders;if(!p?.length){let c=o.req.header("Access-Control-Request-Headers");c&&(p=c.split(/\s*,\s*/))}return p?.length&&(a("Access-Control-Allow-Headers",p.join(",")),o.res.headers.append("Vary","Access-Control-Request-Headers")),o.res.headers.delete("Content-Length"),o.res.headers.delete("Content-Type"),new Response(null,{headers:o.res.headers,status:204,statusText:"No Content"})}await i()}};var ap=t=>{let e="",r=new Uint8Array(t);for(let n=0,s=r.length;n<s;n++)e+=String.fromCharCode(r[n]);return btoa(e)},mp=t=>{let e=atob(t),r=new Uint8Array(new ArrayBuffer(e.length)),n=e.length/2;for(let s=0,o=e.length-1;s<=n;s++,o--)r[s]=e.charCodeAt(s),r[o]=e.charCodeAt(o);return r};var ju=t=>t.requestContext;var jo=t=>async(e,r)=>{let n=Mu(e),s=n.createRequest(e),o=ju(e),i=await t.fetch(s,{event:e,requestContext:o,lambdaContext:r});return n.createResult(e,i)},Ro=class{createRequest(t){let e=this.getQueryString(t),r=t.requestContext&&"domainName"in t.requestContext?t.requestContext.domainName:t.headers?.host??t.multiValueHeaders?.host?.[0],n=this.getPath(t),s=`https://${r}${n}`,o=e?`${s}?${e}`:s,i=this.getHeaders(t),a=this.getMethod(t),m={headers:i,method:a};return t.body&&(m.body=t.isBase64Encoded?mp(t.body):t.body),new Request(o,m)}async createResult(t,e){let r=e.headers.get("content-type"),n=!!(r&&Gu(r));if(!n){let i=e.headers.get("content-encoding");n=Wu(i)}let o={body:n?ap(await e.arrayBuffer()):await e.text(),statusCode:e.status,isBase64Encoded:n,...t.multiValueHeaders?{multiValueHeaders:{}}:{headers:{}}};return this.setCookies(t,e,o),o.multiValueHeaders?e.headers.forEach((i,a)=>{o.multiValueHeaders[a]=[i]}):e.headers.forEach((i,a)=>{o.headers[a]=i}),o}setCookies(t,e,r){if(e.headers.has("set-cookie")){let n=e.headers.getSetCookie?e.headers.getSetCookie():Array.from(e.headers.entries()).filter(([s])=>s==="set-cookie").map(([,s])=>s);Array.isArray(n)&&(this.setCookiesToResult(r,n),e.headers.delete("set-cookie"))}}},Ru=class extends Ro{getPath(t){return t.rawPath}getMethod(t){return t.requestContext.http.method}getQueryString(t){return t.rawQueryString}getCookies(t,e){Array.isArray(t.cookies)&&e.set("Cookie",t.cookies.join("; "))}setCookiesToResult(t,e){t.cookies=e}getHeaders(t){let e=new Headers;if(this.getCookies(t,e),t.headers)for(let[r,n]of Object.entries(t.headers))n&&e.set(r,n);return e}},qu=new Ru,Lu=class extends Ro{getPath(t){return t.path}getMethod(t){return t.httpMethod}getQueryString(t){return t.multiValueQueryStringParameters?Object.entries(t.multiValueQueryStringParameters||{}).filter(([,e])=>e).map(([e,r])=>`${e}=${r.join(`&${e}=`)}`).join("&"):Object.entries(t.queryStringParameters||{}).filter(([,e])=>e).map(([e,r])=>`${e}=${r}`).join("&")}getCookies(t,e){}getHeaders(t){let e=new Headers;if(this.getCookies(t,e),t.headers)for(let[r,n]of Object.entries(t.headers))n&&e.set(r,n);if(t.multiValueHeaders){for(let[r,n]of Object.entries(t.multiValueHeaders))if(n){let s=e.get(r);n.forEach(o=>(!s||!s.includes(o))&&e.append(r,o))}}return e}setCookiesToResult(t,e){t.multiValueHeaders={"set-cookie":e}}},Bu=new Lu,Fu=class extends Ro{getHeaders(t){let e=new Headers;if(t.multiValueHeaders)for(let[r,n]of Object.entries(t.multiValueHeaders))n&&Array.isArray(n)&&e.set(r,n.join("; "));else for(let[r,n]of Object.entries(t.headers??{}))n&&e.set(r,n);return e}getPath(t){return t.path}getMethod(t){return t.httpMethod}getQueryString(t){return t.multiValueQueryStringParameters?Object.entries(t.multiValueQueryStringParameters||{}).filter(([,e])=>e).map(([e,r])=>`${e}=${r.join(`&${e}=`)}`).join("&"):Object.entries(t.queryStringParameters||{}).filter(([,e])=>e).map(([e,r])=>`${e}=${r}`).join("&")}getCookies(t,e){let r;t.multiValueHeaders?r=t.multiValueHeaders.cookie?.join("; "):r=t.headers?t.headers.cookie:void 0,r&&e.append("Cookie",r)}setCookiesToResult(t,e){t.multiValueHeaders?t.multiValueHeaders["set-cookie"]=e:t.headers["set-cookie"]=e.join(", ")}},Uu=new Fu,Mu=t=>zu(t)?Uu:Ku(t)?qu:Bu,zu=t=>t.requestContext?Object.hasOwn(t.requestContext,"elb"):!1,Ku=t=>Object.hasOwn(t,"rawPath"),Gu=t=>!/^(text\/(plain|html|css|javascript|csv).*|application\/(.*json|.*xml).*|image\/svg\+xml.*)$/.test(t),Wu=t=>t===null?!1:/^(gzip|deflate|compress|br)/.test(t);var ht=new Vo;ht.use("*",ip({origin:"*",allowMethods:["GET","POST","OPTIONS"],allowHeaders:["Content-Type","Authorization"]}));ht.options("*",t=>t.json({message:"CORS enabled"},200));ht.get("/leaderboard/context/:userId",async t=>{try{let e=t.req.param("userId"),r=t.req.query("userTime"),n=await Yu({userId:e,userTime:r});return t.json(n,200)}catch(e){return console.error("Error in leaderboard context:",e),t.json({message:"Internal server error",error:e instanceof Error?e.message:String(e)},500)}});ht.get("/leaderboard",async t=>{try{let e=t.req.query("limit"),r=await Xu({limit:e});return t.json(r,200)}catch(e){return console.error("Error in leaderboard:",e),t.json({message:"Internal server error",error:e instanceof Error?e.message:String(e)},500)}});ht.get("/stats/:userId",async t=>{try{let e=t.req.param("userId"),r=await Zu({userId:e});return console.log("result",r),console.log("result",r),t.json(r,200)}catch(e){return console.error("Error in user stats:",e),t.json({message:"Internal server error",error:e instanceof Error?e.message:String(e)},500)}});ht.get("/bestgames/:userId",async t=>{try{let e=t.req.param("userId"),r=t.req.query("limit")?parseInt(t.req.query("limit")||"5"):5,n=await ec({userId:e,limit:r});return t.json(n,200)}catch(e){return console.error("Error in best games:",e),t.json({message:"Internal server error",error:e instanceof Error?e.message:String(e)},500)}});ht.get("/games",async t=>{try{let e=t.req.query("userId"),r=t.req.query("limit"),n=await Qu({userId:e,limit:r});return t.json(n,200)}catch(e){return console.error("Error in get games:",e),t.json({message:"Internal server error",error:e instanceof Error?e.message:String(e)},500)}});ht.post("/games",async t=>{try{let e=await t.req.json(),r=await Ju(e);return t.json(r,200)}catch(e){return console.error("Error in save game:",e),t.json({message:"Internal server error",error:e instanceof Error?e.message:String(e)},500)}});ht.get("/recent-games",async t=>{try{let e=t.req.query("limit"),r=await _u({limit:e});return t.json(r,200)}catch(e){return console.error("Error in recent games:",e),t.json({message:"Internal server error",error:e instanceof Error?e.message:String(e)},500)}});ht.all("*",t=>t.json({message:"Endpoint not found"},404));var Hu=jo(ht);async function Ju(t){if(console.log("Received game data:",JSON.stringify(t,null,2)),!t)throw console.error("No game data provided"),new Error("Request body is required");let e=new Date().toISOString(),r=t.rawUserId||t.userId;if(console.log("Extracted rawUserId (email):",r),!r)throw console.error("No userId or rawUserId found in payload"),new Error("userId or rawUserId is required");r.includes("@")||console.warn("UserId does not appear to be a valid email:",r);try{let n={userId:`USER#${r}`,timestamp:`DATE#${e}`,bombsExploded:t.bombsExploded||0,cellsRevealed:t.cellsRevealed||0,date:t.date||e,gameRestarts:t.gameRestarts||0,lastUpdated:e,noFlagWin:t.noFlagWin||!1,rawUserId:r,time:t.time||t.successTime||0,timePlayed:t.timePlayed||0,usedFlags:t.usedFlags||0,userName:t.userName||"",userImage:t.userImage||null,status:t.status||"completed",ttl:Math.floor(Date.now()/1e3)+7776e3};await Dm.build(at).item(n).send();let s={...t,rawUserId:r,time:n.time};return console.log("Updating user stats with:",JSON.stringify(s,null,2)),await tc(s),console.log("User stats updated successfully"),{message:"Game saved successfully",game:n}}catch(n){throw console.error("Error saving game:",n),n instanceof Error?console.error("Error details:",{name:n.name,message:n.message,stack:n.stack}):console.error("Unknown error type:",n),new Error("Error saving game")}}async function Qu(t){let{userId:e,limit:r=50}=t||{};if(!e)throw new Error("userId is required");return(await tt.build(pe).query({partition:`USER#${e}`}).options({limit:parseInt(r),reverse:!0}).send()).Items||[]}async function Xu(t){let{limit:e=10}=t||{};return(await tt.build(pe).query({index:"status-time-index",partition:"COMPLETED"}).options({limit:parseInt(e),reverse:!1}).send()).Items||[]}async function Yu(t){let{userId:e,userTime:r}=t||{};if(!e||!r)throw new Error("userId and userTime are required");let n=parseInt(r),s=await tt.build(pe).query({index:"status-time-index",partition:"COMPLETED"}).options({limit:5,reverse:!1,filter:{attr:"time",lt:n}}).send(),o=await tt.build(pe).query({index:"status-time-index",partition:"COMPLETED"}).options({limit:5,reverse:!0,filter:{attr:"time",gt:n}}).send();return{faster:s.Items||[],slower:o.Items||[]}}async function Zu(t){let{userId:e}=t||{};if(console.log("getUserStats called with userId (email):",e),!e)throw console.error("No userId provided to getUserStats"),new Error("User ID is required");e.includes("@")||console.warn("UserId does not appear to be a valid email:",e);try{console.log("Querying user stats for:",`STAT#${e}`);let r=await Ts.build(it).key({userId:`STAT#${e}`,timestamp:"STAT"}).send();console.log("Stats response:",r.Item?"Found":"Not found"),console.log("Querying recent games for:",`USER#${e}`);let n=await tt.build(pe).query({partition:`USER#${e}`}).options({limit:10,reverse:!0}).send();console.log("Recent games found:",n.Items?.length||0),n.Items?.length===0&&console.log("No recent games found for user:",e);let s=n.Items||[];return r.Item?{...r.Item,recentGames:s}:(console.log("No existing stats found, returning defaults"),{userId:`STAT#${e}`,timestamp:"STAT",gamesPlayed:0,gamesWon:0,gamesLost:0,gamesAbandoned:0,fastestWin:void 0,recentGames:s})}catch(r){throw console.error("Error in getUserStats:",r),r instanceof Error?console.error("Error details:",{name:r.name,message:r.message,stack:r.stack}):console.error("Unknown error type:",r),new Error("Error fetching user stats")}}async function _u(t){let{limit:e=10}=t||{};return((await tt.build(wt).options({limit:parseInt(e),filter:{attr:"userId",exists:!0}}).send()).Items||[]).sort((s,o)=>new Date(o.lastUpdated||o.timestamp).getTime()-new Date(s.lastUpdated||s.timestamp).getTime())}async function ec(t){let{userId:e,limit:r=5}=t||{};if(!e)throw new Error("User ID is required");return((await tt.build(pe).query({partition:`USER#${e}`}).options({limit:100,reverse:!0}).send()).Items||[]).filter(i=>i.time&&i.time>0).sort((i,a)=>i.time-a.time).slice(0,parseInt(r))}async function tc(t){let e=`STAT#${t.rawUserId}`,r="STAT";console.log("Updating user stats for email:",t.rawUserId);try{let n=await Ts.build(it).key({userId:e,timestamp:r}).send();console.log("Existing stats found:",n.Item?"Yes":"No");let s=n.Item||{userId:e,timestamp:r,gamesPlayed:0,gamesWon:0,gamesLost:0,gamesAbandoned:0,gamesRestarted:0,noFlagWins:0,fastestWin:void 0,totalBombsExploded:0,totalCellsRevealed:0,totalFlagsPlaced:0,totalGameRestarts:0,totalTimePlayed:0,totalWinTime:0,status:"ACTIVE",time:t.time,ttl:Math.floor(Date.now()/1e3)+365*24*60*60};console.log("Current stats before update:",JSON.stringify(s,null,2)),s.gamesPlayed=(s.gamesPlayed||0)+1,s.totalBombsExploded=(s.totalBombsExploded||0)+(t.bombsExploded||0),s.totalCellsRevealed=(s.totalCellsRevealed||0)+(t.cellsRevealed||0),s.totalGameRestarts=(s.totalGameRestarts||0)+(t.gameRestarts||0),s.totalTimePlayed=(s.totalTimePlayed||0)+(t.timePlayed||0),s.totalFlagsPlaced=(s.totalFlagsPlaced||0)+(t.usedFlags||0),t.bombsExploded>0?s.gamesLost=(s.gamesLost||0)+1:t.time>0&&(s.gamesWon=(s.gamesWon||0)+1,s.totalWinTime=(s.totalWinTime||0)+t.time,t.noFlagWin&&(s.noFlagWins=(s.noFlagWins||0)+1),(!s.fastestWin||t.time<s.fastestWin)&&(s.fastestWin=t.time)),console.log("Updated stats:",JSON.stringify(s,null,2)),await Ts.build(at).item(s).send(),console.log("Stats updated successfully in DynamoDB")}catch(n){throw console.error("Error updating user stats:",n),n instanceof Error?console.error("Error details:",{name:n.name,message:n.message,stack:n.stack}):console.error("Unknown error type:",n),n}}0&&(module.exports={handler});
